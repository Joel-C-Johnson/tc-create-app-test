"use strict";var _interopRequireDefault = require("@babel/runtime/helpers/interopRequireDefault");var _regenerator = _interopRequireDefault(require("@babel/runtime/regenerator"));var _asyncToGenerator2 = _interopRequireDefault(require("@babel/runtime/helpers/asyncToGenerator"));

var _checkBookPackage = require("../demos/book-package-check/checkBookPackage");
var _path = _interopRequireDefault(require("path"));
var _fsExtra = _interopRequireDefault(require("fs-extra")); /* eslint-env jest */

var testFiles = {};

var optionalCheckingOptions = {
  disableLinkedTAArticlesCheckFlag: true,
  disableLinkedTWArticlesCheckFlag: true,
  getFile: function getFile(params) {
    var username = params.username,repository = params.repository,path = params.path;
    // console.log(`book-package-check.test getFile(${username}, ${repository}, ${path})`)
    var filePath = _path.default.join('./src/__tests__/fixtures', username, repository, path);

    if (testFiles.hasOwnProperty(filePath)) {// see if we have a test file to use
      if (testFiles[filePath] !== null) {// if file content not null, then return contents.  Otherwise will throw exception
        return testFiles[filePath];
      }
      // eslint-disable-next-line no-throw-literal
      throw "Simulated error - Could not find ".concat(filePath);
    } else if (_fsExtra.default.existsSync(filePath)) {
      return _fsExtra.default.readFileSync(filePath).toString();
    }
    // eslint-disable-next-line no-throw-literal
    throw "Tests could not find ".concat(filePath);
  },
  getFileListFromZip: function getFileListFromZip(params) {
    var username = params.username,repository = params.repository,optionalPrefix = params.optionalPrefix;
    // console.log(`book-package-check.test getFileListFromZip(${username}, ${repository}, ${optionalPrefix})`)
    var filePath = _path.default.join('./src/__tests__/fixtures', username, repository);
    var files = getAllFiles(filePath);
    if (optionalPrefix) {
      files = files.filter(function (file) {return file.toLowerCase().startsWith(optionalPrefix);}); // filter just for current book
    }
    return files;
  } };


describe('checkBookPackage() - ', function () {
  beforeEach(function () {
    testFiles = {}; // reset test files
  });

  it('TIT should fail on unsupported language', /*#__PURE__*/(0, _asyncToGenerator2.default)( /*#__PURE__*/_regenerator.default.mark(function _callee() {var username, languageCode, bookID, rawResults, filteredResults;return _regenerator.default.wrap(function _callee$(_context) {while (1) {switch (_context.prev = _context.next) {case 0:
            username = 'unfoldingWord';
            languageCode = 'zzz';
            bookID = 'TIT';_context.next = 5;return (
              (0, _checkBookPackage.checkBookPackage)(username, languageCode, bookID, function () {}, optionalCheckingOptions));case 5:rawResults = _context.sent;
            console.log("TIT unsupported language BP test took ".concat(rawResults.elapsedSeconds, " seconds"));
            expect(rawResults.noticeList.length).toBeGreaterThan(0);
            filteredResults = {
              successList: rawResults.successList,
              noticeList: rawResults.noticeList,
              checkedFilenames: rawResults.checkedFilenames,
              checkedRepoNames: rawResults.checkedRepoNames };

            expect(filteredResults).toMatchSnapshot();case 10:case "end":return _context.stop();}}}, _callee);})),
  6000); // Allow 6 seconds

  it('TIT should fail on missing repo', /*#__PURE__*/(0, _asyncToGenerator2.default)( /*#__PURE__*/_regenerator.default.mark(function _callee2() {var username, languageCode, bookID, rawResults, filteredResults;return _regenerator.default.wrap(function _callee2$(_context2) {while (1) {switch (_context2.prev = _context2.next) {case 0:
            username = 'unfoldingWord';
            languageCode = 'en';
            bookID = 'TIT';
            testFiles = { // override these files
              'src/__tests__/fixtures/unfoldingWord/en_ult/57-TIT.usfm': null };_context2.next = 6;return (


              (0, _checkBookPackage.checkBookPackage)(username, languageCode, bookID, function () {}, optionalCheckingOptions));case 6:rawResults = _context2.sent;
            console.log("TIT missing repo BP test took ".concat(rawResults.elapsedSeconds, " seconds"));
            expect(rawResults.noticeList.length).toBeGreaterThan(0);
            filteredResults = {
              successList: rawResults.successList,
              noticeList: rawResults.noticeList,
              checkedFilenames: rawResults.checkedFilenames,
              checkedRepoNames: rawResults.checkedRepoNames };

            expect(filteredResults).toMatchSnapshot();case 11:case "end":return _context2.stop();}}}, _callee2);})),
  12000); // Allow 12 seconds

  it('TIT should pass', /*#__PURE__*/(0, _asyncToGenerator2.default)( /*#__PURE__*/_regenerator.default.mark(function _callee3() {var username, languageCode, bookID, rawResults, filteredResults;return _regenerator.default.wrap(function _callee3$(_context3) {while (1) {switch (_context3.prev = _context3.next) {case 0:
            username = 'unfoldingWord';
            languageCode = 'en';
            bookID = 'TIT';_context3.next = 5;return (
              (0, _checkBookPackage.checkBookPackage)(username, languageCode, bookID, function () {}, optionalCheckingOptions));case 5:rawResults = _context3.sent;
            console.log("TIT BP test took ".concat(rawResults.elapsedSeconds, " seconds"));
            expect(rawResults.noticeList.length).toBeGreaterThanOrEqual(0);
            filteredResults = {
              successList: rawResults.successList,
              noticeList: rawResults.noticeList,
              checkedFilenames: rawResults.checkedFilenames,
              checkedRepoNames: rawResults.checkedRepoNames };

            expect(filteredResults).toMatchSnapshot();case 10:case "end":return _context3.stop();}}}, _callee3);})),
  15000); // Allow 15 seconds

  it('RUT should pass', /*#__PURE__*/(0, _asyncToGenerator2.default)( /*#__PURE__*/_regenerator.default.mark(function _callee4() {var username, languageCode, bookID, rawResults, filteredResults;return _regenerator.default.wrap(function _callee4$(_context4) {while (1) {switch (_context4.prev = _context4.next) {case 0:
            username = 'unfoldingWord';
            languageCode = 'en';
            bookID = 'RUT';_context4.next = 5;return (
              (0, _checkBookPackage.checkBookPackage)(username, languageCode, bookID, function () {}, optionalCheckingOptions));case 5:rawResults = _context4.sent;
            console.log("RUT BP test took ".concat(rawResults.elapsedSeconds, " seconds"));
            expect(rawResults.noticeList.length).toBeGreaterThanOrEqual(4);
            filteredResults = {
              successList: rawResults.successList,
              noticeList: rawResults.noticeList,
              checkedFilenames: rawResults.checkedFilenames,
              checkedRepoNames: rawResults.checkedRepoNames };

            expect(filteredResults).toMatchSnapshot();case 10:case "end":return _context4.stop();}}}, _callee4);})),
  20000); // Allow 20 seconds

});

//
// Helper functions
//

/**
 * recursively get a file list
 * @param {string} dirPath
 * @param {string} subPath
 * @param {Array} arrayOfFiles
 * @return {Array}
 */
var getAllFiles = function getAllFiles(dirPath, subPath, arrayOfFiles) {
  // console.log(`getAllFiles(${dirPath}, ${subPath}, ${arrayOfFiles}`);
  arrayOfFiles = arrayOfFiles || [];
  subPath = subPath || '.';
  var fullPath = _path.default.join(dirPath, subPath);
  if (_fsExtra.default.existsSync(fullPath)) {
    var files = _fsExtra.default.readdirSync(fullPath);

    files.forEach(function (file) {
      var fullSubPath_ = _path.default.join(fullPath, file);
      if (_fsExtra.default.statSync(fullSubPath_).isDirectory()) {
        arrayOfFiles = getAllFiles(dirPath, _path.default.join(subPath, file), arrayOfFiles);
      } else {
        arrayOfFiles.push(_path.default.join(subPath, file));
      }
    });
  }
  return arrayOfFiles;
};
//# sourceMappingURL=data:application/json;charset=utf-8;base64,eyJ2ZXJzaW9uIjozLCJzb3VyY2VzIjpbIi4uLy4uL3NyYy9fX3Rlc3RzX18vYm9vay1wYWNrYWdlLWNoZWNrLnRlc3QuanMiXSwibmFtZXMiOlsidGVzdEZpbGVzIiwib3B0aW9uYWxDaGVja2luZ09wdGlvbnMiLCJkaXNhYmxlTGlua2VkVEFBcnRpY2xlc0NoZWNrRmxhZyIsImRpc2FibGVMaW5rZWRUV0FydGljbGVzQ2hlY2tGbGFnIiwiZ2V0RmlsZSIsInBhcmFtcyIsInVzZXJuYW1lIiwicmVwb3NpdG9yeSIsInBhdGgiLCJmaWxlUGF0aCIsIlBhdGgiLCJqb2luIiwiaGFzT3duUHJvcGVydHkiLCJmcyIsImV4aXN0c1N5bmMiLCJyZWFkRmlsZVN5bmMiLCJ0b1N0cmluZyIsImdldEZpbGVMaXN0RnJvbVppcCIsIm9wdGlvbmFsUHJlZml4IiwiZmlsZXMiLCJnZXRBbGxGaWxlcyIsImZpbHRlciIsImZpbGUiLCJ0b0xvd2VyQ2FzZSIsInN0YXJ0c1dpdGgiLCJkZXNjcmliZSIsImJlZm9yZUVhY2giLCJpdCIsImxhbmd1YWdlQ29kZSIsImJvb2tJRCIsInJhd1Jlc3VsdHMiLCJjb25zb2xlIiwibG9nIiwiZWxhcHNlZFNlY29uZHMiLCJleHBlY3QiLCJub3RpY2VMaXN0IiwibGVuZ3RoIiwidG9CZUdyZWF0ZXJUaGFuIiwiZmlsdGVyZWRSZXN1bHRzIiwic3VjY2Vzc0xpc3QiLCJjaGVja2VkRmlsZW5hbWVzIiwiY2hlY2tlZFJlcG9OYW1lcyIsInRvTWF0Y2hTbmFwc2hvdCIsInRvQmVHcmVhdGVyVGhhbk9yRXF1YWwiLCJkaXJQYXRoIiwic3ViUGF0aCIsImFycmF5T2ZGaWxlcyIsImZ1bGxQYXRoIiwicmVhZGRpclN5bmMiLCJmb3JFYWNoIiwiZnVsbFN1YlBhdGhfIiwic3RhdFN5bmMiLCJpc0RpcmVjdG9yeSIsInB1c2giXSwibWFwcGluZ3MiOiI7O0FBRUE7QUFDQTtBQUNBLDJELENBSkE7O0FBTUEsSUFBSUEsU0FBUyxHQUFHLEVBQWhCOztBQUVBLElBQU1DLHVCQUF1QixHQUFHO0FBQzlCQyxFQUFBQSxnQ0FBZ0MsRUFBRSxJQURKO0FBRTlCQyxFQUFBQSxnQ0FBZ0MsRUFBRSxJQUZKO0FBRzlCQyxFQUFBQSxPQUFPLEVBQUUsaUJBQUFDLE1BQU0sRUFBSTtBQUNqQixRQUFRQyxRQUFSLEdBQXVDRCxNQUF2QyxDQUFRQyxRQUFSLENBQWtCQyxVQUFsQixHQUF1Q0YsTUFBdkMsQ0FBa0JFLFVBQWxCLENBQThCQyxJQUE5QixHQUF1Q0gsTUFBdkMsQ0FBOEJHLElBQTlCO0FBQ0E7QUFDQSxRQUFNQyxRQUFRLEdBQUdDLGNBQUtDLElBQUwsQ0FBVSwwQkFBVixFQUFzQ0wsUUFBdEMsRUFBZ0RDLFVBQWhELEVBQTREQyxJQUE1RCxDQUFqQjs7QUFFQSxRQUFJUixTQUFTLENBQUNZLGNBQVYsQ0FBeUJILFFBQXpCLENBQUosRUFBd0MsQ0FBRTtBQUN4QyxVQUFJVCxTQUFTLENBQUNTLFFBQUQsQ0FBVCxLQUF3QixJQUE1QixFQUFrQyxDQUFHO0FBQ25DLGVBQU9ULFNBQVMsQ0FBQ1MsUUFBRCxDQUFoQjtBQUNEO0FBQ0Q7QUFDQSx1REFBMENBLFFBQTFDO0FBQ0QsS0FORCxNQU1PLElBQUlJLGlCQUFHQyxVQUFILENBQWNMLFFBQWQsQ0FBSixFQUE2QjtBQUNsQyxhQUFPSSxpQkFBR0UsWUFBSCxDQUFnQk4sUUFBaEIsRUFBMEJPLFFBQTFCLEVBQVA7QUFDRDtBQUNEO0FBQ0EseUNBQThCUCxRQUE5QjtBQUNELEdBbkI2QjtBQW9COUJRLEVBQUFBLGtCQUFrQixFQUFFLDRCQUFBWixNQUFNLEVBQUk7QUFDNUIsUUFBUUMsUUFBUixHQUFpREQsTUFBakQsQ0FBUUMsUUFBUixDQUFrQkMsVUFBbEIsR0FBaURGLE1BQWpELENBQWtCRSxVQUFsQixDQUE4QlcsY0FBOUIsR0FBaURiLE1BQWpELENBQThCYSxjQUE5QjtBQUNBO0FBQ0EsUUFBTVQsUUFBUSxHQUFHQyxjQUFLQyxJQUFMLENBQVUsMEJBQVYsRUFBc0NMLFFBQXRDLEVBQWdEQyxVQUFoRCxDQUFqQjtBQUNBLFFBQUlZLEtBQUssR0FBR0MsV0FBVyxDQUFDWCxRQUFELENBQXZCO0FBQ0EsUUFBSVMsY0FBSixFQUFvQjtBQUNsQkMsTUFBQUEsS0FBSyxHQUFHQSxLQUFLLENBQUNFLE1BQU4sQ0FBYSxVQUFBQyxJQUFJLFVBQUlBLElBQUksQ0FBQ0MsV0FBTCxHQUFtQkMsVUFBbkIsQ0FBOEJOLGNBQTlCLENBQUosRUFBakIsQ0FBUixDQURrQixDQUMyRDtBQUM5RTtBQUNELFdBQU9DLEtBQVA7QUFDRCxHQTdCNkIsRUFBaEM7OztBQWdDQU0sUUFBUSxDQUFDLHVCQUFELEVBQTBCLFlBQU07QUFDdENDLEVBQUFBLFVBQVUsQ0FBQyxZQUFNO0FBQ2YxQixJQUFBQSxTQUFTLEdBQUcsRUFBWixDQURlLENBQ0M7QUFDakIsR0FGUyxDQUFWOztBQUlBMkIsRUFBQUEsRUFBRSxDQUFDLHlDQUFELHVGQUE0QztBQUN0Q3JCLFlBQUFBLFFBRHNDLEdBQzNCLGVBRDJCO0FBRXRDc0IsWUFBQUEsWUFGc0MsR0FFdkIsS0FGdUI7QUFHdENDLFlBQUFBLE1BSHNDLEdBRzdCLEtBSDZCO0FBSW5CLHNEQUFpQnZCLFFBQWpCLEVBQTJCc0IsWUFBM0IsRUFBeUNDLE1BQXpDLEVBQWlELFlBQU0sQ0FBRSxDQUF6RCxFQUEyRDVCLHVCQUEzRCxDQUptQixTQUl0QzZCLFVBSnNDO0FBSzVDQyxZQUFBQSxPQUFPLENBQUNDLEdBQVIsaURBQXFERixVQUFVLENBQUNHLGNBQWhFO0FBQ0FDLFlBQUFBLE1BQU0sQ0FBQ0osVUFBVSxDQUFDSyxVQUFYLENBQXNCQyxNQUF2QixDQUFOLENBQXFDQyxlQUFyQyxDQUFxRCxDQUFyRDtBQUNNQyxZQUFBQSxlQVBzQyxHQU9wQjtBQUN0QkMsY0FBQUEsV0FBVyxFQUFFVCxVQUFVLENBQUNTLFdBREY7QUFFdEJKLGNBQUFBLFVBQVUsRUFBRUwsVUFBVSxDQUFDSyxVQUZEO0FBR3RCSyxjQUFBQSxnQkFBZ0IsRUFBRVYsVUFBVSxDQUFDVSxnQkFIUDtBQUl0QkMsY0FBQUEsZ0JBQWdCLEVBQUVYLFVBQVUsQ0FBQ1csZ0JBSlAsRUFQb0I7O0FBYTVDUCxZQUFBQSxNQUFNLENBQUNJLGVBQUQsQ0FBTixDQUF3QkksZUFBeEIsR0FiNEMseURBQTVDO0FBY0MsTUFkRCxDQUFGLENBTHNDLENBbUI1Qjs7QUFFVmYsRUFBQUEsRUFBRSxDQUFDLGlDQUFELHVGQUFvQztBQUM5QnJCLFlBQUFBLFFBRDhCLEdBQ25CLGVBRG1CO0FBRTlCc0IsWUFBQUEsWUFGOEIsR0FFZixJQUZlO0FBRzlCQyxZQUFBQSxNQUg4QixHQUdyQixLQUhxQjtBQUlwQzdCLFlBQUFBLFNBQVMsR0FBRyxFQUFFO0FBQ1oseUVBQTJELElBRGpELEVBQVosQ0FKb0M7OztBQVFYLHNEQUFpQk0sUUFBakIsRUFBMkJzQixZQUEzQixFQUF5Q0MsTUFBekMsRUFBaUQsWUFBTSxDQUFFLENBQXpELEVBQTJENUIsdUJBQTNELENBUlcsU0FROUI2QixVQVI4QjtBQVNwQ0MsWUFBQUEsT0FBTyxDQUFDQyxHQUFSLHlDQUE2Q0YsVUFBVSxDQUFDRyxjQUF4RDtBQUNBQyxZQUFBQSxNQUFNLENBQUNKLFVBQVUsQ0FBQ0ssVUFBWCxDQUFzQkMsTUFBdkIsQ0FBTixDQUFxQ0MsZUFBckMsQ0FBcUQsQ0FBckQ7QUFDTUMsWUFBQUEsZUFYOEIsR0FXWjtBQUN0QkMsY0FBQUEsV0FBVyxFQUFFVCxVQUFVLENBQUNTLFdBREY7QUFFdEJKLGNBQUFBLFVBQVUsRUFBRUwsVUFBVSxDQUFDSyxVQUZEO0FBR3RCSyxjQUFBQSxnQkFBZ0IsRUFBRVYsVUFBVSxDQUFDVSxnQkFIUDtBQUl0QkMsY0FBQUEsZ0JBQWdCLEVBQUVYLFVBQVUsQ0FBQ1csZ0JBSlAsRUFYWTs7QUFpQnBDUCxZQUFBQSxNQUFNLENBQUNJLGVBQUQsQ0FBTixDQUF3QkksZUFBeEIsR0FqQm9DLDJEQUFwQztBQWtCQyxPQWxCRCxDQUFGLENBckJzQyxDQXVDM0I7O0FBRVhmLEVBQUFBLEVBQUUsQ0FBQyxpQkFBRCx1RkFBb0I7QUFDZHJCLFlBQUFBLFFBRGMsR0FDSCxlQURHO0FBRWRzQixZQUFBQSxZQUZjLEdBRUMsSUFGRDtBQUdkQyxZQUFBQSxNQUhjLEdBR0wsS0FISztBQUlLLHNEQUFpQnZCLFFBQWpCLEVBQTJCc0IsWUFBM0IsRUFBeUNDLE1BQXpDLEVBQWlELFlBQU0sQ0FBRSxDQUF6RCxFQUEyRDVCLHVCQUEzRCxDQUpMLFNBSWQ2QixVQUpjO0FBS3BCQyxZQUFBQSxPQUFPLENBQUNDLEdBQVIsNEJBQWdDRixVQUFVLENBQUNHLGNBQTNDO0FBQ0FDLFlBQUFBLE1BQU0sQ0FBQ0osVUFBVSxDQUFDSyxVQUFYLENBQXNCQyxNQUF2QixDQUFOLENBQXFDTyxzQkFBckMsQ0FBNEQsQ0FBNUQ7QUFDTUwsWUFBQUEsZUFQYyxHQU9JO0FBQ3RCQyxjQUFBQSxXQUFXLEVBQUVULFVBQVUsQ0FBQ1MsV0FERjtBQUV0QkosY0FBQUEsVUFBVSxFQUFFTCxVQUFVLENBQUNLLFVBRkQ7QUFHdEJLLGNBQUFBLGdCQUFnQixFQUFFVixVQUFVLENBQUNVLGdCQUhQO0FBSXRCQyxjQUFBQSxnQkFBZ0IsRUFBRVgsVUFBVSxDQUFDVyxnQkFKUCxFQVBKOztBQWFwQlAsWUFBQUEsTUFBTSxDQUFDSSxlQUFELENBQU4sQ0FBd0JJLGVBQXhCLEdBYm9CLDJEQUFwQjtBQWNDLE9BZEQsQ0FBRixDQXpDc0MsQ0F1RDNCOztBQUVYZixFQUFBQSxFQUFFLENBQUMsaUJBQUQsdUZBQW9CO0FBQ2RyQixZQUFBQSxRQURjLEdBQ0gsZUFERztBQUVkc0IsWUFBQUEsWUFGYyxHQUVDLElBRkQ7QUFHZEMsWUFBQUEsTUFIYyxHQUdMLEtBSEs7QUFJSyxzREFBaUJ2QixRQUFqQixFQUEyQnNCLFlBQTNCLEVBQXlDQyxNQUF6QyxFQUFpRCxZQUFNLENBQUUsQ0FBekQsRUFBMkQ1Qix1QkFBM0QsQ0FKTCxTQUlkNkIsVUFKYztBQUtwQkMsWUFBQUEsT0FBTyxDQUFDQyxHQUFSLDRCQUFnQ0YsVUFBVSxDQUFDRyxjQUEzQztBQUNBQyxZQUFBQSxNQUFNLENBQUNKLFVBQVUsQ0FBQ0ssVUFBWCxDQUFzQkMsTUFBdkIsQ0FBTixDQUFxQ08sc0JBQXJDLENBQTRELENBQTVEO0FBQ01MLFlBQUFBLGVBUGMsR0FPSTtBQUN0QkMsY0FBQUEsV0FBVyxFQUFFVCxVQUFVLENBQUNTLFdBREY7QUFFdEJKLGNBQUFBLFVBQVUsRUFBRUwsVUFBVSxDQUFDSyxVQUZEO0FBR3RCSyxjQUFBQSxnQkFBZ0IsRUFBRVYsVUFBVSxDQUFDVSxnQkFIUDtBQUl0QkMsY0FBQUEsZ0JBQWdCLEVBQUVYLFVBQVUsQ0FBQ1csZ0JBSlAsRUFQSjs7QUFhcEJQLFlBQUFBLE1BQU0sQ0FBQ0ksZUFBRCxDQUFOLENBQXdCSSxlQUF4QixHQWJvQiwyREFBcEI7QUFjQyxPQWRELENBQUYsQ0F6RHNDLENBdUUzQjs7QUFFWixDQXpFTyxDQUFSOztBQTJFQTtBQUNBO0FBQ0E7O0FBRUE7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQSxJQUFNdEIsV0FBVyxHQUFHLFNBQWRBLFdBQWMsQ0FBU3dCLE9BQVQsRUFBa0JDLE9BQWxCLEVBQTJCQyxZQUEzQixFQUF5QztBQUMzRDtBQUNBQSxFQUFBQSxZQUFZLEdBQUdBLFlBQVksSUFBSSxFQUEvQjtBQUNBRCxFQUFBQSxPQUFPLEdBQUdBLE9BQU8sSUFBSSxHQUFyQjtBQUNBLE1BQU1FLFFBQVEsR0FBR3JDLGNBQUtDLElBQUwsQ0FBVWlDLE9BQVYsRUFBbUJDLE9BQW5CLENBQWpCO0FBQ0EsTUFBSWhDLGlCQUFHQyxVQUFILENBQWNpQyxRQUFkLENBQUosRUFBNkI7QUFDM0IsUUFBTTVCLEtBQUssR0FBR04saUJBQUdtQyxXQUFILENBQWVELFFBQWYsQ0FBZDs7QUFFQTVCLElBQUFBLEtBQUssQ0FBQzhCLE9BQU4sQ0FBYyxVQUFVM0IsSUFBVixFQUFnQjtBQUM1QixVQUFNNEIsWUFBWSxHQUFHeEMsY0FBS0MsSUFBTCxDQUFVb0MsUUFBVixFQUFvQnpCLElBQXBCLENBQXJCO0FBQ0EsVUFBSVQsaUJBQUdzQyxRQUFILENBQVlELFlBQVosRUFBMEJFLFdBQTFCLEVBQUosRUFBNkM7QUFDM0NOLFFBQUFBLFlBQVksR0FBRzFCLFdBQVcsQ0FBQ3dCLE9BQUQsRUFBVWxDLGNBQUtDLElBQUwsQ0FBVWtDLE9BQVYsRUFBbUJ2QixJQUFuQixDQUFWLEVBQW9Dd0IsWUFBcEMsQ0FBMUI7QUFDRCxPQUZELE1BRU87QUFDTEEsUUFBQUEsWUFBWSxDQUFDTyxJQUFiLENBQWtCM0MsY0FBS0MsSUFBTCxDQUFVa0MsT0FBVixFQUFtQnZCLElBQW5CLENBQWxCO0FBQ0Q7QUFDRixLQVBEO0FBUUQ7QUFDRCxTQUFPd0IsWUFBUDtBQUNELENBbEJEIiwic291cmNlc0NvbnRlbnQiOlsiLyogZXNsaW50LWVudiBqZXN0ICovXG5cbmltcG9ydCB7IGNoZWNrQm9va1BhY2thZ2UgfSBmcm9tICcuLi9kZW1vcy9ib29rLXBhY2thZ2UtY2hlY2svY2hlY2tCb29rUGFja2FnZSc7XG5pbXBvcnQgUGF0aCBmcm9tIFwicGF0aFwiO1xuaW1wb3J0IGZzIGZyb20gJ2ZzLWV4dHJhJztcblxubGV0IHRlc3RGaWxlcyA9IHt9O1xuXG5jb25zdCBvcHRpb25hbENoZWNraW5nT3B0aW9ucyA9IHtcbiAgZGlzYWJsZUxpbmtlZFRBQXJ0aWNsZXNDaGVja0ZsYWc6IHRydWUsXG4gIGRpc2FibGVMaW5rZWRUV0FydGljbGVzQ2hlY2tGbGFnOiB0cnVlLFxuICBnZXRGaWxlOiBwYXJhbXMgPT4ge1xuICAgIGNvbnN0IHsgdXNlcm5hbWUsIHJlcG9zaXRvcnksIHBhdGggfSA9IHBhcmFtcztcbiAgICAvLyBjb25zb2xlLmxvZyhgYm9vay1wYWNrYWdlLWNoZWNrLnRlc3QgZ2V0RmlsZSgke3VzZXJuYW1lfSwgJHtyZXBvc2l0b3J5fSwgJHtwYXRofSlgKVxuICAgIGNvbnN0IGZpbGVQYXRoID0gUGF0aC5qb2luKCcuL3NyYy9fX3Rlc3RzX18vZml4dHVyZXMnLCB1c2VybmFtZSwgcmVwb3NpdG9yeSwgcGF0aCk7XG5cbiAgICBpZiAodGVzdEZpbGVzLmhhc093blByb3BlcnR5KGZpbGVQYXRoKSkgeyAvLyBzZWUgaWYgd2UgaGF2ZSBhIHRlc3QgZmlsZSB0byB1c2VcbiAgICAgIGlmICh0ZXN0RmlsZXNbZmlsZVBhdGhdICE9PSBudWxsKSB7ICAvLyBpZiBmaWxlIGNvbnRlbnQgbm90IG51bGwsIHRoZW4gcmV0dXJuIGNvbnRlbnRzLiAgT3RoZXJ3aXNlIHdpbGwgdGhyb3cgZXhjZXB0aW9uXG4gICAgICAgIHJldHVybiB0ZXN0RmlsZXNbZmlsZVBhdGhdO1xuICAgICAgfVxuICAgICAgLy8gZXNsaW50LWRpc2FibGUtbmV4dC1saW5lIG5vLXRocm93LWxpdGVyYWxcbiAgICAgIHRocm93IGBTaW11bGF0ZWQgZXJyb3IgLSBDb3VsZCBub3QgZmluZCAke2ZpbGVQYXRofWA7XG4gICAgfSBlbHNlIGlmIChmcy5leGlzdHNTeW5jKGZpbGVQYXRoKSkge1xuICAgICAgcmV0dXJuIGZzLnJlYWRGaWxlU3luYyhmaWxlUGF0aCkudG9TdHJpbmcoKTtcbiAgICB9XG4gICAgLy8gZXNsaW50LWRpc2FibGUtbmV4dC1saW5lIG5vLXRocm93LWxpdGVyYWxcbiAgICB0aHJvdyBgVGVzdHMgY291bGQgbm90IGZpbmQgJHtmaWxlUGF0aH1gO1xuICB9LFxuICBnZXRGaWxlTGlzdEZyb21aaXA6IHBhcmFtcyA9PiB7XG4gICAgY29uc3QgeyB1c2VybmFtZSwgcmVwb3NpdG9yeSwgb3B0aW9uYWxQcmVmaXggfSA9IHBhcmFtcztcbiAgICAvLyBjb25zb2xlLmxvZyhgYm9vay1wYWNrYWdlLWNoZWNrLnRlc3QgZ2V0RmlsZUxpc3RGcm9tWmlwKCR7dXNlcm5hbWV9LCAke3JlcG9zaXRvcnl9LCAke29wdGlvbmFsUHJlZml4fSlgKVxuICAgIGNvbnN0IGZpbGVQYXRoID0gUGF0aC5qb2luKCcuL3NyYy9fX3Rlc3RzX18vZml4dHVyZXMnLCB1c2VybmFtZSwgcmVwb3NpdG9yeSk7XG4gICAgbGV0IGZpbGVzID0gZ2V0QWxsRmlsZXMoZmlsZVBhdGgpO1xuICAgIGlmIChvcHRpb25hbFByZWZpeCkge1xuICAgICAgZmlsZXMgPSBmaWxlcy5maWx0ZXIoZmlsZSA9PiBmaWxlLnRvTG93ZXJDYXNlKCkuc3RhcnRzV2l0aChvcHRpb25hbFByZWZpeCkpOyAvLyBmaWx0ZXIganVzdCBmb3IgY3VycmVudCBib29rXG4gICAgfVxuICAgIHJldHVybiBmaWxlcztcbiAgfVxufVxuXG5kZXNjcmliZSgnY2hlY2tCb29rUGFja2FnZSgpIC0gJywgKCkgPT4ge1xuICBiZWZvcmVFYWNoKCgpID0+IHtcbiAgICB0ZXN0RmlsZXMgPSB7fTsgLy8gcmVzZXQgdGVzdCBmaWxlc1xuICB9KTtcblxuICBpdCgnVElUIHNob3VsZCBmYWlsIG9uIHVuc3VwcG9ydGVkIGxhbmd1YWdlJywgYXN5bmMoKSA9PiB7XG4gICAgY29uc3QgdXNlcm5hbWUgPSAndW5mb2xkaW5nV29yZCc7XG4gICAgY29uc3QgbGFuZ3VhZ2VDb2RlID0gJ3p6eic7XG4gICAgY29uc3QgYm9va0lEID0gJ1RJVCc7XG4gICAgY29uc3QgcmF3UmVzdWx0cyA9IGF3YWl0IGNoZWNrQm9va1BhY2thZ2UodXNlcm5hbWUsIGxhbmd1YWdlQ29kZSwgYm9va0lELCAoKSA9PiB7fSwgb3B0aW9uYWxDaGVja2luZ09wdGlvbnMpO1xuICAgIGNvbnNvbGUubG9nKGBUSVQgdW5zdXBwb3J0ZWQgbGFuZ3VhZ2UgQlAgdGVzdCB0b29rICR7cmF3UmVzdWx0cy5lbGFwc2VkU2Vjb25kc30gc2Vjb25kc2ApO1xuICAgIGV4cGVjdChyYXdSZXN1bHRzLm5vdGljZUxpc3QubGVuZ3RoKS50b0JlR3JlYXRlclRoYW4oMCk7XG4gICAgY29uc3QgZmlsdGVyZWRSZXN1bHRzID0ge1xuICAgICAgc3VjY2Vzc0xpc3Q6IHJhd1Jlc3VsdHMuc3VjY2Vzc0xpc3QsXG4gICAgICBub3RpY2VMaXN0OiByYXdSZXN1bHRzLm5vdGljZUxpc3QsXG4gICAgICBjaGVja2VkRmlsZW5hbWVzOiByYXdSZXN1bHRzLmNoZWNrZWRGaWxlbmFtZXMsXG4gICAgICBjaGVja2VkUmVwb05hbWVzOiByYXdSZXN1bHRzLmNoZWNrZWRSZXBvTmFtZXMsXG4gICAgfTtcbiAgICBleHBlY3QoZmlsdGVyZWRSZXN1bHRzKS50b01hdGNoU25hcHNob3QoKTtcbiAgfSwgNjAwMCk7IC8vIEFsbG93IDYgc2Vjb25kc1xuXG4gIGl0KCdUSVQgc2hvdWxkIGZhaWwgb24gbWlzc2luZyByZXBvJywgYXN5bmMoKSA9PiB7XG4gICAgY29uc3QgdXNlcm5hbWUgPSAndW5mb2xkaW5nV29yZCc7XG4gICAgY29uc3QgbGFuZ3VhZ2VDb2RlID0gJ2VuJztcbiAgICBjb25zdCBib29rSUQgPSAnVElUJztcbiAgICB0ZXN0RmlsZXMgPSB7IC8vIG92ZXJyaWRlIHRoZXNlIGZpbGVzXG4gICAgICAnc3JjL19fdGVzdHNfXy9maXh0dXJlcy91bmZvbGRpbmdXb3JkL2VuX3VsdC81Ny1USVQudXNmbSc6IG51bGwsXG4gICAgfTtcblxuICAgIGNvbnN0IHJhd1Jlc3VsdHMgPSBhd2FpdCBjaGVja0Jvb2tQYWNrYWdlKHVzZXJuYW1lLCBsYW5ndWFnZUNvZGUsIGJvb2tJRCwgKCkgPT4ge30sIG9wdGlvbmFsQ2hlY2tpbmdPcHRpb25zKTtcbiAgICBjb25zb2xlLmxvZyhgVElUIG1pc3NpbmcgcmVwbyBCUCB0ZXN0IHRvb2sgJHtyYXdSZXN1bHRzLmVsYXBzZWRTZWNvbmRzfSBzZWNvbmRzYCk7XG4gICAgZXhwZWN0KHJhd1Jlc3VsdHMubm90aWNlTGlzdC5sZW5ndGgpLnRvQmVHcmVhdGVyVGhhbigwKTtcbiAgICBjb25zdCBmaWx0ZXJlZFJlc3VsdHMgPSB7XG4gICAgICBzdWNjZXNzTGlzdDogcmF3UmVzdWx0cy5zdWNjZXNzTGlzdCxcbiAgICAgIG5vdGljZUxpc3Q6IHJhd1Jlc3VsdHMubm90aWNlTGlzdCxcbiAgICAgIGNoZWNrZWRGaWxlbmFtZXM6IHJhd1Jlc3VsdHMuY2hlY2tlZEZpbGVuYW1lcyxcbiAgICAgIGNoZWNrZWRSZXBvTmFtZXM6IHJhd1Jlc3VsdHMuY2hlY2tlZFJlcG9OYW1lcyxcbiAgICB9O1xuICAgIGV4cGVjdChmaWx0ZXJlZFJlc3VsdHMpLnRvTWF0Y2hTbmFwc2hvdCgpO1xuICB9LCAxMjAwMCk7IC8vIEFsbG93IDEyIHNlY29uZHNcblxuICBpdCgnVElUIHNob3VsZCBwYXNzJywgYXN5bmMoKSA9PiB7XG4gICAgY29uc3QgdXNlcm5hbWUgPSAndW5mb2xkaW5nV29yZCc7XG4gICAgY29uc3QgbGFuZ3VhZ2VDb2RlID0gJ2VuJztcbiAgICBjb25zdCBib29rSUQgPSAnVElUJztcbiAgICBjb25zdCByYXdSZXN1bHRzID0gYXdhaXQgY2hlY2tCb29rUGFja2FnZSh1c2VybmFtZSwgbGFuZ3VhZ2VDb2RlLCBib29rSUQsICgpID0+IHt9LCBvcHRpb25hbENoZWNraW5nT3B0aW9ucyk7XG4gICAgY29uc29sZS5sb2coYFRJVCBCUCB0ZXN0IHRvb2sgJHtyYXdSZXN1bHRzLmVsYXBzZWRTZWNvbmRzfSBzZWNvbmRzYCk7XG4gICAgZXhwZWN0KHJhd1Jlc3VsdHMubm90aWNlTGlzdC5sZW5ndGgpLnRvQmVHcmVhdGVyVGhhbk9yRXF1YWwoMCk7XG4gICAgY29uc3QgZmlsdGVyZWRSZXN1bHRzID0ge1xuICAgICAgc3VjY2Vzc0xpc3Q6IHJhd1Jlc3VsdHMuc3VjY2Vzc0xpc3QsXG4gICAgICBub3RpY2VMaXN0OiByYXdSZXN1bHRzLm5vdGljZUxpc3QsXG4gICAgICBjaGVja2VkRmlsZW5hbWVzOiByYXdSZXN1bHRzLmNoZWNrZWRGaWxlbmFtZXMsXG4gICAgICBjaGVja2VkUmVwb05hbWVzOiByYXdSZXN1bHRzLmNoZWNrZWRSZXBvTmFtZXMsXG4gICAgfTtcbiAgICBleHBlY3QoZmlsdGVyZWRSZXN1bHRzKS50b01hdGNoU25hcHNob3QoKTtcbiAgfSwgMTUwMDApOyAvLyBBbGxvdyAxNSBzZWNvbmRzXG5cbiAgaXQoJ1JVVCBzaG91bGQgcGFzcycsIGFzeW5jKCkgPT4ge1xuICAgIGNvbnN0IHVzZXJuYW1lID0gJ3VuZm9sZGluZ1dvcmQnO1xuICAgIGNvbnN0IGxhbmd1YWdlQ29kZSA9ICdlbic7XG4gICAgY29uc3QgYm9va0lEID0gJ1JVVCc7XG4gICAgY29uc3QgcmF3UmVzdWx0cyA9IGF3YWl0IGNoZWNrQm9va1BhY2thZ2UodXNlcm5hbWUsIGxhbmd1YWdlQ29kZSwgYm9va0lELCAoKSA9PiB7fSwgb3B0aW9uYWxDaGVja2luZ09wdGlvbnMpO1xuICAgIGNvbnNvbGUubG9nKGBSVVQgQlAgdGVzdCB0b29rICR7cmF3UmVzdWx0cy5lbGFwc2VkU2Vjb25kc30gc2Vjb25kc2ApO1xuICAgIGV4cGVjdChyYXdSZXN1bHRzLm5vdGljZUxpc3QubGVuZ3RoKS50b0JlR3JlYXRlclRoYW5PckVxdWFsKDQpO1xuICAgIGNvbnN0IGZpbHRlcmVkUmVzdWx0cyA9IHtcbiAgICAgIHN1Y2Nlc3NMaXN0OiByYXdSZXN1bHRzLnN1Y2Nlc3NMaXN0LFxuICAgICAgbm90aWNlTGlzdDogcmF3UmVzdWx0cy5ub3RpY2VMaXN0LFxuICAgICAgY2hlY2tlZEZpbGVuYW1lczogcmF3UmVzdWx0cy5jaGVja2VkRmlsZW5hbWVzLFxuICAgICAgY2hlY2tlZFJlcG9OYW1lczogcmF3UmVzdWx0cy5jaGVja2VkUmVwb05hbWVzLFxuICAgIH07XG4gICAgZXhwZWN0KGZpbHRlcmVkUmVzdWx0cykudG9NYXRjaFNuYXBzaG90KCk7XG4gIH0sIDIwMDAwKTsgLy8gQWxsb3cgMjAgc2Vjb25kc1xuXG59KVxuXG4vL1xuLy8gSGVscGVyIGZ1bmN0aW9uc1xuLy9cblxuLyoqXG4gKiByZWN1cnNpdmVseSBnZXQgYSBmaWxlIGxpc3RcbiAqIEBwYXJhbSB7c3RyaW5nfSBkaXJQYXRoXG4gKiBAcGFyYW0ge3N0cmluZ30gc3ViUGF0aFxuICogQHBhcmFtIHtBcnJheX0gYXJyYXlPZkZpbGVzXG4gKiBAcmV0dXJuIHtBcnJheX1cbiAqL1xuY29uc3QgZ2V0QWxsRmlsZXMgPSBmdW5jdGlvbihkaXJQYXRoLCBzdWJQYXRoLCBhcnJheU9mRmlsZXMpIHtcbiAgLy8gY29uc29sZS5sb2coYGdldEFsbEZpbGVzKCR7ZGlyUGF0aH0sICR7c3ViUGF0aH0sICR7YXJyYXlPZkZpbGVzfWApO1xuICBhcnJheU9mRmlsZXMgPSBhcnJheU9mRmlsZXMgfHwgW107XG4gIHN1YlBhdGggPSBzdWJQYXRoIHx8ICcuJztcbiAgY29uc3QgZnVsbFBhdGggPSBQYXRoLmpvaW4oZGlyUGF0aCwgc3ViUGF0aCk7XG4gIGlmIChmcy5leGlzdHNTeW5jKGZ1bGxQYXRoKSkge1xuICAgIGNvbnN0IGZpbGVzID0gZnMucmVhZGRpclN5bmMoZnVsbFBhdGgpO1xuXG4gICAgZmlsZXMuZm9yRWFjaChmdW5jdGlvbiAoZmlsZSkge1xuICAgICAgY29uc3QgZnVsbFN1YlBhdGhfID0gUGF0aC5qb2luKGZ1bGxQYXRoLCBmaWxlKTtcbiAgICAgIGlmIChmcy5zdGF0U3luYyhmdWxsU3ViUGF0aF8pLmlzRGlyZWN0b3J5KCkpIHtcbiAgICAgICAgYXJyYXlPZkZpbGVzID0gZ2V0QWxsRmlsZXMoZGlyUGF0aCwgUGF0aC5qb2luKHN1YlBhdGgsIGZpbGUpLCBhcnJheU9mRmlsZXMpO1xuICAgICAgfSBlbHNlIHtcbiAgICAgICAgYXJyYXlPZkZpbGVzLnB1c2goUGF0aC5qb2luKHN1YlBhdGgsIGZpbGUpKTtcbiAgICAgIH1cbiAgICB9KVxuICB9XG4gIHJldHVybiBhcnJheU9mRmlsZXNcbn1cbiJdfQ==