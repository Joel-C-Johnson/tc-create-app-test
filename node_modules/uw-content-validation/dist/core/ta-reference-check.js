"use strict";var _interopRequireDefault = require("@babel/runtime/helpers/interopRequireDefault");Object.defineProperty(exports, "__esModule", { value: true });exports.checkSupportReferenceInTA = checkSupportReferenceInTA;var _regenerator = _interopRequireDefault(require("@babel/runtime/regenerator"));var _defineProperty2 = _interopRequireDefault(require("@babel/runtime/helpers/defineProperty"));var _asyncToGenerator2 = _interopRequireDefault(require("@babel/runtime/helpers/asyncToGenerator"));var _getApi = require("../core/getApi");

var _utilities = require("./utilities");function ownKeys(object, enumerableOnly) {var keys = Object.keys(object);if (Object.getOwnPropertySymbols) {var symbols = Object.getOwnPropertySymbols(object);if (enumerableOnly) {symbols = symbols.filter(function (sym) {return Object.getOwnPropertyDescriptor(object, sym).enumerable;});}keys.push.apply(keys, symbols);}return keys;}function _objectSpread(target) {for (var i = 1; i < arguments.length; i++) {var source = arguments[i] != null ? arguments[i] : {};if (i % 2) {ownKeys(Object(source), true).forEach(function (key) {(0, _defineProperty2.default)(target, key, source[key]);});} else if (Object.getOwnPropertyDescriptors) {Object.defineProperties(target, Object.getOwnPropertyDescriptors(source));} else {ownKeys(Object(source)).forEach(function (key) {Object.defineProperty(target, key, Object.getOwnPropertyDescriptor(source, key));});}}return target;}


// const TA_REFERENCE_VALIDATOR_VERSION_STRING = '0.3.2';
function

checkSupportReferenceInTA(_x, _x2, _x3, _x4) {return _checkSupportReferenceInTA.apply(this, arguments);}
















































































































// end of checkSupportReferenceInTA function
function _checkSupportReferenceInTA() {_checkSupportReferenceInTA = (0, _asyncToGenerator2.default)( /*#__PURE__*/_regenerator.default.mark(function _callee(fieldName, fieldText, givenLocation, checkingOptions) {var ourLocation, ctarResult, addNoticePartial, taRepoUsername, taRepoBranch, taRepoLanguageCode, taRepoSectionName, taRepoName, filepath, taFileContent, getFile_;return _regenerator.default.wrap(function _callee$(_context) {while (1) {switch (_context.prev = _context.next) {case 0:addNoticePartial = function _addNoticePartial(noticeObject) {// functionLog(`checkSupportReferenceInTA Notice: (priority=${priority}) ${message}${characterIndex > 0 ? ` (at character ${characterIndex})` : ""}${excerpt ? ` ${excerpt}` : ""}${location}`);
              //parameterAssert(noticeObject.priority !== undefined, "cTAref addNoticePartial: 'priority' parameter should be defined");
              //parameterAssert(typeof noticeObject.priority === 'number', `cTAref addNoticePartial: 'priority' parameter should be a number not a '${typeof noticeObject.priority}': ${noticeObject.priority}`);
              //parameterAssert(noticeObject.message !== undefined, "cTAref addNoticePartial: 'message' parameter should be defined");
              //parameterAssert(typeof noticeObject.message === 'string', `cTAref addNoticePartial: 'message' parameter should be a string not a '${typeof noticeObject.message}': ${noticeObject.message}`);
              // //parameterAssert(characterIndex !== undefined, "cTAref addNoticePartial: 'characterIndex' parameter should be defined");
              if (noticeObject.characterIndex) {//parameterAssert(typeof noticeObject.characterIndex === 'number', `cTAref addNoticePartial: 'characterIndex' parameter should be a number not a '${typeof noticeObject.characterIndex}': ${noticeObject.characterIndex}`);
              } // //parameterAssert(excerpt !== undefined, "cTAref addNoticePartial: 'excerpt' parameter should be defined");
              if (noticeObject.excerpt) {//parameterAssert(typeof noticeObject.excerpt === 'string', `cTAref addNoticePartial: 'excerpt' parameter should be a string not a '${typeof noticeObject.excerpt}': ${noticeObject.excerpt}`);
              } //parameterAssert(noticeObject.location !== undefined, "cTAref addNoticePartial: 'location' parameter should be defined");
              //parameterAssert(typeof noticeObject.location === 'string', `cTAref addNoticePartial: 'location' parameter should be a string not a '${typeof noticeObject.location}': ${noticeObject.location}`);
              ctarResult.noticeList.push(_objectSpread(_objectSpread({}, noticeObject), {}, { fieldName: fieldName }));}; // This is for the case of the full SupportReference field being the article link
            //  which is assumed to be in the translate part of the TA manual.
            // We fetch the TA link from Door43 to test that it’s really there
            //  -- you can control this with:
            //      checkingOptions?.taRepoUsername
            //      checkingOptions?.taRepoBranch (or tag)
            //      checkingOptions?.taRepoLanguageCode
            //      checkingOptions?.taRepoSectionName
            //      checkingOptions?.expectFullLink (bool)
            // functionLog(`checkSupportReferenceInTA v${TA_REFERENCE_VALIDATOR_VERSION_STRING} (${fieldName}, (${fieldText.length}) '${fieldText}', ${givenLocation}, …)`);
            //parameterAssert(fieldName !== undefined, "checkSupportReferenceInTA: 'fieldText' parameter should be defined");
            //parameterAssert(typeof fieldName === 'string', `checkSupportReferenceInTA: 'fieldText' parameter should be a string not a '${typeof fieldName}'`);
            //parameterAssert(fieldText !== undefined, "checkSupportReferenceInTA: 'fieldText' parameter should be defined");
            //parameterAssert(typeof fieldText === 'string', `checkSupportReferenceInTA: 'fieldText' parameter should be a string not a '${typeof fieldText}'`);
            //parameterAssert(givenLocation !== undefined, "checkSupportReferenceInTA: 'fieldText' parameter should be defined");
            //parameterAssert(typeof givenLocation === 'string', `checkSupportReferenceInTA: 'fieldText' parameter should be a string not a '${typeof givenLocation}'`);
            //parameterAssert(fieldName === 'SupportReference', `Unexpected checkSupportReferenceInTA fieldName='${fieldName}'`); // so far
            //parameterAssert(givenLocation.indexOf(fieldName) < 0, `checkSupportReferenceInTA: 'givenLocation' parameter should be not contain fieldName=${fieldName}`);
            //parameterAssert(fieldName === 'SupportReference');
            ourLocation = givenLocation;if (ourLocation && ourLocation[0] !== ' ') ourLocation = " ".concat(ourLocation);ctarResult = { noticeList: [] };try {taRepoUsername = checkingOptions === null || checkingOptions === void 0 ? void 0 : checkingOptions.taRepoUsername;} catch (trcUNerror) {}if (!taRepoUsername) taRepoUsername = 'Door43-Catalog'; // or unfoldingWord ???
            try {taRepoBranch = checkingOptions === null || checkingOptions === void 0 ? void 0 : checkingOptions.taRepoBranch;} catch (trcBRerror) {}if (!taRepoBranch) taRepoBranch = 'master';try {taRepoLanguageCode = checkingOptions === null || checkingOptions === void 0 ? void 0 : checkingOptions.taRepoLanguageCode;} catch (trcLCerror) {}if (!taRepoLanguageCode) taRepoLanguageCode = 'en';try {taRepoSectionName = checkingOptions === null || checkingOptions === void 0 ? void 0 : checkingOptions.taRepoSectionName;} catch (trcSNerror) {}if (!taRepoSectionName) taRepoSectionName = 'translate';taRepoName = "".concat(taRepoLanguageCode, "_ta");if (checkingOptions !== null && checkingOptions !== void 0 && checkingOptions.expectFullLink) {// debugLog("checkSupportReferenceInTA expect full link")
              if (!fieldText.startsWith('rc://*/')) addNoticePartial({ priority: 879, message: "Badly formatted Resource Container link", excerpt: fieldText, location: "".concat(ourLocation, " ").concat(filepath) });filepath = "".concat(fieldText.replace('rc://*/ta/man/', ''), "/01.md"); // Other files are title.md, sub-title.md
            } else filepath = "".concat(taRepoSectionName, "/").concat(fieldText, "/01.md"); // Other files are title.md, sub-title.md
            // debugLog("checkSupportReferenceInTA filepath", filepath);
            // debugLog(`Need to check against ${taRepoName}`);
            _context.prev = 14;getFile_ = checkingOptions && checkingOptions !== null && checkingOptions !== void 0 && checkingOptions.getFile ? checkingOptions === null || checkingOptions === void 0 ? void 0 : checkingOptions.getFile : _getApi.cachedGetFile;_context.next = 18;return getFile_({ username: taRepoUsername, repository: taRepoName, path: filepath, branch: taRepoBranch });case 18:taFileContent = _context.sent; // debugLog("Fetched fileContent for", taRepoName, filepath, typeof fileContent, fileContent.length);
            if (!taFileContent) addNoticePartial({ priority: 889, message: "Unable to find/load TA article", details: "linked from TN ".concat(fieldName), excerpt: fieldText, location: "".concat(ourLocation, " ").concat(filepath) });else if (taFileContent.length < 10) addNoticePartial({ priority: 887, message: "TA article seems empty", details: "linked from TN ".concat(fieldName), excerpt: fieldText, location: "".concat(ourLocation, " ").concat(filepath) });_context.next = 25;break;case 22:_context.prev = 22;_context.t0 = _context["catch"](14); // console.error("checkSupportReferenceInTA() failed to load", taRepoUsername, taRepoName, filepath, taRepoBranch, trcGCerror.message);
            addNoticePartial({ priority: 888, message: "Error loading TA article", details: "linked from TN ".concat(fieldName), excerpt: fieldText, location: "".concat(ourLocation, " ").concat(filepath, ": ").concat(_context.t0) });case 25:return _context.abrupt("return", ctarResult);case 26:case "end":return _context.stop();}}}, _callee, null, [[14, 22]]);}));return _checkSupportReferenceInTA.apply(this, arguments);}
//# sourceMappingURL=data:application/json;charset=utf-8;base64,eyJ2ZXJzaW9uIjozLCJzb3VyY2VzIjpbIi4uLy4uL3NyYy9jb3JlL3RhLXJlZmVyZW5jZS1jaGVjay5qcyJdLCJuYW1lcyI6WyJjaGVja1N1cHBvcnRSZWZlcmVuY2VJblRBIiwiZmllbGROYW1lIiwiZmllbGRUZXh0IiwiZ2l2ZW5Mb2NhdGlvbiIsImNoZWNraW5nT3B0aW9ucyIsImFkZE5vdGljZVBhcnRpYWwiLCJub3RpY2VPYmplY3QiLCJjaGFyYWN0ZXJJbmRleCIsImV4Y2VycHQiLCJjdGFyUmVzdWx0Iiwibm90aWNlTGlzdCIsInB1c2giLCJvdXJMb2NhdGlvbiIsInRhUmVwb1VzZXJuYW1lIiwidHJjVU5lcnJvciIsInRhUmVwb0JyYW5jaCIsInRyY0JSZXJyb3IiLCJ0YVJlcG9MYW5ndWFnZUNvZGUiLCJ0cmNMQ2Vycm9yIiwidGFSZXBvU2VjdGlvbk5hbWUiLCJ0cmNTTmVycm9yIiwidGFSZXBvTmFtZSIsImV4cGVjdEZ1bGxMaW5rIiwic3RhcnRzV2l0aCIsInByaW9yaXR5IiwibWVzc2FnZSIsImxvY2F0aW9uIiwiZmlsZXBhdGgiLCJyZXBsYWNlIiwiZ2V0RmlsZV8iLCJnZXRGaWxlIiwiY2FjaGVkR2V0RmlsZSIsInVzZXJuYW1lIiwicmVwb3NpdG9yeSIsInBhdGgiLCJicmFuY2giLCJ0YUZpbGVDb250ZW50IiwiZGV0YWlscyIsImxlbmd0aCJdLCJtYXBwaW5ncyI6Im1mQUFBOztBQUVBLHdDOzs7QUFHQTs7O0FBR3NCQSx5Qjs7Ozs7Ozs7Ozs7Ozs7Ozs7Ozs7Ozs7Ozs7Ozs7Ozs7Ozs7Ozs7Ozs7Ozs7Ozs7Ozs7Ozs7Ozs7Ozs7Ozs7Ozs7Ozs7Ozs7Ozs7Ozs7Ozs7Ozs7Ozs7Ozs7Ozs7Ozs7Ozs7Ozs7Ozs7Ozs7Ozs7Ozs7QUFpSHRCOzRJQWpITyxpQkFBeUNDLFNBQXpDLEVBQW9EQyxTQUFwRCxFQUErREMsYUFBL0QsRUFBOEVDLGVBQTlFLGdDQTZCTUMsZ0JBN0JOLDZPQTZCTUEsZ0JBN0JOLDhCQTZCdUJDLFlBN0J2QixFQTZCcUMsQ0FDcEM7QUFDQTtBQUNBO0FBQ0E7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RUFBRXBCLFlBQTVFLEVBQUQsQ0FuRy9CLFNBbUdDcUIsYUFuR0Qsa0JBb0dDO0FBQ0EsZ0JBQUksQ0FBQ0EsYUFBTCxFQUNJL0IsZ0JBQWdCLENBQUMsRUFBRW1CLFFBQVEsRUFBRSxHQUFaLEVBQWlCQyxPQUFPLGtDQUF4QixFQUE0RFksT0FBTywyQkFBb0JwQyxTQUFwQixDQUFuRSxFQUFvR08sT0FBTyxFQUFFTixTQUE3RyxFQUF3SHdCLFFBQVEsWUFBS2QsV0FBTCxjQUFvQmUsUUFBcEIsQ0FBaEksRUFBRCxDQUFoQixDQURKLEtBRUssSUFBSVMsYUFBYSxDQUFDRSxNQUFkLEdBQXVCLEVBQTNCLEVBQ0RqQyxnQkFBZ0IsQ0FBQyxFQUFFbUIsUUFBUSxFQUFFLEdBQVosRUFBaUJDLE9BQU8sMEJBQXhCLEVBQW9EWSxPQUFPLDJCQUFvQnBDLFNBQXBCLENBQTNELEVBQTRGTyxPQUFPLEVBQUVOLFNBQXJHLEVBQWdId0IsUUFBUSxZQUFLZCxXQUFMLGNBQW9CZSxRQUFwQixDQUF4SCxFQUFELENBQWhCLENBeEdMLHlGQTBHQztBQUNBdEIsWUFBQUEsZ0JBQWdCLENBQUMsRUFBRW1CLFFBQVEsRUFBRSxHQUFaLEVBQWlCQyxPQUFPLDRCQUF4QixFQUFzRFksT0FBTywyQkFBb0JwQyxTQUFwQixDQUE3RCxFQUE4Rk8sT0FBTyxFQUFFTixTQUF2RyxFQUFrSHdCLFFBQVEsWUFBS2QsV0FBTCxjQUFvQmUsUUFBcEIsMkJBQTFILEVBQUQsQ0FBaEIsQ0EzR0QseUNBK0dJbEIsVUEvR0osNkUiLCJzb3VyY2VzQ29udGVudCI6WyJpbXBvcnQgeyBjYWNoZWRHZXRGaWxlIH0gZnJvbSAnLi4vY29yZS9nZXRBcGknO1xuLy8gZXNsaW50LWRpc2FibGUtbmV4dC1saW5lIG5vLXVudXNlZC12YXJzXG5pbXBvcnQgeyBwYXJhbWV0ZXJBc3NlcnQgfSBmcm9tICcuL3V0aWxpdGllcyc7XG5cblxuLy8gY29uc3QgVEFfUkVGRVJFTkNFX1ZBTElEQVRPUl9WRVJTSU9OX1NUUklORyA9ICcwLjMuMic7XG5cblxuZXhwb3J0IGFzeW5jIGZ1bmN0aW9uIGNoZWNrU3VwcG9ydFJlZmVyZW5jZUluVEEoZmllbGROYW1lLCBmaWVsZFRleHQsIGdpdmVuTG9jYXRpb24sIGNoZWNraW5nT3B0aW9ucykge1xuICAgIC8vIFRoaXMgaXMgZm9yIHRoZSBjYXNlIG9mIHRoZSBmdWxsIFN1cHBvcnRSZWZlcmVuY2UgZmllbGQgYmVpbmcgdGhlIGFydGljbGUgbGlua1xuICAgIC8vICB3aGljaCBpcyBhc3N1bWVkIHRvIGJlIGluIHRoZSB0cmFuc2xhdGUgcGFydCBvZiB0aGUgVEEgbWFudWFsLlxuXG4gICAgLy8gV2UgZmV0Y2ggdGhlIFRBIGxpbmsgZnJvbSBEb29yNDMgdG8gdGVzdCB0aGF0IGl04oCZcyByZWFsbHkgdGhlcmVcbiAgICAvLyAgLS0geW91IGNhbiBjb250cm9sIHRoaXMgd2l0aDpcbiAgICAvLyAgICAgIGNoZWNraW5nT3B0aW9ucz8udGFSZXBvVXNlcm5hbWVcbiAgICAvLyAgICAgIGNoZWNraW5nT3B0aW9ucz8udGFSZXBvQnJhbmNoIChvciB0YWcpXG4gICAgLy8gICAgICBjaGVja2luZ09wdGlvbnM/LnRhUmVwb0xhbmd1YWdlQ29kZVxuICAgIC8vICAgICAgY2hlY2tpbmdPcHRpb25zPy50YVJlcG9TZWN0aW9uTmFtZVxuICAgIC8vICAgICAgY2hlY2tpbmdPcHRpb25zPy5leHBlY3RGdWxsTGluayAoYm9vbClcblxuICAgIC8vIGZ1bmN0aW9uTG9nKGBjaGVja1N1cHBvcnRSZWZlcmVuY2VJblRBIHYke1RBX1JFRkVSRU5DRV9WQUxJREFUT1JfVkVSU0lPTl9TVFJJTkd9ICgke2ZpZWxkTmFtZX0sICgke2ZpZWxkVGV4dC5sZW5ndGh9KSAnJHtmaWVsZFRleHR9JywgJHtnaXZlbkxvY2F0aW9ufSwg4oCmKWApO1xuICAgIC8vcGFyYW1ldGVyQXNzZXJ0KGZpZWxkTmFtZSAhPT0gdW5kZWZpbmVkLCBcImNoZWNrU3VwcG9ydFJlZmVyZW5jZUluVEE6ICdmaWVsZFRleHQnIHBhcmFtZXRlciBzaG91bGQgYmUgZGVmaW5lZFwiKTtcbiAgICAvL3BhcmFtZXRlckFzc2VydCh0eXBlb2YgZmllbGROYW1lID09PSAnc3RyaW5nJywgYGNoZWNrU3VwcG9ydFJlZmVyZW5jZUluVEE6ICdmaWVsZFRleHQnIHBhcmFtZXRlciBzaG91bGQgYmUgYSBzdHJpbmcgbm90IGEgJyR7dHlwZW9mIGZpZWxkTmFtZX0nYCk7XG4gICAgLy9wYXJhbWV0ZXJBc3NlcnQoZmllbGRUZXh0ICE9PSB1bmRlZmluZWQsIFwiY2hlY2tTdXBwb3J0UmVmZXJlbmNlSW5UQTogJ2ZpZWxkVGV4dCcgcGFyYW1ldGVyIHNob3VsZCBiZSBkZWZpbmVkXCIpO1xuICAgIC8vcGFyYW1ldGVyQXNzZXJ0KHR5cGVvZiBmaWVsZFRleHQgPT09ICdzdHJpbmcnLCBgY2hlY2tTdXBwb3J0UmVmZXJlbmNlSW5UQTogJ2ZpZWxkVGV4dCcgcGFyYW1ldGVyIHNob3VsZCBiZSBhIHN0cmluZyBub3QgYSAnJHt0eXBlb2YgZmllbGRUZXh0fSdgKTtcbiAgICAvL3BhcmFtZXRlckFzc2VydChnaXZlbkxvY2F0aW9uICE9PSB1bmRlZmluZWQsIFwiY2hlY2tTdXBwb3J0UmVmZXJlbmNlSW5UQTogJ2ZpZWxkVGV4dCcgcGFyYW1ldGVyIHNob3VsZCBiZSBkZWZpbmVkXCIpO1xuICAgIC8vcGFyYW1ldGVyQXNzZXJ0KHR5cGVvZiBnaXZlbkxvY2F0aW9uID09PSAnc3RyaW5nJywgYGNoZWNrU3VwcG9ydFJlZmVyZW5jZUluVEE6ICdmaWVsZFRleHQnIHBhcmFtZXRlciBzaG91bGQgYmUgYSBzdHJpbmcgbm90IGEgJyR7dHlwZW9mIGdpdmVuTG9jYXRpb259J2ApO1xuICAgIC8vcGFyYW1ldGVyQXNzZXJ0KGZpZWxkTmFtZSA9PT0gJ1N1cHBvcnRSZWZlcmVuY2UnLCBgVW5leHBlY3RlZCBjaGVja1N1cHBvcnRSZWZlcmVuY2VJblRBIGZpZWxkTmFtZT0nJHtmaWVsZE5hbWV9J2ApOyAvLyBzbyBmYXJcbiAgICAvL3BhcmFtZXRlckFzc2VydChnaXZlbkxvY2F0aW9uLmluZGV4T2YoZmllbGROYW1lKSA8IDAsIGBjaGVja1N1cHBvcnRSZWZlcmVuY2VJblRBOiAnZ2l2ZW5Mb2NhdGlvbicgcGFyYW1ldGVyIHNob3VsZCBiZSBub3QgY29udGFpbiBmaWVsZE5hbWU9JHtmaWVsZE5hbWV9YCk7XG5cbiAgICAvL3BhcmFtZXRlckFzc2VydChmaWVsZE5hbWUgPT09ICdTdXBwb3J0UmVmZXJlbmNlJyk7XG5cbiAgICBsZXQgb3VyTG9jYXRpb24gPSBnaXZlbkxvY2F0aW9uO1xuICAgIGlmIChvdXJMb2NhdGlvbiAmJiBvdXJMb2NhdGlvblswXSAhPT0gJyAnKSBvdXJMb2NhdGlvbiA9IGAgJHtvdXJMb2NhdGlvbn1gO1xuXG4gICAgY29uc3QgY3RhclJlc3VsdCA9IHsgbm90aWNlTGlzdDogW10gfTtcblxuICAgIGZ1bmN0aW9uIGFkZE5vdGljZVBhcnRpYWwobm90aWNlT2JqZWN0KSB7XG4gICAgICAgIC8vIGZ1bmN0aW9uTG9nKGBjaGVja1N1cHBvcnRSZWZlcmVuY2VJblRBIE5vdGljZTogKHByaW9yaXR5PSR7cHJpb3JpdHl9KSAke21lc3NhZ2V9JHtjaGFyYWN0ZXJJbmRleCA+IDAgPyBgIChhdCBjaGFyYWN0ZXIgJHtjaGFyYWN0ZXJJbmRleH0pYCA6IFwiXCJ9JHtleGNlcnB0ID8gYCAke2V4Y2VycHR9YCA6IFwiXCJ9JHtsb2NhdGlvbn1gKTtcbiAgICAgICAgLy9wYXJhbWV0ZXJBc3NlcnQobm90aWNlT2JqZWN0LnByaW9yaXR5ICE9PSB1bmRlZmluZWQsIFwiY1RBcmVmIGFkZE5vdGljZVBhcnRpYWw6ICdwcmlvcml0eScgcGFyYW1ldGVyIHNob3VsZCBiZSBkZWZpbmVkXCIpO1xuICAgICAgICAvL3BhcmFtZXRlckFzc2VydCh0eXBlb2Ygbm90aWNlT2JqZWN0LnByaW9yaXR5ID09PSAnbnVtYmVyJywgYGNUQXJlZiBhZGROb3RpY2VQYXJ0aWFsOiAncHJpb3JpdHknIHBhcmFtZXRlciBzaG91bGQgYmUgYSBudW1iZXIgbm90IGEgJyR7dHlwZW9mIG5vdGljZU9iamVjdC5wcmlvcml0eX0nOiAke25vdGljZU9iamVjdC5wcmlvcml0eX1gKTtcbiAgICAgICAgLy9wYXJhbWV0ZXJBc3NlcnQobm90aWNlT2JqZWN0Lm1lc3NhZ2UgIT09IHVuZGVmaW5lZCwgXCJjVEFyZWYgYWRkTm90aWNlUGFydGlhbDogJ21lc3NhZ2UnIHBhcmFtZXRlciBzaG91bGQgYmUgZGVmaW5lZFwiKTtcbiAgICAgICAgLy9wYXJhbWV0ZXJBc3NlcnQodHlwZW9mIG5vdGljZU9iamVjdC5tZXNzYWdlID09PSAnc3RyaW5nJywgYGNUQXJlZiBhZGROb3RpY2VQYXJ0aWFsOiAnbWVzc2FnZScgcGFyYW1ldGVyIHNob3VsZCBiZSBhIHN0cmluZyBub3QgYSAnJHt0eXBlb2Ygbm90aWNlT2JqZWN0Lm1lc3NhZ2V9JzogJHtub3RpY2VPYmplY3QubWVzc2FnZX1gKTtcbiAgICAgICAgLy8gLy9wYXJhbWV0ZXJBc3NlcnQoY2hhcmFjdGVySW5kZXggIT09IHVuZGVmaW5lZCwgXCJjVEFyZWYgYWRkTm90aWNlUGFydGlhbDogJ2NoYXJhY3RlckluZGV4JyBwYXJhbWV0ZXIgc2hvdWxkIGJlIGRlZmluZWRcIik7XG4gICAgICAgIGlmIChub3RpY2VPYmplY3QuY2hhcmFjdGVySW5kZXgpIHsgLy9wYXJhbWV0ZXJBc3NlcnQodHlwZW9mIG5vdGljZU9iamVjdC5jaGFyYWN0ZXJJbmRleCA9PT0gJ251bWJlcicsIGBjVEFyZWYgYWRkTm90aWNlUGFydGlhbDogJ2NoYXJhY3RlckluZGV4JyBwYXJhbWV0ZXIgc2hvdWxkIGJlIGEgbnVtYmVyIG5vdCBhICcke3R5cGVvZiBub3RpY2VPYmplY3QuY2hhcmFjdGVySW5kZXh9JzogJHtub3RpY2VPYmplY3QuY2hhcmFjdGVySW5kZXh9YCk7XG4gICAgICAgIH1cbiAgICAgICAgLy8gLy9wYXJhbWV0ZXJBc3NlcnQoZXhjZXJwdCAhPT0gdW5kZWZpbmVkLCBcImNUQXJlZiBhZGROb3RpY2VQYXJ0aWFsOiAnZXhjZXJwdCcgcGFyYW1ldGVyIHNob3VsZCBiZSBkZWZpbmVkXCIpO1xuICAgICAgICBpZiAobm90aWNlT2JqZWN0LmV4Y2VycHQpIHsgLy9wYXJhbWV0ZXJBc3NlcnQodHlwZW9mIG5vdGljZU9iamVjdC5leGNlcnB0ID09PSAnc3RyaW5nJywgYGNUQXJlZiBhZGROb3RpY2VQYXJ0aWFsOiAnZXhjZXJwdCcgcGFyYW1ldGVyIHNob3VsZCBiZSBhIHN0cmluZyBub3QgYSAnJHt0eXBlb2Ygbm90aWNlT2JqZWN0LmV4Y2VycHR9JzogJHtub3RpY2VPYmplY3QuZXhjZXJwdH1gKTtcbiAgICAgICAgfVxuICAgICAgICAvL3BhcmFtZXRlckFzc2VydChub3RpY2VPYmplY3QubG9jYXRpb24gIT09IHVuZGVmaW5lZCwgXCJjVEFyZWYgYWRkTm90aWNlUGFydGlhbDogJ2xvY2F0aW9uJyBwYXJhbWV0ZXIgc2hvdWxkIGJlIGRlZmluZWRcIik7XG4gICAgICAgIC8vcGFyYW1ldGVyQXNzZXJ0KHR5cGVvZiBub3RpY2VPYmplY3QubG9jYXRpb24gPT09ICdzdHJpbmcnLCBgY1RBcmVmIGFkZE5vdGljZVBhcnRpYWw6ICdsb2NhdGlvbicgcGFyYW1ldGVyIHNob3VsZCBiZSBhIHN0cmluZyBub3QgYSAnJHt0eXBlb2Ygbm90aWNlT2JqZWN0LmxvY2F0aW9ufSc6ICR7bm90aWNlT2JqZWN0LmxvY2F0aW9ufWApO1xuICAgICAgICBjdGFyUmVzdWx0Lm5vdGljZUxpc3QucHVzaCh7IC4uLm5vdGljZU9iamVjdCwgZmllbGROYW1lIH0pO1xuICAgIH1cblxuXG4gICAgLy8gTWFpbiBjb2RlIGZvciBjaGVja1N1cHBvcnRSZWZlcmVuY2VJblRBXG4gICAgLypcbiAgICBsZXQgZXhjZXJwdExlbmd0aDtcbiAgICB0cnkge1xuICAgICAgICBleGNlcnB0TGVuZ3RoID0gY2hlY2tpbmdPcHRpb25zPy5leGNlcnB0TGVuZ3RoO1xuICAgIH0gY2F0Y2ggKHRyY0VMZXJyb3IpIHsgfVxuICAgIGlmICh0eXBlb2YgZXhjZXJwdExlbmd0aCAhPT0gJ251bWJlcicgfHwgaXNOYU4oZXhjZXJwdExlbmd0aCkpIHtcbiAgICAgICAgZXhjZXJwdExlbmd0aCA9IERFRkFVTFRfRVhDRVJQVF9MRU5HVEg7XG4gICAgICAgIC8vIGRlYnVnTG9nKGBVc2luZyBkZWZhdWx0IGV4Y2VycHRMZW5ndGg9JHtleGNlcnB0TGVuZ3RofWApO1xuICAgIH1cbiAgICAvLyBlbHNlXG4gICAgICAgIC8vIGRlYnVnTG9nKGBVc2luZyBzdXBwbGllZCBleGNlcnB0TGVuZ3RoPSR7ZXhjZXJwdExlbmd0aH1gLCBcImNmLiBkZWZhdWx0PVwiK0RFRkFVTFRfRVhDRVJQVF9MRU5HVEgpO1xuICAgIGNvbnN0IGV4Y2VycHRIYWxmTGVuZ3RoID0gTWF0aC5mbG9vcihleGNlcnB0TGVuZ3RoIC8gMik7IC8vIHJvdW5kZWQgZG93blxuICAgIGNvbnN0IGV4Y2VycHRIYWxmTGVuZ3RoUGx1cyA9IE1hdGguZmxvb3IoKGV4Y2VycHRMZW5ndGggKyAxKSAvIDIpOyAvLyByb3VuZGVkIHVwXG4gICAgLy8gZGVidWdMb2coYFVzaW5nIGV4Y2VycHRIYWxmTGVuZ3RoPSR7ZXhjZXJwdEhhbGZMZW5ndGh9YCwgXCJleGNlcnB0SGFsZkxlbmd0aFBsdXM9XCIrZXhjZXJwdEhhbGZMZW5ndGhQbHVzKTtcbiAgICAqL1xuXG4gICAgbGV0IHRhUmVwb1VzZXJuYW1lO1xuICAgIHRyeSB7XG4gICAgICAgIHRhUmVwb1VzZXJuYW1lID0gY2hlY2tpbmdPcHRpb25zPy50YVJlcG9Vc2VybmFtZTtcbiAgICB9IGNhdGNoICh0cmNVTmVycm9yKSB7IH1cbiAgICBpZiAoIXRhUmVwb1VzZXJuYW1lKSB0YVJlcG9Vc2VybmFtZSA9ICdEb29yNDMtQ2F0YWxvZyc7IC8vIG9yIHVuZm9sZGluZ1dvcmQgPz8/XG4gICAgbGV0IHRhUmVwb0JyYW5jaDtcbiAgICB0cnkge1xuICAgICAgICB0YVJlcG9CcmFuY2ggPSBjaGVja2luZ09wdGlvbnM/LnRhUmVwb0JyYW5jaDtcbiAgICB9IGNhdGNoICh0cmNCUmVycm9yKSB7IH1cbiAgICBpZiAoIXRhUmVwb0JyYW5jaCkgdGFSZXBvQnJhbmNoID0gJ21hc3Rlcic7XG4gICAgbGV0IHRhUmVwb0xhbmd1YWdlQ29kZTtcbiAgICB0cnkge1xuICAgICAgICB0YVJlcG9MYW5ndWFnZUNvZGUgPSBjaGVja2luZ09wdGlvbnM/LnRhUmVwb0xhbmd1YWdlQ29kZTtcbiAgICB9IGNhdGNoICh0cmNMQ2Vycm9yKSB7IH1cbiAgICBpZiAoIXRhUmVwb0xhbmd1YWdlQ29kZSkgdGFSZXBvTGFuZ3VhZ2VDb2RlID0gJ2VuJztcbiAgICBsZXQgdGFSZXBvU2VjdGlvbk5hbWU7XG4gICAgdHJ5IHtcbiAgICAgICAgdGFSZXBvU2VjdGlvbk5hbWUgPSBjaGVja2luZ09wdGlvbnM/LnRhUmVwb1NlY3Rpb25OYW1lO1xuICAgIH0gY2F0Y2ggKHRyY1NOZXJyb3IpIHsgfVxuICAgIGlmICghdGFSZXBvU2VjdGlvbk5hbWUpIHRhUmVwb1NlY3Rpb25OYW1lID0gJ3RyYW5zbGF0ZSc7XG4gICAgY29uc3QgdGFSZXBvTmFtZSA9IGAke3RhUmVwb0xhbmd1YWdlQ29kZX1fdGFgO1xuICAgIGxldCBmaWxlcGF0aDtcbiAgICBpZiAoY2hlY2tpbmdPcHRpb25zPy5leHBlY3RGdWxsTGluaykge1xuICAgICAgICAvLyBkZWJ1Z0xvZyhcImNoZWNrU3VwcG9ydFJlZmVyZW5jZUluVEEgZXhwZWN0IGZ1bGwgbGlua1wiKVxuICAgICAgICBpZiAoIWZpZWxkVGV4dC5zdGFydHNXaXRoKCdyYzovLyovJykpXG4gICAgICAgICAgICBhZGROb3RpY2VQYXJ0aWFsKHsgcHJpb3JpdHk6IDg3OSwgbWVzc2FnZTogYEJhZGx5IGZvcm1hdHRlZCBSZXNvdXJjZSBDb250YWluZXIgbGlua2AsIGV4Y2VycHQ6IGZpZWxkVGV4dCwgbG9jYXRpb246IGAke291ckxvY2F0aW9ufSAke2ZpbGVwYXRofWAgfSk7XG4gICAgICAgIGZpbGVwYXRoID0gYCR7ZmllbGRUZXh0LnJlcGxhY2UoJ3JjOi8vKi90YS9tYW4vJywgJycpfS8wMS5tZGA7IC8vIE90aGVyIGZpbGVzIGFyZSB0aXRsZS5tZCwgc3ViLXRpdGxlLm1kXG4gICAgfVxuICAgIGVsc2UgZmlsZXBhdGggPSBgJHt0YVJlcG9TZWN0aW9uTmFtZX0vJHtmaWVsZFRleHR9LzAxLm1kYDsgLy8gT3RoZXIgZmlsZXMgYXJlIHRpdGxlLm1kLCBzdWItdGl0bGUubWRcbiAgICAvLyBkZWJ1Z0xvZyhcImNoZWNrU3VwcG9ydFJlZmVyZW5jZUluVEEgZmlsZXBhdGhcIiwgZmlsZXBhdGgpO1xuXG4gICAgLy8gZGVidWdMb2coYE5lZWQgdG8gY2hlY2sgYWdhaW5zdCAke3RhUmVwb05hbWV9YCk7XG4gICAgbGV0IHRhRmlsZUNvbnRlbnQ7IC8vIE5vdCByZWFsbHkgdXNlZCBoZXJlIC0tIGp1c3QgdG8gc2hvdyB0aGF0IHdlIGdvdCBzb21ldGhpbmcgdmFsaWRcbiAgICB0cnkge1xuICAgICAgICBjb25zdCBnZXRGaWxlXyA9IChjaGVja2luZ09wdGlvbnMgJiYgY2hlY2tpbmdPcHRpb25zPy5nZXRGaWxlKSA/IGNoZWNraW5nT3B0aW9ucz8uZ2V0RmlsZSA6IGNhY2hlZEdldEZpbGU7XG4gICAgICAgIHRhRmlsZUNvbnRlbnQgPSBhd2FpdCBnZXRGaWxlXyh7IHVzZXJuYW1lOiB0YVJlcG9Vc2VybmFtZSwgcmVwb3NpdG9yeTogdGFSZXBvTmFtZSwgcGF0aDogZmlsZXBhdGgsIGJyYW5jaDogdGFSZXBvQnJhbmNoIH0pO1xuICAgICAgICAvLyBkZWJ1Z0xvZyhcIkZldGNoZWQgZmlsZUNvbnRlbnQgZm9yXCIsIHRhUmVwb05hbWUsIGZpbGVwYXRoLCB0eXBlb2YgZmlsZUNvbnRlbnQsIGZpbGVDb250ZW50Lmxlbmd0aCk7XG4gICAgICAgIGlmICghdGFGaWxlQ29udGVudClcbiAgICAgICAgICAgIGFkZE5vdGljZVBhcnRpYWwoeyBwcmlvcml0eTogODg5LCBtZXNzYWdlOiBgVW5hYmxlIHRvIGZpbmQvbG9hZCBUQSBhcnRpY2xlYCwgZGV0YWlsczogYGxpbmtlZCBmcm9tIFROICR7ZmllbGROYW1lfWAsIGV4Y2VycHQ6IGZpZWxkVGV4dCwgbG9jYXRpb246IGAke291ckxvY2F0aW9ufSAke2ZpbGVwYXRofWAgfSk7XG4gICAgICAgIGVsc2UgaWYgKHRhRmlsZUNvbnRlbnQubGVuZ3RoIDwgMTApXG4gICAgICAgICAgICBhZGROb3RpY2VQYXJ0aWFsKHsgcHJpb3JpdHk6IDg4NywgbWVzc2FnZTogYFRBIGFydGljbGUgc2VlbXMgZW1wdHlgLCBkZXRhaWxzOiBgbGlua2VkIGZyb20gVE4gJHtmaWVsZE5hbWV9YCwgZXhjZXJwdDogZmllbGRUZXh0LCBsb2NhdGlvbjogYCR7b3VyTG9jYXRpb259ICR7ZmlsZXBhdGh9YCB9KTtcbiAgICB9IGNhdGNoICh0cmNHQ2Vycm9yKSB7XG4gICAgICAgIC8vIGNvbnNvbGUuZXJyb3IoXCJjaGVja1N1cHBvcnRSZWZlcmVuY2VJblRBKCkgZmFpbGVkIHRvIGxvYWRcIiwgdGFSZXBvVXNlcm5hbWUsIHRhUmVwb05hbWUsIGZpbGVwYXRoLCB0YVJlcG9CcmFuY2gsIHRyY0dDZXJyb3IubWVzc2FnZSk7XG4gICAgICAgIGFkZE5vdGljZVBhcnRpYWwoeyBwcmlvcml0eTogODg4LCBtZXNzYWdlOiBgRXJyb3IgbG9hZGluZyBUQSBhcnRpY2xlYCwgZGV0YWlsczogYGxpbmtlZCBmcm9tIFROICR7ZmllbGROYW1lfWAsIGV4Y2VycHQ6IGZpZWxkVGV4dCwgbG9jYXRpb246IGAke291ckxvY2F0aW9ufSAke2ZpbGVwYXRofTogJHt0cmNHQ2Vycm9yfWAgfSk7XG4gICAgfVxuXG4gICAgLy8gZnVuY3Rpb25Mb2coYGNoZWNrU3VwcG9ydFJlZmVyZW5jZUluVEEgaXMgcmV0dXJuaW5nICR7SlNPTi5zdHJpbmdpZnkoY3RhclJlc3VsdCl9YCk7XG4gICAgcmV0dXJuIGN0YXJSZXN1bHQ7XG59XG4vLyBlbmQgb2YgY2hlY2tTdXBwb3J0UmVmZXJlbmNlSW5UQSBmdW5jdGlvblxuIl19