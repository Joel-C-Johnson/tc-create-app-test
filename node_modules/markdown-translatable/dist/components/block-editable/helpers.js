"use strict";

Object.defineProperty(exports, "__esModule", {
  value: true
});
exports.useFixCursorOnNewLine = useFixCursorOnNewLine;
exports.useHandleUndo = useHandleUndo;
exports.useHandlePaste = useHandlePaste;

var _react = require("react");

function _slicedToArray(arr, i) { return _arrayWithHoles(arr) || _iterableToArrayLimit(arr, i) || _unsupportedIterableToArray(arr, i) || _nonIterableRest(); }

function _nonIterableRest() { throw new TypeError("Invalid attempt to destructure non-iterable instance.\nIn order to be iterable, non-array objects must have a [Symbol.iterator]() method."); }

function _unsupportedIterableToArray(o, minLen) { if (!o) return; if (typeof o === "string") return _arrayLikeToArray(o, minLen); var n = Object.prototype.toString.call(o).slice(8, -1); if (n === "Object" && o.constructor) n = o.constructor.name; if (n === "Map" || n === "Set") return Array.from(o); if (n === "Arguments" || /^(?:Ui|I)nt(?:8|16|32)(?:Clamped)?Array$/.test(n)) return _arrayLikeToArray(o, minLen); }

function _arrayLikeToArray(arr, len) { if (len == null || len > arr.length) len = arr.length; for (var i = 0, arr2 = new Array(len); i < len; i++) { arr2[i] = arr[i]; } return arr2; }

function _iterableToArrayLimit(arr, i) { if (typeof Symbol === "undefined" || !(Symbol.iterator in Object(arr))) return; var _arr = []; var _n = true; var _d = false; var _e = undefined; try { for (var _i = arr[Symbol.iterator](), _s; !(_n = (_s = _i.next()).done); _n = true) { _arr.push(_s.value); if (i && _arr.length === i) break; } } catch (err) { _d = true; _e = err; } finally { try { if (!_n && _i["return"] != null) _i["return"](); } finally { if (_d) throw _e; } } return _arr; }

function _arrayWithHoles(arr) { if (Array.isArray(arr)) return arr; }

function useFixCursorOnNewLine(el) {
  var _useState = (0, _react.useState)(null),
      _useState2 = _slicedToArray(_useState, 2),
      savedSelection = _useState2[0],
      setSavedSelection = _useState2[1];

  var saveSelection = (0, _react.useCallback)(function (containerEl) {
    if (window.getSelection().rangeCount > 0) {
      var range = window.getSelection().getRangeAt(0);
      var preSelectionRange = range.cloneRange();
      preSelectionRange.selectNodeContents(containerEl);
      preSelectionRange.setEnd(range.startContainer, range.startOffset);
      var start = preSelectionRange.toString().length;
      /** Adding plus one to account for newline */

      setSavedSelection({
        start: start + 1,

        /** Adding plus one to account for newline */
        end: start + range.toString().length + 1
      });
    } else {
      setSavedSelection({
        start: 0,
        end: 0
      });
    }
  }, []);
  var restoreSelection = (0, _react.useCallback)(function (containerEl, _savedSelection) {
    var charIndex = 0,
        range = document.createRange();
    range.setStart(containerEl, 0);
    range.collapse(true);
    var nodeStack = [containerEl],
        node,
        foundStart = false,
        stop = false;

    while (!stop && (node = nodeStack.pop())) {
      if (node.nodeType == 3) {
        var nextCharIndex = charIndex + node.length;

        if (!foundStart && _savedSelection.start >= charIndex && _savedSelection.start <= nextCharIndex) {
          range.setStart(node, _savedSelection.start - charIndex);
          foundStart = true;
        }

        if (foundStart && _savedSelection.end >= charIndex && _savedSelection.end <= nextCharIndex) {
          range.setEnd(node, _savedSelection.end - charIndex);
          stop = true;
        }

        charIndex = nextCharIndex;
      } else {
        var i = node.childNodes.length;

        while (i--) {
          nodeStack.push(node.childNodes[i]);
        }
      }
    }

    var sel = window.getSelection();
    sel.removeAllRanges();
    sel.addRange(range);
  }, []);
  var handleRestore = (0, _react.useCallback)(function (e) {
    /** Only listening for newline key character code */
    if (e.keyCode === 13) {
      restoreSelection(el, savedSelection);
    }
  }, [el, restoreSelection, savedSelection]);
  var handleSaveSelection = (0, _react.useCallback)(function () {
    saveSelection(el);
  }, [el, saveSelection]);
  (0, _react.useEffect)(function () {
    if (el) {
      el.addEventListener('keyup', handleRestore);
      el.addEventListener('keydown', handleSaveSelection);
    }

    ;
    return function () {
      if (el) {
        el.removeEventListener('keyup', handleRestore);
        el.addEventListener('keydown', handleSaveSelection);
      }
    };
  }, [el, handleRestore, handleSaveSelection, restoreSelection, saveSelection]);
}

function useHandleUndo(el, initialState) {
  var _useState3 = (0, _react.useState)([initialState]),
      _useState4 = _slicedToArray(_useState3, 2),
      lastValues = _useState4[0],
      setLastValues = _useState4[1];

  var handleUndo = (0, _react.useCallback)(function (e) {
    if (e.metaKey && e.key === 'z' && lastValues.length) {
      e.target.innerHTML = lastValues.pop();
    }

    if (!e.metaKey || e.metaKey && e.key === 'v') {
      var copy = lastValues.slice(0);
      copy.push(e.target.innerHTML);
      setLastValues(copy);
    }
  }, [lastValues]);
  (0, _react.useEffect)(function () {
    if (el) {
      el.addEventListener('keydown', handleUndo);
    }

    ;
    return function () {
      if (el) {
        el.removeEventListener('keydown', handleUndo);
      }
    };
  }, [el, handleUndo]);
}

function useHandlePaste(el, preview) {
  var handlePaste = (0, _react.useCallback)(function (e) {
    e.preventDefault();
    var pastedData = e.clipboardData.getData('text/plain');
    var doc = new DOMParser().parseFromString(pastedData, 'text/html');
    var text = doc.body.textContent || '';
    document.execCommand('insertHTML', false, text);
  }, []);
  (0, _react.useEffect)(function () {
    if (el) {
      el.addEventListener('paste', handlePaste);
    }

    ;
    return function () {
      if (el) {
        el.removeEventListener('paste', handlePaste);
      }
    };
  }, [el, handlePaste, preview]);
}
//# sourceMappingURL=data:application/json;charset=utf-8;base64,eyJ2ZXJzaW9uIjozLCJzb3VyY2VzIjpbIi4uLy4uLy4uL3NyYy9jb21wb25lbnRzL2Jsb2NrLWVkaXRhYmxlL2hlbHBlcnMuanMiXSwibmFtZXMiOlsidXNlRml4Q3Vyc29yT25OZXdMaW5lIiwiZWwiLCJzYXZlZFNlbGVjdGlvbiIsInNldFNhdmVkU2VsZWN0aW9uIiwic2F2ZVNlbGVjdGlvbiIsImNvbnRhaW5lckVsIiwid2luZG93IiwiZ2V0U2VsZWN0aW9uIiwicmFuZ2VDb3VudCIsInJhbmdlIiwiZ2V0UmFuZ2VBdCIsInByZVNlbGVjdGlvblJhbmdlIiwiY2xvbmVSYW5nZSIsInNlbGVjdE5vZGVDb250ZW50cyIsInNldEVuZCIsInN0YXJ0Q29udGFpbmVyIiwic3RhcnRPZmZzZXQiLCJzdGFydCIsInRvU3RyaW5nIiwibGVuZ3RoIiwiZW5kIiwicmVzdG9yZVNlbGVjdGlvbiIsIl9zYXZlZFNlbGVjdGlvbiIsImNoYXJJbmRleCIsImRvY3VtZW50IiwiY3JlYXRlUmFuZ2UiLCJzZXRTdGFydCIsImNvbGxhcHNlIiwibm9kZVN0YWNrIiwibm9kZSIsImZvdW5kU3RhcnQiLCJzdG9wIiwicG9wIiwibm9kZVR5cGUiLCJuZXh0Q2hhckluZGV4IiwiaSIsImNoaWxkTm9kZXMiLCJwdXNoIiwic2VsIiwicmVtb3ZlQWxsUmFuZ2VzIiwiYWRkUmFuZ2UiLCJoYW5kbGVSZXN0b3JlIiwiZSIsImtleUNvZGUiLCJoYW5kbGVTYXZlU2VsZWN0aW9uIiwiYWRkRXZlbnRMaXN0ZW5lciIsInJlbW92ZUV2ZW50TGlzdGVuZXIiLCJ1c2VIYW5kbGVVbmRvIiwiaW5pdGlhbFN0YXRlIiwibGFzdFZhbHVlcyIsInNldExhc3RWYWx1ZXMiLCJoYW5kbGVVbmRvIiwibWV0YUtleSIsImtleSIsInRhcmdldCIsImlubmVySFRNTCIsImNvcHkiLCJzbGljZSIsInVzZUhhbmRsZVBhc3RlIiwicHJldmlldyIsImhhbmRsZVBhc3RlIiwicHJldmVudERlZmF1bHQiLCJwYXN0ZWREYXRhIiwiY2xpcGJvYXJkRGF0YSIsImdldERhdGEiLCJkb2MiLCJET01QYXJzZXIiLCJwYXJzZUZyb21TdHJpbmciLCJ0ZXh0IiwiYm9keSIsInRleHRDb250ZW50IiwiZXhlY0NvbW1hbmQiXSwibWFwcGluZ3MiOiI7Ozs7Ozs7OztBQUFBOzs7Ozs7Ozs7Ozs7OztBQUlPLFNBQVNBLHFCQUFULENBQStCQyxFQUEvQixFQUFtQztBQUFBLGtCQUNJLHFCQUFTLElBQVQsQ0FESjtBQUFBO0FBQUEsTUFDakNDLGNBRGlDO0FBQUEsTUFDakJDLGlCQURpQjs7QUFHeEMsTUFBTUMsYUFBYSxHQUFHLHdCQUFZLFVBQVVDLFdBQVYsRUFBdUI7QUFDdkQsUUFBSUMsTUFBTSxDQUFDQyxZQUFQLEdBQXNCQyxVQUF0QixHQUFtQyxDQUF2QyxFQUEwQztBQUN4QyxVQUFNQyxLQUFLLEdBQUdILE1BQU0sQ0FBQ0MsWUFBUCxHQUFzQkcsVUFBdEIsQ0FBaUMsQ0FBakMsQ0FBZDtBQUNBLFVBQU1DLGlCQUFpQixHQUFHRixLQUFLLENBQUNHLFVBQU4sRUFBMUI7QUFDQUQsTUFBQUEsaUJBQWlCLENBQUNFLGtCQUFsQixDQUFxQ1IsV0FBckM7QUFDQU0sTUFBQUEsaUJBQWlCLENBQUNHLE1BQWxCLENBQXlCTCxLQUFLLENBQUNNLGNBQS9CLEVBQStDTixLQUFLLENBQUNPLFdBQXJEO0FBQ0EsVUFBTUMsS0FBSyxHQUFHTixpQkFBaUIsQ0FBQ08sUUFBbEIsR0FBNkJDLE1BQTNDO0FBRUE7O0FBQ0FoQixNQUFBQSxpQkFBaUIsQ0FBQztBQUNoQmMsUUFBQUEsS0FBSyxFQUFFQSxLQUFLLEdBQUcsQ0FEQzs7QUFFaEI7QUFDQUcsUUFBQUEsR0FBRyxFQUFFSCxLQUFLLEdBQUdSLEtBQUssQ0FBQ1MsUUFBTixHQUFpQkMsTUFBekIsR0FBa0M7QUFIdkIsT0FBRCxDQUFqQjtBQUtELEtBYkQsTUFhTztBQUNMaEIsTUFBQUEsaUJBQWlCLENBQUM7QUFDaEJjLFFBQUFBLEtBQUssRUFBRSxDQURTO0FBRWhCRyxRQUFBQSxHQUFHLEVBQUU7QUFGVyxPQUFELENBQWpC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QUFDRixLQUpEO0FBS0QsR0FURCxFQVNHLENBQUMzRCxFQUFELEVBQUsyRCxXQUFMLEVBQWtCRCxPQUFsQixDQVRIO0FBVUQiLCJzb3VyY2VzQ29udGVudCI6WyJpbXBvcnQge1xuICB1c2VDYWxsYmFjaywgdXNlU3RhdGUsIHVzZUVmZmVjdCxcbn0gZnJvbSAncmVhY3QnO1xuXG5leHBvcnQgZnVuY3Rpb24gdXNlRml4Q3Vyc29yT25OZXdMaW5lKGVsKSB7XG4gIGNvbnN0IFtzYXZlZFNlbGVjdGlvbiwgc2V0U2F2ZWRTZWxlY3Rpb25dID0gdXNlU3RhdGUobnVsbCk7XG5cbiAgY29uc3Qgc2F2ZVNlbGVjdGlvbiA9IHVzZUNhbGxiYWNrKGZ1bmN0aW9uIChjb250YWluZXJFbCkge1xuICAgIGlmICh3aW5kb3cuZ2V0U2VsZWN0aW9uKCkucmFuZ2VDb3VudCA+IDApIHtcbiAgICAgIGNvbnN0IHJhbmdlID0gd2luZG93LmdldFNlbGVjdGlvbigpLmdldFJhbmdlQXQoMCk7XG4gICAgICBjb25zdCBwcmVTZWxlY3Rpb25SYW5nZSA9IHJhbmdlLmNsb25lUmFuZ2UoKTtcbiAgICAgIHByZVNlbGVjdGlvblJhbmdlLnNlbGVjdE5vZGVDb250ZW50cyhjb250YWluZXJFbCk7XG4gICAgICBwcmVTZWxlY3Rpb25SYW5nZS5zZXRFbmQocmFuZ2Uuc3RhcnRDb250YWluZXIsIHJhbmdlLnN0YXJ0T2Zmc2V0KTtcbiAgICAgIGNvbnN0IHN0YXJ0ID0gcHJlU2VsZWN0aW9uUmFuZ2UudG9TdHJpbmcoKS5sZW5ndGg7XG5cbiAgICAgIC8qKiBBZGRpbmcgcGx1cyBvbmUgdG8gYWNjb3VudCBmb3IgbmV3bGluZSAqL1xuICAgICAgc2V0U2F2ZWRTZWxlY3Rpb24oe1xuICAgICAgICBzdGFydDogc3RhcnQgKyAxLFxuICAgICAgICAvKiogQWRkaW5nIHBsdXMgb25lIHRvIGFjY291bnQgZm9yIG5ld2xpbmUgKi9cbiAgICAgICAgZW5kOiBzdGFydCArIHJhbmdlLnRvU3RyaW5nKCkubGVuZ3RoICsgMSxcbiAgICAgIH0pO1xuICAgIH0gZWxzZSB7XG4gICAgICBzZXRTYXZlZFNlbGVjdGlvbih7XG4gICAgICAgIHN0YXJ0OiAwLFxuICAgICAgICBlbmQ6IDAsXG4gICAgICB9KTtcbiAgICB9XG4gIH0sIFtdKTtcblxuICBjb25zdCByZXN0b3JlU2VsZWN0aW9uID0gdXNlQ2FsbGJhY2soZnVuY3Rpb24gKGNvbnRhaW5lckVsLCBfc2F2ZWRTZWxlY3Rpb24pIHtcbiAgICBsZXQgY2hhckluZGV4ID0gMCwgcmFuZ2UgPSBkb2N1bWVudC5jcmVhdGVSYW5nZSgpO1xuICAgIHJhbmdlLnNldFN0YXJ0KGNvbnRhaW5lckVsLCAwKTtcbiAgICByYW5nZS5jb2xsYXBzZSh0cnVlKTtcbiAgICBsZXQgbm9kZVN0YWNrID0gW2NvbnRhaW5lckVsXSwgbm9kZSwgZm91bmRTdGFydCA9IGZhbHNlLCBzdG9wID0gZmFsc2U7XG5cbiAgICB3aGlsZSAoIXN0b3AgJiYgKG5vZGUgPSBub2RlU3RhY2sucG9wKCkpKSB7XG4gICAgICBpZiAobm9kZS5ub2RlVHlwZSA9PSAzKSB7XG4gICAgICAgIGNvbnN0IG5leHRDaGFySW5kZXggPSBjaGFySW5kZXggKyBub2RlLmxlbmd0aDtcblxuICAgICAgICBpZiAoIWZvdW5kU3RhcnQgJiYgX3NhdmVkU2VsZWN0aW9uLnN0YXJ0ID49IGNoYXJJbmRleCAmJiBfc2F2ZWRTZWxlY3Rpb24uc3RhcnQgPD0gbmV4dENoYXJJbmRleCkge1xuICAgICAgICAgIHJhbmdlLnNldFN0YXJ0KG5vZGUsIF9zYXZlZFNlbGVjdGlvbi5zdGFydCAtIGNoYXJJbmRleCk7XG4gICAgICAgICAgZm91bmRTdGFydCA9IHRydWU7XG4gICAgICAgIH1cblxuICAgICAgICBpZiAoZm91bmRTdGFydCAmJiBfc2F2ZWRTZWxlY3Rpb24uZW5kID49IGNoYXJJbmRleCAmJiBfc2F2ZWRTZWxlY3Rpb24uZW5kIDw9IG5leHRDaGFySW5kZXgpIHtcbiAgICAgICAgICByYW5nZS5zZXRFbmQobm9kZSwgX3NhdmVkU2VsZWN0aW9uLmVuZCAtIGNoYXJJbmRleCk7XG4gICAgICAgICAgc3RvcCA9IHRydWU7XG4gICAgICAgIH1cbiAgICAgICAgY2hhckluZGV4ID0gbmV4dENoYXJJbmRleDtcbiAgICAgIH0gZWxzZSB7XG4gICAgICAgIGxldCBpID0gbm9kZS5jaGlsZE5vZGVzLmxlbmd0aDtcblxuICAgICAgICB3aGlsZSAoaS0tKSB7XG4gICAgICAgICAgbm9kZVN0YWNrLnB1c2gobm9kZS5jaGlsZE5vZGVzW2ldKTtcbiAgICAgICAgfVxuICAgICAgfVxuICAgIH1cblxuICAgIGNvbnN0IHNlbCA9IHdpbmRvdy5nZXRTZWxlY3Rpb24oKTtcbiAgICBzZWwucmVtb3ZlQWxsUmFuZ2VzKCk7XG4gICAgc2VsLmFkZFJhbmdlKHJhbmdlKTtcbiAgfSwgW10pO1xuXG4gIGNvbnN0IGhhbmRsZVJlc3RvcmUgPSB1c2VDYWxsYmFjaygoZSkgPT57XG4gICAgLyoqIE9ubHkgbGlzdGVuaW5nIGZvciBuZXdsaW5lIGtleSBjaGFyYWN0ZXIgY29kZSAqL1xuICAgIGlmIChlLmtleUNvZGUgPT09IDEzKSB7XG4gICAgICByZXN0b3JlU2VsZWN0aW9uKGVsLCBzYXZlZFNlbGVjdGlvbik7XG4gICAgfVxuICB9LCBbZWwsIHJlc3RvcmVTZWxlY3Rpb24sIHNhdmVkU2VsZWN0aW9uXSk7XG5cbiAgY29uc3QgaGFuZGxlU2F2ZVNlbGVjdGlvbiA9IHVzZUNhbGxiYWNrKCgpID0+IHtcbiAgICBzYXZlU2VsZWN0aW9uKGVsKTtcbiAgfSwgW2VsLCBzYXZlU2VsZWN0aW9uXSk7XG5cbiAgdXNlRWZmZWN0KCgpID0+IHtcbiAgICBpZiAoZWwpIHtcbiAgICAgIGVsLmFkZEV2ZW50TGlzdGVuZXIoJ2tleXVwJywgaGFuZGxlUmVzdG9yZSk7XG4gICAgICBlbC5hZGRFdmVudExpc3RlbmVyKCdrZXlkb3duJywgaGFuZGxlU2F2ZVNlbGVjdGlvbik7XG4gICAgfTtcbiAgICByZXR1cm4gKCkgPT4ge1xuICAgICAgaWYgKGVsKSB7XG4gICAgICAgIGVsLnJlbW92ZUV2ZW50TGlzdGVuZXIoJ2tleXVwJywgaGFuZGxlUmVzdG9yZSk7XG4gICAgICAgIGVsLmFkZEV2ZW50TGlzdGVuZXIoJ2tleWRvd24nLCBoYW5kbGVTYXZlU2VsZWN0aW9uKTtcbiAgICAgIH1cbiAgICB9O1xuICB9LCBbZWwsIGhhbmRsZVJlc3RvcmUsIGhhbmRsZVNhdmVTZWxlY3Rpb24sIHJlc3RvcmVTZWxlY3Rpb24sIHNhdmVTZWxlY3Rpb25dKTtcbn1cblxuZXhwb3J0IGZ1bmN0aW9uIHVzZUhhbmRsZVVuZG8oZWwsIGluaXRpYWxTdGF0ZSkge1xuICBjb25zdCBbbGFzdFZhbHVlcywgc2V0TGFzdFZhbHVlc10gPSB1c2VTdGF0ZShbaW5pdGlhbFN0YXRlXSk7XG4gIGNvbnN0IGhhbmRsZVVuZG8gPSB1c2VDYWxsYmFjaygoZSkgPT4ge1xuICAgIGlmIChlLm1ldGFLZXkgJiYgZS5rZXkgPT09ICd6JyAmJiBsYXN0VmFsdWVzLmxlbmd0aCkge1xuICAgICAgZS50YXJnZXQuaW5uZXJIVE1MID0gbGFzdFZhbHVlcy5wb3AoKTtcbiAgICB9XG5cbiAgICBpZiAoIWUubWV0YUtleSB8fCAoZS5tZXRhS2V5ICYmIGUua2V5ID09PSAndicpKSB7XG4gICAgICBjb25zdCBjb3B5ID0gbGFzdFZhbHVlcy5zbGljZSgwKTtcbiAgICAgIGNvcHkucHVzaChlLnRhcmdldC5pbm5lckhUTUwpO1xuICAgICAgc2V0TGFzdFZhbHVlcyhjb3B5KTtcbiAgICB9XG4gIH0sIFtsYXN0VmFsdWVzXSk7XG5cbiAgdXNlRWZmZWN0KCgpID0+IHtcbiAgICBpZiAoZWwpIHtcbiAgICAgIGVsLmFkZEV2ZW50TGlzdGVuZXIoJ2tleWRvd24nLCBoYW5kbGVVbmRvKTtcbiAgICB9O1xuICAgIHJldHVybiAoKSA9PiB7XG4gICAgICBpZiAoZWwpIHtcbiAgICAgICAgZWwucmVtb3ZlRXZlbnRMaXN0ZW5lcigna2V5ZG93bicsIGhhbmRsZVVuZG8pO1xuICAgICAgfVxuICAgIH07XG4gIH0sIFtlbCwgaGFuZGxlVW5kb10pO1xufVxuXG5leHBvcnQgZnVuY3Rpb24gdXNlSGFuZGxlUGFzdGUoZWwsIHByZXZpZXcpIHtcbiAgY29uc3QgaGFuZGxlUGFzdGUgPSB1c2VDYWxsYmFjaygoZSkgPT4ge1xuICAgIGUucHJldmVudERlZmF1bHQoKTtcbiAgICBjb25zdCBwYXN0ZWREYXRhID0gZS5jbGlwYm9hcmREYXRhLmdldERhdGEoJ3RleHQvcGxhaW4nKTtcbiAgICBjb25zdCBkb2MgPSBuZXcgRE9NUGFyc2VyKCkucGFyc2VGcm9tU3RyaW5nKHBhc3RlZERhdGEsICd0ZXh0L2h0bWwnKTtcbiAgICBjb25zdCB0ZXh0ID0gZG9jLmJvZHkudGV4dENvbnRlbnQgfHwgJyc7XG4gICAgZG9jdW1lbnQuZXhlY0NvbW1hbmQoJ2luc2VydEhUTUwnLCBmYWxzZSwgdGV4dCk7XG4gIH0sIFtdKTtcblxuICB1c2VFZmZlY3QoKCkgPT4ge1xuICAgIGlmIChlbCkge1xuICAgICAgZWwuYWRkRXZlbnRMaXN0ZW5lcigncGFzdGUnLCBoYW5kbGVQYXN0ZSk7XG4gICAgfTtcbiAgICByZXR1cm4gKCkgPT4ge1xuICAgICAgaWYgKGVsKSB7XG4gICAgICAgIGVsLnJlbW92ZUV2ZW50TGlzdGVuZXIoJ3Bhc3RlJywgaGFuZGxlUGFzdGUpO1xuICAgICAgfVxuICAgIH07XG4gIH0sIFtlbCwgaGFuZGxlUGFzdGUsIHByZXZpZXddKTtcbn0iXX0=