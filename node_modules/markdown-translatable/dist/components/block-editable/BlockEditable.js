"use strict";

function _typeof(obj) { "@babel/helpers - typeof"; if (typeof Symbol === "function" && typeof Symbol.iterator === "symbol") { _typeof = function _typeof(obj) { return typeof obj; }; } else { _typeof = function _typeof(obj) { return obj && typeof Symbol === "function" && obj.constructor === Symbol && obj !== Symbol.prototype ? "symbol" : typeof obj; }; } return _typeof(obj); }

Object.defineProperty(exports, "__esModule", {
  value: true
});
exports.default = BlockEditable;

var _react = _interopRequireWildcard(require("react"));

var _propTypes = _interopRequireDefault(require("prop-types"));

var _core = require("../../core/");

var _Markdown = require("../Markdown.context");

var _useStyles = require("./useStyles");

function _interopRequireDefault(obj) { return obj && obj.__esModule ? obj : { default: obj }; }

function _getRequireWildcardCache() { if (typeof WeakMap !== "function") return null; var cache = new WeakMap(); _getRequireWildcardCache = function _getRequireWildcardCache() { return cache; }; return cache; }

function _interopRequireWildcard(obj) { if (obj && obj.__esModule) { return obj; } if (obj === null || _typeof(obj) !== "object" && typeof obj !== "function") { return { default: obj }; } var cache = _getRequireWildcardCache(); if (cache && cache.has(obj)) { return cache.get(obj); } var newObj = {}; var hasPropertyDescriptor = Object.defineProperty && Object.getOwnPropertyDescriptor; for (var key in obj) { if (Object.prototype.hasOwnProperty.call(obj, key)) { var desc = hasPropertyDescriptor ? Object.getOwnPropertyDescriptor(obj, key) : null; if (desc && (desc.get || desc.set)) { Object.defineProperty(newObj, key, desc); } else { newObj[key] = obj[key]; } } } newObj.default = obj; if (cache) { cache.set(obj, newObj); } return newObj; }

function ownKeys(object, enumerableOnly) { var keys = Object.keys(object); if (Object.getOwnPropertySymbols) { var symbols = Object.getOwnPropertySymbols(object); if (enumerableOnly) symbols = symbols.filter(function (sym) { return Object.getOwnPropertyDescriptor(object, sym).enumerable; }); keys.push.apply(keys, symbols); } return keys; }

function _objectSpread(target) { for (var i = 1; i < arguments.length; i++) { var source = arguments[i] != null ? arguments[i] : {}; if (i % 2) { ownKeys(Object(source), true).forEach(function (key) { _defineProperty(target, key, source[key]); }); } else if (Object.getOwnPropertyDescriptors) { Object.defineProperties(target, Object.getOwnPropertyDescriptors(source)); } else { ownKeys(Object(source)).forEach(function (key) { Object.defineProperty(target, key, Object.getOwnPropertyDescriptor(source, key)); }); } } return target; }

function _defineProperty(obj, key, value) { if (key in obj) { Object.defineProperty(obj, key, { value: value, enumerable: true, configurable: true, writable: true }); } else { obj[key] = value; } return obj; }

function BlockEditable(_ref) {
  var markdown = _ref.markdown,
      onEdit = _ref.onEdit,
      inputFilters = _ref.inputFilters,
      outputFilters = _ref.outputFilters,
      style = _ref.style,
      preview = _ref.preview,
      editable = _ref.editable,
      fontSize = _ref.fontSize;
  var classes = (0, _useStyles.useStyles)();

  var _useContext = (0, _react.useContext)(_Markdown.MarkdownContext),
      actions = _useContext.actions;

  var _oldMarkdown = {
    markdown: markdown
  };

  var _style = (0, _react.useMemo)(function () {
    return (0, _core.isHebrew)(markdown) ? _objectSpread(_objectSpread({}, style), {}, {
      fontSize: '1.5em'
    }) : style;
  }, [style, markdown]);

  var handleBlur = function handleBlur(_markdown) {
    var oldHTML = (0, _core.markdownToHtml)({
      markdown: _oldMarkdown.markdown,
      inputFilters: inputFilters
    });
    var newHTML = (0, _core.markdownToHtml)({
      markdown: _markdown,
      inputFilters: inputFilters
    }); // TODO: do we need to calculate HTML each time??

    if (oldHTML !== newHTML || _oldMarkdown.markdown !== _markdown) {
      _oldMarkdown.markdown = _markdown;
      onEdit(_markdown);
    }
  };

  var handleHTMLBlur = function handleHTMLBlur(e) {
    var html = e.target.innerHTML;

    var _markdown = (0, _core.htmlToMarkdown)({
      html: html,
      outputFilters: outputFilters
    });

    handleBlur(_markdown);
  };

  var handleRawBlur = function handleRawBlur(e) {
    var string = e.target.innerText;
    string = (0, _core.fromDisplay)(string);

    var _markdown = (0, _core.filter)({
      string: string,
      filters: outputFilters
    });

    handleBlur(_markdown);
  };

  var handleKeyPress = function handleKeyPress(keycode) {
    if (actions && actions.setIsChanged) {
      actions.setIsChanged(true);
    }
  };

  var handledKeyCodes = [8
  /*Delete/Backspace*/
  ];

  var handleKeyUp = function handleKeyUp(event) {
    if (actions && actions.setIsChanged) {
      if (handledKeyCodes.includes(event.keyCode)) {
        // NOTE: we don't want to convert HTML on key keyUp.
        // So we cant test for changes.
        actions.setIsChanged(true);
      }
    }
  };

  var handleCutPaste = function handleCutPaste() {
    if (actions && actions.setIsChanged) {
      actions.setIsChanged(true);
    }

    if (actions && actions.setIsAutoSaveChanged) {
      actions.setIsAutoSaveChanged(true);
    }
  };

  return /*#__PURE__*/_react.default.createElement("div", {
    className: classes.root
  }, !preview ? /*#__PURE__*/_react.default.createElement(RawMarkdown, {
    _style: _style,
    classes: classes,
    fontSize: fontSize,
    markdown: markdown,
    editable: editable,
    handleKeyUp: handleKeyUp,
    inputFilters: inputFilters,
    handleRawBlur: handleRawBlur,
    handleKeyPress: handleKeyPress,
    handleCutPaste: handleCutPaste
  }) : /*#__PURE__*/_react.default.createElement("div", {
    style: _objectSpread(_objectSpread({}, _style), {}, {
      fontSize: fontSize
    }),
    className: classes.html,
    dir: "auto",
    contentEditable: editable,
    onBlur: handleHTMLBlur,
    onKeyPress: handleKeyPress,
    onKeyUp: handleKeyUp,
    onCut: handleCutPaste,
    onPaste: handleCutPaste,
    dangerouslySetInnerHTML: {
      __html: (0, _core.markdownToHtml)({
        markdown: markdown,
        inputFilters: inputFilters
      })
    }
  }));
}

BlockEditable.propTypes = {
  /** Initial markdown for the editor. */
  markdown: _propTypes.default.string.isRequired,

  /** Function to propogate changes to the markdown. */
  onEdit: _propTypes.default.func,

  /** Replace strings before rendering. */
  inputFilters: _propTypes.default.array,

  /** Replace strings after editing. */
  outputFilters: _propTypes.default.array,

  /** CSS for the component. */
  style: _propTypes.default.object,

  /** Display Raw Markdown or HTML. */
  preview: _propTypes.default.bool,

  /** Enable/Disable editability. */
  editable: _propTypes.default.bool,

  /** fontSize e.g. '100%' */
  fontSize: _propTypes.default.string
};
BlockEditable.defaultProps = {
  markdown: '',
  onEdit: function onEdit() {},
  inputFilters: [],
  outputFilters: [],
  style: {},
  preview: true,
  editable: true
};

var RawMarkdown = function RawMarkdown(_ref2) {
  var _style = _ref2._style,
      classes = _ref2.classes,
      fontSize = _ref2.fontSize,
      markdown = _ref2.markdown,
      editable = _ref2.editable,
      handleKeyUp = _ref2.handleKeyUp,
      inputFilters = _ref2.inputFilters,
      handleRawBlur = _ref2.handleRawBlur,
      handleKeyPress = _ref2.handleKeyPress,
      handleCutPaste = _ref2.handleCutPaste;
  var code = (0, _core.filter)({
    string: markdown,
    filters: inputFilters
  });
  code = (0, _core.toDisplay)(code);
  var dangerouslySetInnerHTML = {
    __html: code
  };
  return /*#__PURE__*/_react.default.createElement("pre", {
    className: classes.pre
  }, /*#__PURE__*/_react.default.createElement("code", {
    className: classes.markdown,
    style: _objectSpread(_objectSpread({}, _style), {}, {
      fontSize: fontSize
    }),
    dir: "auto",
    contentEditable: editable,
    dangerouslySetInnerHTML: dangerouslySetInnerHTML,
    onBlur: handleRawBlur,
    onKeyPress: handleKeyPress,
    onKeyUp: handleKeyUp,
    onCut: handleCutPaste,
    onPaste: handleCutPaste
  }));
};

RawMarkdown.propTypes = {
  /** CSS for the component. */
  _style: _propTypes.default.object,

  /** CSS classes for the component. */
  classes: _propTypes.default.object,

  /** fontSize e.g. '100%' */
  fontSize: _propTypes.default.string,

  /** Initial markdown for the editor. */
  markdown: _propTypes.default.string.isRequired,

  /** Enable/Disable editability. */
  editable: _propTypes.default.bool,

  /** Function to handle Key Up. */
  handleKeyUp: _propTypes.default.func,

  /** Replace strings before rendering. */
  inputFilters: _propTypes.default.array,

  /** Function to handle raw on blur. */
  handleRawBlur: _propTypes.default.func,

  /** Function to handle key pres. */
  handleKeyPress: _propTypes.default.func,

  /** Function to handle cur & paste. */
  handleCutPaste: _propTypes.default.func
};
//# sourceMappingURL=data:application/json;charset=utf-8;base64,eyJ2ZXJzaW9uIjozLCJzb3VyY2VzIjpbIi4uLy4uLy4uL3NyYy9jb21wb25lbnRzL2Jsb2NrLWVkaXRhYmxlL0Jsb2NrRWRpdGFibGUuanMiXSwibmFtZXMiOlsiQmxvY2tFZGl0YWJsZSIsIm1hcmtkb3duIiwib25FZGl0IiwiaW5wdXRGaWx0ZXJzIiwib3V0cHV0RmlsdGVycyIsInN0eWxlIiwicHJldmlldyIsImVkaXRhYmxlIiwiZm9udFNpemUiLCJjbGFzc2VzIiwiTWFya2Rvd25Db250ZXh0IiwiYWN0aW9ucyIsIl9vbGRNYXJrZG93biIsIl9zdHlsZSIsImhhbmRsZUJsdXIiLCJfbWFya2Rvd24iLCJvbGRIVE1MIiwibmV3SFRNTCIsImhhbmRsZUhUTUxCbHVyIiwiZSIsImh0bWwiLCJ0YXJnZXQiLCJpbm5lckhUTUwiLCJoYW5kbGVSYXdCbHVyIiwic3RyaW5nIiwiaW5uZXJUZXh0IiwiZmlsdGVycyIsImhhbmRsZUtleVByZXNzIiwia2V5Y29kZSIsInNldElzQ2hhbmdlZCIsImhhbmRsZWRLZXlDb2RlcyIsImhhbmRsZUtleVVwIiwiZXZlbnQiLCJpbmNsdWRlcyIsImtleUNvZGUiLCJoYW5kbGVDdXRQYXN0ZSIsInNldElzQXV0b1NhdmVDaGFuZ2VkIiwicm9vdCIsIl9faHRtbCIsInByb3BUeXBlcyIsIlByb3BUeXBlcyIsImlzUmVxdWlyZWQiLCJmdW5jIiwiYXJyYXkiLCJvYmplY3QiLCJib29sIiwiZGVmYXVsdFByb3BzIiwiUmF3TWFya2Rvd24iLCJjb2RlIiwiZGFuZ2Vyb3VzbHlTZXRJbm5lckhUTUwiLCJwcmUiXSwibWFwcGluZ3MiOiI7Ozs7Ozs7OztBQUFBOztBQUNBOztBQUNBOztBQVFBOztBQUNBOzs7Ozs7Ozs7Ozs7OztBQUVlLFNBQVNBLGFBQVQsT0FTWjtBQUFBLE1BUkRDLFFBUUMsUUFSREEsUUFRQztBQUFBLE1BUERDLE1BT0MsUUFQREEsTUFPQztBQUFBLE1BTkRDLFlBTUMsUUFOREEsWUFNQztBQUFBLE1BTERDLGFBS0MsUUFMREEsYUFLQztBQUFBLE1BSkRD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QUFRLEVBQUVnQyxtQkFBVWhCLE1BTkU7O0FBT3RCO0FBQ0F2QixFQUFBQSxRQUFRLEVBQUV1QyxtQkFBVWhCLE1BQVYsQ0FBaUJpQixVQVJMOztBQVN0QjtBQUNBbEMsRUFBQUEsUUFBUSxFQUFFaUMsbUJBQVVLLElBVkU7O0FBV3RCO0FBQ0FkLEVBQUFBLFdBQVcsRUFBRVMsbUJBQVVFLElBWkQ7O0FBYXRCO0FBQ0F2QyxFQUFBQSxZQUFZLEVBQUVxQyxtQkFBVUcsS0FkRjs7QUFldEI7QUFDQXBCLEVBQUFBLGFBQWEsRUFBRWlCLG1CQUFVRSxJQWhCSDs7QUFpQnRCO0FBQ0FmLEVBQUFBLGNBQWMsRUFBRWEsbUJBQVVFLElBbEJKOztBQW1CdEI7QUFDQVAsRUFBQUEsY0FBYyxFQUFFSyxtQkFBVUU7QUFwQkosQ0FBeEIiLCJzb3VyY2VzQ29udGVudCI6WyJpbXBvcnQgUmVhY3QsIHsgdXNlTWVtbywgdXNlQ29udGV4dCB9IGZyb20gJ3JlYWN0JztcbmltcG9ydCBQcm9wVHlwZXMgZnJvbSAncHJvcC10eXBlcyc7XG5pbXBvcnQge1xuICBtYXJrZG93blRvSHRtbCxcbiAgaHRtbFRvTWFya2Rvd24sXG4gIGZyb21EaXNwbGF5LFxuICB0b0Rpc3BsYXksXG4gIGlzSGVicmV3LFxuICBmaWx0ZXIsXG59IGZyb20gJy4uLy4uL2NvcmUvJztcbmltcG9ydCB7IE1hcmtkb3duQ29udGV4dCB9IGZyb20gJy4uL01hcmtkb3duLmNvbnRleHQnO1xuaW1wb3J0IHsgdXNlU3R5bGVzIH0gZnJvbSAnLi91c2VTdHlsZXMnO1xuXG5leHBvcnQgZGVmYXVsdCBmdW5jdGlvbiBCbG9ja0VkaXRhYmxlKHtcbiAgbWFya2Rvd24sXG4gIG9uRWRpdCxcbiAgaW5wdXRGaWx0ZXJzLFxuICBvdXRwdXRGaWx0ZXJzLFxuICBzdHlsZSxcbiAgcHJldmlldyxcbiAgZWRpdGFibGUsXG4gIGZvbnRTaXplLFxufSkge1xuICBjb25zdCBjbGFzc2VzID0gdXNlU3R5bGVzKCk7XG4gIGNvbnN0IHsgYWN0aW9ucyB9ID0gdXNlQ29udGV4dChNYXJrZG93bkNvbnRleHQpO1xuICBjb25zdCBfb2xkTWFya2Rvd24gPSB7IG1hcmtkb3duIH07XG5cbiAgY29uc3QgX3N0eWxlID0gdXNlTWVtbyhcbiAgICAoKSA9PlxuICAgICAgaXNIZWJyZXcobWFya2Rvd24pID8geyAuLi5zdHlsZSwgZm9udFNpemU6ICcxLjVlbScgfSA6IHN0eWxlLFxuICAgIFtzdHlsZSwgbWFya2Rvd25dXG4gICk7XG5cbiAgY29uc3QgaGFuZGxlQmx1ciA9IChfbWFya2Rvd24pID0+IHtcbiAgICBjb25zdCBvbGRIVE1MID0gbWFya2Rvd25Ub0h0bWwoe1xuICAgICAgbWFya2Rvd246IF9vbGRNYXJrZG93bi5tYXJrZG93bixcbiAgICAgIGlucHV0RmlsdGVyczogaW5wdXRGaWx0ZXJzLFxuICAgIH0pO1xuICAgIGNvbnN0IG5ld0hUTUwgPSBtYXJrZG93blRvSHRtbCh7XG4gICAgICBtYXJrZG93bjogX21hcmtkb3duLFxuICAgICAgaW5wdXRGaWx0ZXJzOiBpbnB1dEZpbHRlcnMsXG4gICAgfSk7XG5cbiAgICAvLyBUT0RPOiBkbyB3ZSBuZWVkIHRvIGNhbGN1bGF0ZSBIVE1MIGVhY2ggdGltZT8/XG4gICAgaWYgKG9sZEhUTUwgIT09IG5ld0hUTUwgfHwgX29sZE1hcmtkb3duLm1hcmtkb3duICE9PSBfbWFya2Rvd24pIHtcbiAgICAgIF9vbGRNYXJrZG93bi5tYXJrZG93biA9IF9tYXJrZG93bjtcbiAgICAgIG9uRWRpdChfbWFya2Rvd24pO1xuICAgIH1cbiAgfTtcblxuICBjb25zdCBoYW5kbGVIVE1MQmx1ciA9IChlKSA9PiB7XG4gICAgY29uc3QgaHRtbCA9IGUudGFyZ2V0LmlubmVySFRNTDtcbiAgICBjb25zdCBfbWFya2Rvd24gPSBodG1sVG9NYXJrZG93bih7IGh0bWwsIG91dHB1dEZpbHRlcnMgfSk7XG4gICAgaGFuZGxlQmx1cihfbWFya2Rvd24pO1xuICB9O1xuXG4gIGNvbnN0IGhhbmRsZVJhd0JsdXIgPSAoZSkgPT4ge1xuICAgIGxldCBzdHJpbmcgPSBlLnRhcmdldC5pbm5lclRleHQ7XG4gICAgc3RyaW5nID0gZnJvbURpc3BsYXkoc3RyaW5nKTtcbiAgICBjb25zdCBfbWFya2Rvd24gPSBmaWx0ZXIoeyBzdHJpbmcsIGZpbHRlcnM6IG91dHB1dEZpbHRlcnMgfSk7XG4gICAgaGFuZGxlQmx1cihfbWFya2Rvd24pO1xuICB9O1xuXG4gIGNvbnN0IGhhbmRsZUtleVByZXNzID0gKGtleWNvZGUpID0+IHtcbiAgICBpZiAoYWN0aW9ucyAmJiBhY3Rpb25zLnNldElzQ2hhbmdlZCkge1xuICAgICAgYWN0aW9ucy5zZXRJc0NoYW5nZWQodHJ1ZSk7XG4gICAgfVxuICB9O1xuXG4gIGNvbnN0IGhhbmRsZWRLZXlDb2RlcyA9IFs4LypEZWxldGUvQmFja3NwYWNlKi9dO1xuXG4gIGNvbnN0IGhhbmRsZUtleVVwID0gKGV2ZW50KSA9PiB7XG4gICAgaWYgKGFjdGlvbnMgJiYgYWN0aW9ucy5zZXRJc0NoYW5nZWQpIHtcbiAgICAgIGlmIChoYW5kbGVkS2V5Q29kZXMuaW5jbHVkZXMoZXZlbnQua2V5Q29kZSkpIHtcbiAgICAgICAgLy8gTk9URTogd2UgZG9uJ3Qgd2FudCB0byBjb252ZXJ0IEhUTUwgb24ga2V5IGtleVVwLlxuICAgICAgICAvLyBTbyB3ZSBjYW50IHRlc3QgZm9yIGNoYW5nZXMuXG4gICAgICAgIGFjdGlvbnMuc2V0SXNDaGFuZ2VkKHRydWUpO1xuICAgICAgfVxuICAgIH1cbiAgfTtcblxuICBjb25zdCBoYW5kbGVDdXRQYXN0ZSA9ICgpID0+IHtcbiAgICBpZiAoYWN0aW9ucyAmJiBhY3Rpb25zLnNldElzQ2hhbmdlZCkge1xuICAgICAgYWN0aW9ucy5zZXRJc0NoYW5nZWQodHJ1ZSk7XG4gICAgfVxuXG4gICAgaWYgKGFjdGlvbnMgJiYgYWN0aW9ucy5zZXRJc0F1dG9TYXZlQ2hhbmdlZCkge1xuICAgICAgYWN0aW9ucy5zZXRJc0F1dG9TYXZlQ2hhbmdlZCh0cnVlKTtcbiAgICB9XG4gIH07XG5cbiAgcmV0dXJuIChcbiAgICA8ZGl2IGNsYXNzTmFtZT17Y2xhc3Nlcy5yb290fT5cbiAgICAgIHtcbiAgICAgICAgIXByZXZpZXcgP1xuICAgICAgICAgIDxSYXdNYXJrZG93blxuICAgICAgICAgICAgX3N0eWxlPXtfc3R5bGV9XG4gICAgICAgICAgICBjbGFzc2VzPXtjbGFzc2VzfVxuICAgICAgICAgICAgZm9udFNpemU9e2ZvbnRTaXplfVxuICAgICAgICAgICAgbWFya2Rvd249e21hcmtkb3dufVxuICAgICAgICAgICAgZWRpdGFibGU9e2VkaXRhYmxlfVxuICAgICAgICAgICAgaGFuZGxlS2V5VXA9e2hhbmRsZUtleVVwfVxuICAgICAgICAgICAgaW5wdXRGaWx0ZXJzPXtpbnB1dEZpbHRlcnN9XG4gICAgICAgICAgICBoYW5kbGVSYXdCbHVyPXtoYW5kbGVSYXdCbHVyfVxuICAgICAgICAgICAgaGFuZGxlS2V5UHJlc3M9e2hhbmRsZUtleVByZXNzfVxuICAgICAgICAgICAgaGFuZGxlQ3V0UGFzdGU9e2hhbmRsZUN1dFBhc3RlfVxuICAgICAgICAgIC8+XG4gICAgICAgICAgOlxuICAgICAgICAgIDxkaXZcbiAgICAgICAgICAgIHN0eWxlPXt7IC4uLl9zdHlsZSwgZm9udFNpemUgfX1cbiAgICAgICAgICAgIGNsYXNzTmFtZT17Y2xhc3Nlcy5odG1sfVxuICAgICAgICAgICAgZGlyPSdhdXRvJ1xuICAgICAgICAgICAgY29udGVudEVkaXRhYmxlPXtlZGl0YWJsZX1cbiAgICAgICAgICAgIG9uQmx1cj17aGFuZGxlSFRNTEJsdXJ9XG4gICAgICAgICAgICBvbktleVByZXNzPXtoYW5kbGVLZXlQcmVzc31cbiAgICAgICAgICAgIG9uS2V5VXA9e2hhbmRsZUtleVVwfVxuICAgICAgICAgICAgb25DdXQ9e2hhbmRsZUN1dFBhc3RlfVxuICAgICAgICAgICAgb25QYXN0ZT17aGFuZGxlQ3V0UGFzdGV9XG4gICAgICAgICAgICBkYW5nZXJvdXNseVNldElubmVySFRNTD17eyBfX2h0bWw6IG1hcmtkb3duVG9IdG1sKHsgbWFya2Rvd24sIGlucHV0RmlsdGVycyB9KSB9fVxuICAgICAgICAgIC8+XG4gICAgICB9XG4gICAgPC9kaXY+XG4gICk7XG59XG5cbkJsb2NrRWRpdGFibGUucHJvcFR5cGVzID0ge1xuICAvKiogSW5pdGlhbCBtYXJrZG93biBmb3IgdGhlIGVkaXRvci4gKi9cbiAgbWFya2Rvd246IFByb3BUeXBlcy5zdHJpbmcuaXNSZXF1aXJlZCxcbiAgLyoqIEZ1bmN0aW9uIHRvIHByb3BvZ2F0ZSBjaGFuZ2VzIHRvIHRoZSBtYXJrZG93bi4gKi9cbiAgb25FZGl0OiBQcm9wVHlwZXMuZnVuYyxcbiAgLyoqIFJlcGxhY2Ugc3RyaW5ncyBiZWZvcmUgcmVuZGVyaW5nLiAqL1xuICBpbnB1dEZpbHRlcnM6IFByb3BUeXBlcy5hcnJheSxcbiAgLyoqIFJlcGxhY2Ugc3RyaW5ncyBhZnRlciBlZGl0aW5nLiAqL1xuICBvdXRwdXRGaWx0ZXJzOiBQcm9wVHlwZXMuYXJyYXksXG4gIC8qKiBDU1MgZm9yIHRoZSBjb21wb25lbnQuICovXG4gIHN0eWxlOiBQcm9wVHlwZXMub2JqZWN0LFxuICAvKiogRGlzcGxheSBSYXcgTWFya2Rvd24gb3IgSFRNTC4gKi9cbiAgcHJldmlldzogUHJvcFR5cGVzLmJvb2wsXG4gIC8qKiBFbmFibGUvRGlzYWJsZSBlZGl0YWJpbGl0eS4gKi9cbiAgZWRpdGFibGU6IFByb3BUeXBlcy5ib29sLFxuICAvKiogZm9udFNpemUgZS5nLiAnMTAwJScgKi9cbiAgZm9udFNpemU6IFByb3BUeXBlcy5zdHJpbmcsXG59O1xuXG5CbG9ja0VkaXRhYmxlLmRlZmF1bHRQcm9wcyA9IHtcbiAgbWFya2Rvd246ICcnLFxuICBvbkVkaXQ6ICgpID0+IHsgfSxcbiAgaW5wdXRGaWx0ZXJzOiBbXSxcbiAgb3V0cHV0RmlsdGVyczogW10sXG4gIHN0eWxlOiB7fSxcbiAgcHJldmlldzogdHJ1ZSxcbiAgZWRpdGFibGU6IHRydWUsXG59O1xuXG5jb25zdCBSYXdNYXJrZG93biA9ICh7XG4gIF9zdHlsZSxcbiAgY2xhc3NlcyxcbiAgZm9udFNpemUsXG4gIG1hcmtkb3duLFxuICBlZGl0YWJsZSxcbiAgaGFuZGxlS2V5VXAsXG4gIGlucHV0RmlsdGVycyxcbiAgaGFuZGxlUmF3Qmx1cixcbiAgaGFuZGxlS2V5UHJlc3MsXG4gIGhhbmRsZUN1dFBhc3RlLFxufSkgPT4ge1xuICBsZXQgY29kZSA9IGZpbHRlcih7IHN0cmluZzogbWFya2Rvd24sIGZpbHRlcnM6IGlucHV0RmlsdGVycyB9KTtcbiAgY29kZSA9IHRvRGlzcGxheShjb2RlKTtcbiAgY29uc3QgZGFuZ2Vyb3VzbHlTZXRJbm5lckhUTUwgPSB7IF9faHRtbDogY29kZSB9O1xuXG4gIHJldHVybiAoXG4gICAgPHByZSBjbGFzc05hbWU9e2NsYXNzZXMucHJlfT5cbiAgICAgIDxjb2RlXG4gICAgICAgIGNsYXNzTmFtZT17Y2xhc3Nlcy5tYXJrZG93bn1cbiAgICAgICAgc3R5bGU9e3sgLi4uX3N0eWxlLCBmb250U2l6ZSB9fVxuICAgICAgICBkaXI9J2F1dG8nXG4gICAgICAgIGNvbnRlbnRFZGl0YWJsZT17ZWRpdGFibGV9XG4gICAgICAgIGRhbmdlcm91c2x5U2V0SW5uZXJIVE1MPXtkYW5nZXJvdXNseVNldElubmVySFRNTH1cbiAgICAgICAgb25CbHVyPXtoYW5kbGVSYXdCbHVyfVxuICAgICAgICBvbktleVByZXNzPXtoYW5kbGVLZXlQcmVzc31cbiAgICAgICAgb25LZXlVcD17aGFuZGxlS2V5VXB9XG4gICAgICAgIG9uQ3V0PXtoYW5kbGVDdXRQYXN0ZX1cbiAgICAgICAgb25QYXN0ZT17aGFuZGxlQ3V0UGFzdGV9XG4gICAgICAvPlxuICAgIDwvcHJlPlxuICApO1xufTtcblxuUmF3TWFya2Rvd24ucHJvcFR5cGVzID0ge1xuICAvKiogQ1NTIGZvciB0aGUgY29tcG9uZW50LiAqL1xuICBfc3R5bGU6IFByb3BUeXBlcy5vYmplY3QsXG4gIC8qKiBDU1MgY2xhc3NlcyBmb3IgdGhlIGNvbXBvbmVudC4gKi9cbiAgY2xhc3NlczogUHJvcFR5cGVzLm9iamVjdCxcbiAgLyoqIGZvbnRTaXplIGUuZy4gJzEwMCUnICovXG4gIGZvbnRTaXplOiBQcm9wVHlwZXMuc3RyaW5nLFxuICAvKiogSW5pdGlhbCBtYXJrZG93biBmb3IgdGhlIGVkaXRvci4gKi9cbiAgbWFya2Rvd246IFByb3BUeXBlcy5zdHJpbmcuaXNSZXF1aXJlZCxcbiAgLyoqIEVuYWJsZS9EaXNhYmxlIGVkaXRhYmlsaXR5LiAqL1xuICBlZGl0YWJsZTogUHJvcFR5cGVzLmJvb2wsXG4gIC8qKiBGdW5jdGlvbiB0byBoYW5kbGUgS2V5IFVwLiAqL1xuICBoYW5kbGVLZXlVcDogUHJvcFR5cGVzLmZ1bmMsXG4gIC8qKiBSZXBsYWNlIHN0cmluZ3MgYmVmb3JlIHJlbmRlcmluZy4gKi9cbiAgaW5wdXRGaWx0ZXJzOiBQcm9wVHlwZXMuYXJyYXksXG4gIC8qKiBGdW5jdGlvbiB0byBoYW5kbGUgcmF3IG9uIGJsdXIuICovXG4gIGhhbmRsZVJhd0JsdXI6IFByb3BUeXBlcy5mdW5jLFxuICAvKiogRnVuY3Rpb24gdG8gaGFuZGxlIGtleSBwcmVzLiAqL1xuICBoYW5kbGVLZXlQcmVzczogUHJvcFR5cGVzLmZ1bmMsXG4gIC8qKiBGdW5jdGlvbiB0byBoYW5kbGUgY3VyICYgcGFzdGUuICovXG4gIGhhbmRsZUN1dFBhc3RlOiBQcm9wVHlwZXMuZnVuYyxcbn07Il19