"use strict";

function _typeof(obj) { "@babel/helpers - typeof"; if (typeof Symbol === "function" && typeof Symbol.iterator === "symbol") { _typeof = function _typeof(obj) { return typeof obj; }; } else { _typeof = function _typeof(obj) { return obj && typeof Symbol === "function" && obj.constructor === Symbol && obj !== Symbol.prototype ? "symbol" : typeof obj; }; } return _typeof(obj); }

Object.defineProperty(exports, "__esModule", {
  value: true
});
exports.default = BlockEditable;

var _react = _interopRequireWildcard(require("react"));

var _propTypes = _interopRequireDefault(require("prop-types"));

var _core = require("../../core/");

var _Markdown = require("../Markdown.context");

var _useStyles = require("./useStyles");

function _interopRequireDefault(obj) { return obj && obj.__esModule ? obj : { default: obj }; }

function _getRequireWildcardCache() { if (typeof WeakMap !== "function") return null; var cache = new WeakMap(); _getRequireWildcardCache = function _getRequireWildcardCache() { return cache; }; return cache; }

function _interopRequireWildcard(obj) { if (obj && obj.__esModule) { return obj; } if (obj === null || _typeof(obj) !== "object" && typeof obj !== "function") { return { default: obj }; } var cache = _getRequireWildcardCache(); if (cache && cache.has(obj)) { return cache.get(obj); } var newObj = {}; var hasPropertyDescriptor = Object.defineProperty && Object.getOwnPropertyDescriptor; for (var key in obj) { if (Object.prototype.hasOwnProperty.call(obj, key)) { var desc = hasPropertyDescriptor ? Object.getOwnPropertyDescriptor(obj, key) : null; if (desc && (desc.get || desc.set)) { Object.defineProperty(newObj, key, desc); } else { newObj[key] = obj[key]; } } } newObj.default = obj; if (cache) { cache.set(obj, newObj); } return newObj; }

function ownKeys(object, enumerableOnly) { var keys = Object.keys(object); if (Object.getOwnPropertySymbols) { var symbols = Object.getOwnPropertySymbols(object); if (enumerableOnly) symbols = symbols.filter(function (sym) { return Object.getOwnPropertyDescriptor(object, sym).enumerable; }); keys.push.apply(keys, symbols); } return keys; }

function _objectSpread(target) { for (var i = 1; i < arguments.length; i++) { var source = arguments[i] != null ? arguments[i] : {}; if (i % 2) { ownKeys(Object(source), true).forEach(function (key) { _defineProperty(target, key, source[key]); }); } else if (Object.getOwnPropertyDescriptors) { Object.defineProperties(target, Object.getOwnPropertyDescriptors(source)); } else { ownKeys(Object(source)).forEach(function (key) { Object.defineProperty(target, key, Object.getOwnPropertyDescriptor(source, key)); }); } } return target; }

function _defineProperty(obj, key, value) { if (key in obj) { Object.defineProperty(obj, key, { value: value, enumerable: true, configurable: true, writable: true }); } else { obj[key] = value; } return obj; }

function BlockEditable(_ref) {
  var markdown = _ref.markdown,
      onEdit = _ref.onEdit,
      inputFilters = _ref.inputFilters,
      outputFilters = _ref.outputFilters,
      style = _ref.style,
      preview = _ref.preview,
      editable = _ref.editable,
      fontSize = _ref.fontSize;
  var classes = (0, _useStyles.useStyles)();

  var _useContext = (0, _react.useContext)(_Markdown.MarkdownContext),
      actions = _useContext.actions;

  var _oldMarkdown = {
    markdown: markdown
  };

  var _style = (0, _react.useMemo)(function () {
    return (0, _core.isHebrew)(markdown) ? _objectSpread(_objectSpread({}, style), {}, {
      fontSize: '1.5em'
    }) : style;
  }, [style, markdown]);

  var handleBlur = function handleBlur(_markdown) {
    var oldHTML = (0, _core.markdownToHtml)({
      markdown: _oldMarkdown.markdown,
      inputFilters: inputFilters
    });
    var newHTML = (0, _core.markdownToHtml)({
      markdown: _markdown,
      inputFilters: inputFilters
    }); // TODO: do we need to calculate HTML each time??

    if (oldHTML !== newHTML || _oldMarkdown.markdown !== _markdown) {
      _oldMarkdown.markdown = _markdown;
      onEdit(_markdown);
    }
  };

  var handleHTMLBlur = function handleHTMLBlur(e) {
    var html = e.target.innerHTML;

    var _markdown = (0, _core.htmlToMarkdown)({
      html: html,
      outputFilters: outputFilters
    });

    handleBlur(_markdown);
  };

  var handleRawBlur = function handleRawBlur(e) {
    var string = e.target.innerText;
    string = (0, _core.fromDisplay)(string);

    var _markdown = (0, _core.filter)({
      string: string,
      filters: outputFilters
    });

    handleBlur(_markdown);
  };

  var handleKeyPress = function handleKeyPress(keycode) {
    if (actions && actions.setIsChanged) {
      actions.setIsChanged(true);
    }
  };

  var handledKeyCodes = [8
  /*Delete/Backspace*/
  ];

  var handleKeyUp = function handleKeyUp(event) {
    if (actions && actions.setIsChanged) {
      if (handledKeyCodes.includes(event.keyCode)) {
        // NOTE: we don't want to convert HTML on key keyUp.
        // So we cant test for changes.
        actions.setIsChanged(true);
      }
    }
  };

  var handleCutPaste = function handleCutPaste() {
    if (actions && actions.setIsChanged) {
      actions.setIsChanged(true);
    }

    if (actions && actions.setIsAutoSaveChanged) {
      actions.setIsAutoSaveChanged(true);
    }
  };

  return /*#__PURE__*/_react.default.createElement("div", {
    className: classes.root
  }, !preview ? /*#__PURE__*/_react.default.createElement(RawMarkdown, {
    _style: _style,
    classes: classes,
    fontSize: fontSize,
    markdown: markdown,
    editable: editable,
    handleKeyUp: handleKeyUp,
    inputFilters: inputFilters,
    handleRawBlur: handleRawBlur,
    handleKeyPress: handleKeyPress,
    handleCutPaste: handleCutPaste
  }) : /*#__PURE__*/_react.default.createElement("div", {
    style: _objectSpread(_objectSpread({}, _style), {}, {
      fontSize: fontSize
    }),
    className: classes.html,
    dir: "auto",
    contentEditable: editable,
    onBlur: handleHTMLBlur,
    onKeyPress: handleKeyPress,
    onKeyUp: handleKeyUp,
    onCut: handleCutPaste,
    onPaste: handleCutPaste,
    dangerouslySetInnerHTML: {
      __html: (0, _core.markdownToHtml)({
        markdown: markdown,
        inputFilters: inputFilters
      })
    }
  }));
}

BlockEditable.propTypes = {
  /** Initial markdown for the editor. */
  markdown: _propTypes.default.string.isRequired,

  /** Function to propogate changes to the markdown. */
  onEdit: _propTypes.default.func,

  /** Replace strings before rendering. */
  inputFilters: _propTypes.default.array,

  /** Replace strings after editing. */
  outputFilters: _propTypes.default.array,

  /** CSS for the component. */
  style: _propTypes.default.object,

  /** Display Raw Markdown or HTML. */
  preview: _propTypes.default.bool,

  /** Enable/Disable editability. */
  editable: _propTypes.default.bool,

  /** fontSize e.g. '100%' */
  fontSize: _propTypes.default.string
};
BlockEditable.defaultProps = {
  markdown: '',
  onEdit: function onEdit() {},
  inputFilters: [],
  outputFilters: [],
  style: {},
  preview: true,
  editable: true
};

var RawMarkdown = function RawMarkdown(_ref2) {
  var _style = _ref2._style,
      classes = _ref2.classes,
      fontSize = _ref2.fontSize,
      markdown = _ref2.markdown,
      editable = _ref2.editable,
      handleKeyUp = _ref2.handleKeyUp,
      inputFilters = _ref2.inputFilters,
      handleRawBlur = _ref2.handleRawBlur,
      handleKeyPress = _ref2.handleKeyPress,
      handleCutPaste = _ref2.handleCutPaste;
  var code = (0, _core.filter)({
    string: markdown,
    filters: inputFilters
  });
  code = (0, _core.toDisplay)(code);
  var dangerouslySetInnerHTML = {
    __html: code
  };
  return /*#__PURE__*/_react.default.createElement("pre", {
    className: classes.pre
  }, /*#__PURE__*/_react.default.createElement("code", {
    className: classes.markdown,
    style: _objectSpread(_objectSpread({}, _style), {}, {
      fontSize: fontSize
    }),
    dir: "auto",
    contentEditable: editable,
    dangerouslySetInnerHTML: dangerouslySetInnerHTML,
    onBlur: handleRawBlur,
    onKeyPress: handleKeyPress,
    onKeyUp: handleKeyUp,
    onCut: handleCutPaste,
    onPaste: handleCutPaste
  }));
};

RawMarkdown.propTypes = {
  /** CSS for the component. */
  _style: _propTypes.default.object,

  /** CSS classes for the component. */
  classes: _propTypes.default.object,

  /** fontSize e.g. '100%' */
  fontSize: _propTypes.default.string,

  /** Initial markdown for the editor. */
  markdown: _propTypes.default.string.isRequired,

  /** Enable/Disable editability. */
  editable: _propTypes.default.bool,

  /** Function to handle Key Up. */
  handleKeyUp: _propTypes.default.func,

  /** Replace strings before rendering. */
  inputFilters: _propTypes.default.array,

  /** Function to handle raw on blur. */
  handleRawBlur: _propTypes.default.func,

  /** Function to handle key pres. */
  handleKeyPress: _propTypes.default.func,

  /** Function to handle cur & paste. */
  handleCutPaste: _propTypes.default.func
};
//# sourceMappingURL=data:application/json;charset=utf-8;base64,eyJ2ZXJzaW9uIjozLCJzb3VyY2VzIjpbIi4uLy4uLy4uL3NyYy9jb21wb25lbnRzL2Jsb2NrLWVkaXRhYmxlL0Jsb2NrRWRpdGFibGUuanMiXSwibmFtZXMiOlsiQmxvY2tFZGl0YWJsZSIsIm1hcmtkb3duIiwib25FZGl0IiwiaW5wdXRGaWx0ZXJzIiwib3V0cHV0RmlsdGVycyIsInN0eWxlIiwicHJldmlldyIsImVkaXRhYmxlIiwiZm9udFNpemUiLCJjbGFzc2VzIiwiTWFya2Rvd25Db250ZXh0IiwiYWN0aW9ucyIsIl9vbGRNYXJrZG93biIsIl9zdHlsZSIsImhhbmRsZUJsdXIiLCJfbWFya2Rvd24iLCJvbGRIVE1MIiwibmV3SFRNTCIsImhhbmRsZUhUTUxCbHVyIiwiZSIsImh0bWwiLCJ0YXJnZXQiLCJpbm5lckhUTUwiLCJoYW5kbGVSYXdCbHVyIiwic3RyaW5nIiwiaW5uZXJUZXh0IiwiZmlsdGVycyIsImhhbmRsZUtleVByZXNzIiwia2V5Y29kZSIsInNldElzQ2hhbmdlZCIsImhhbmRsZWRLZXlDb2RlcyIsImhhbmRsZUtleVVwIiwiZXZlbnQiLCJpbmNsdWRlcyIsImtleUNvZGUiLCJoYW5kbGVDdXRQYXN0ZSIsInNldElzQXV0b1NhdmVDaGFuZ2VkIiwicm9vdCIsIl9faHRtbCIsInByb3BUeXBlcyIsIlByb3BUeXBlcyIsImlzUmVxdWlyZWQiLCJmdW5jIiwiYXJyYXkiLCJvYmplY3QiLCJib29sIiwiZGVmYXVsdFByb3BzIiwiUmF3TWFya2Rvd24iLCJjb2RlIiwiZGFuZ2Vyb3VzbHlTZXRJbm5lckhUTUwiLCJwcmUiXSwibWFwcGluZ3MiOiI7Ozs7Ozs7OztBQUFBOztBQUNBOztBQUNBOztBQVFBOztBQUNBOzs7Ozs7Ozs7Ozs7OztBQUVlLFNBQVNBLGFBQVQsT0FTWjtBQUFBLE1BUkRDLFFBUUMsUUFSREEsUUFRQztBQUFBLE1BUERDLE1BT0MsUUFQREEsTUFPQztBQUFBLE1BTkRDLFlBTUMsUUFOREEsWUFNQztBQUFBLE1BTERDLGFBS0MsUUFMREEsYUFLQztBQUFBLE1BSkRD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QUFRLEVBQUVnQyxtQkFBVWhCLE1BTkU7O0FBT3RCO0FBQ0F2QixFQUFBQSxRQUFRLEVBQUV1QyxtQkFBVWhCLE1BQVYsQ0FBaUJpQixVQVJMOztBQVN0QjtBQUNBbEMsRUFBQUEsUUFBUSxFQUFFaUMsbUJBQVVLLElBVkU7O0FBV3RCO0FBQ0FkLEVBQUFBLFdBQVcsRUFBRVMsbUJBQVVFLElBWkQ7O0FBYXRCO0FBQ0F2QyxFQUFBQSxZQUFZLEVBQUVxQyxtQkFBVUcsS0FkRjs7QUFldEI7QUFDQXBCLEVBQUFBLGFBQWEsRUFBRWlCLG1CQUFVRSxJQWhCSDs7QUFpQnRCO0FBQ0FmLEVBQUFBLGNBQWMsRUFBRWEsbUJBQVVFLElBbEJKOztBQW1CdEI7QUFDQVAsRUFBQUEsY0FBYyxFQUFFSyxtQkFBVUU7QUFwQkosQ0FBeEIiLCJzb3VyY2VzQ29udGVudCI6WyJpbXBvcnQgUmVhY3QsIHsgdXNlTWVtbywgdXNlQ29udGV4dCB9IGZyb20gJ3JlYWN0JztcclxuaW1wb3J0IFByb3BUeXBlcyBmcm9tICdwcm9wLXR5cGVzJztcclxuaW1wb3J0IHtcclxuICBtYXJrZG93blRvSHRtbCxcclxuICBodG1sVG9NYXJrZG93bixcclxuICBmcm9tRGlzcGxheSxcclxuICB0b0Rpc3BsYXksXHJcbiAgaXNIZWJyZXcsXHJcbiAgZmlsdGVyLFxyXG59IGZyb20gJy4uLy4uL2NvcmUvJztcclxuaW1wb3J0IHsgTWFya2Rvd25Db250ZXh0IH0gZnJvbSAnLi4vTWFya2Rvd24uY29udGV4dCc7XHJcbmltcG9ydCB7IHVzZVN0eWxlcyB9IGZyb20gJy4vdXNlU3R5bGVzJztcclxuXHJcbmV4cG9ydCBkZWZhdWx0IGZ1bmN0aW9uIEJsb2NrRWRpdGFibGUoe1xyXG4gIG1hcmtkb3duLFxyXG4gIG9uRWRpdCxcclxuICBpbnB1dEZpbHRlcnMsXHJcbiAgb3V0cHV0RmlsdGVycyxcclxuICBzdHlsZSxcclxuICBwcmV2aWV3LFxyXG4gIGVkaXRhYmxlLFxyXG4gIGZvbnRTaXplLFxyXG59KSB7XHJcbiAgY29uc3QgY2xhc3NlcyA9IHVzZVN0eWxlcygpO1xyXG4gIGNvbnN0IHsgYWN0aW9ucyB9ID0gdXNlQ29udGV4dChNYXJrZG93bkNvbnRleHQpO1xyXG4gIGNvbnN0IF9vbGRNYXJrZG93biA9IHsgbWFya2Rvd24gfTtcclxuXHJcbiAgY29uc3QgX3N0eWxlID0gdXNlTWVtbyhcclxuICAgICgpID0+XHJcbiAgICAgIGlzSGVicmV3KG1hcmtkb3duKSA/IHsgLi4uc3R5bGUsIGZvbnRTaXplOiAnMS41ZW0nIH0gOiBzdHlsZSxcclxuICAgIFtzdHlsZSwgbWFya2Rvd25dXHJcbiAgKTtcclxuXHJcbiAgY29uc3QgaGFuZGxlQmx1ciA9IChfbWFya2Rvd24pID0+IHtcclxuICAgIGNvbnN0IG9sZEhUTUwgPSBtYXJrZG93blRvSHRtbCh7XHJcbiAgICAgIG1hcmtkb3duOiBfb2xkTWFya2Rvd24ubWFya2Rvd24sXHJcbiAgICAgIGlucHV0RmlsdGVyczogaW5wdXRGaWx0ZXJzLFxyXG4gICAgfSk7XHJcbiAgICBjb25zdCBuZXdIVE1MID0gbWFya2Rvd25Ub0h0bWwoe1xyXG4gICAgICBtYXJrZG93bjogX21hcmtkb3duLFxyXG4gICAgICBpbnB1dEZpbHRlcnM6IGlucHV0RmlsdGVycyxcclxuICAgIH0pO1xyXG5cclxuICAgIC8vIFRPRE86IGRvIHdlIG5lZWQgdG8gY2FsY3VsYXRlIEhUTUwgZWFjaCB0aW1lPz9cclxuICAgIGlmIChvbGRIVE1MICE9PSBuZXdIVE1MIHx8IF9vbGRNYXJrZG93bi5tYXJrZG93biAhPT0gX21hcmtkb3duKSB7XHJcbiAgICAgIF9vbGRNYXJrZG93bi5tYXJrZG93biA9IF9tYXJrZG93bjtcclxuICAgICAgb25FZGl0KF9tYXJrZG93bik7XHJcbiAgICB9XHJcbiAgfTtcclxuXHJcbiAgY29uc3QgaGFuZGxlSFRNTEJsdXIgPSAoZSkgPT4ge1xyXG4gICAgY29uc3QgaHRtbCA9IGUudGFyZ2V0LmlubmVySFRNTDtcclxuICAgIGNvbnN0IF9tYXJrZG93biA9IGh0bWxUb01hcmtkb3duKHsgaHRtbCwgb3V0cHV0RmlsdGVycyB9KTtcclxuICAgIGhhbmRsZUJsdXIoX21hcmtkb3duKTtcclxuICB9O1xyXG5cclxuICBjb25zdCBoYW5kbGVSYXdCbHVyID0gKGUpID0+IHtcclxuICAgIGxldCBzdHJpbmcgPSBlLnRhcmdldC5pbm5lclRleHQ7XHJcbiAgICBzdHJpbmcgPSBmcm9tRGlzcGxheShzdHJpbmcpO1xyXG4gICAgY29uc3QgX21hcmtkb3duID0gZmlsdGVyKHsgc3RyaW5nLCBmaWx0ZXJzOiBvdXRwdXRGaWx0ZXJzIH0pO1xyXG4gICAgaGFuZGxlQmx1cihfbWFya2Rvd24pO1xyXG4gIH07XHJcblxyXG4gIGNvbnN0IGhhbmRsZUtleVByZXNzID0gKGtleWNvZGUpID0+IHtcclxuICAgIGlmIChhY3Rpb25zICYmIGFjdGlvbnMuc2V0SXNDaGFuZ2VkKSB7XHJcbiAgICAgIGFjdGlvbnMuc2V0SXNDaGFuZ2VkKHRydWUpO1xyXG4gICAgfVxyXG4gIH07XHJcblxyXG4gIGNvbnN0IGhhbmRsZWRLZXlDb2RlcyA9IFs4LypEZWxldGUvQmFja3NwYWNlKi9dO1xyXG5cclxuICBjb25zdCBoYW5kbGVLZXlVcCA9IChldmVudCkgPT4ge1xyXG4gICAgaWYgKGFjdGlvbnMgJiYgYWN0aW9ucy5zZXRJc0NoYW5nZWQpIHtcclxuICAgICAgaWYgKGhhbmRsZWRLZXlDb2Rlcy5pbmNsdWRlcyhldmVudC5rZXlDb2RlKSkge1xyXG4gICAgICAgIC8vIE5PVEU6IHdlIGRvbid0IHdhbnQgdG8gY29udmVydCBIVE1MIG9uIGtleSBrZXlVcC5cclxuICAgICAgICAvLyBTbyB3ZSBjYW50IHRlc3QgZm9yIGNoYW5nZXMuXHJcbiAgICAgICAgYWN0aW9ucy5zZXRJc0NoYW5nZWQodHJ1ZSk7XHJcbiAgICAgIH1cclxuICAgIH1cclxuICB9O1xyXG5cclxuICBjb25zdCBoYW5kbGVDdXRQYXN0ZSA9ICgpID0+IHtcclxuICAgIGlmIChhY3Rpb25zICYmIGFjdGlvbnMuc2V0SXNDaGFuZ2VkKSB7XHJcbiAgICAgIGFjdGlvbnMuc2V0SXNDaGFuZ2VkKHRydWUpO1xyXG4gICAgfVxyXG5cclxuICAgIGlmIChhY3Rpb25zICYmIGFjdGlvbnMuc2V0SXNBdXRvU2F2ZUNoYW5nZWQpIHtcclxuICAgICAgYWN0aW9ucy5zZXRJc0F1dG9TYXZlQ2hhbmdlZCh0cnVlKTtcclxuICAgIH1cclxuICB9O1xyXG5cclxuICByZXR1cm4gKFxyXG4gICAgPGRpdiBjbGFzc05hbWU9e2NsYXNzZXMucm9vdH0+XHJcbiAgICAgIHtcclxuICAgICAgICAhcHJldmlldyA/XHJcbiAgICAgICAgICA8UmF3TWFya2Rvd25cclxuICAgICAgICAgICAgX3N0eWxlPXtfc3R5bGV9XHJcbiAgICAgICAgICAgIGNsYXNzZXM9e2NsYXNzZXN9XHJcbiAgICAgICAgICAgIGZvbnRTaXplPXtmb250U2l6ZX1cclxuICAgICAgICAgICAgbWFya2Rvd249e21hcmtkb3dufVxyXG4gICAgICAgICAgICBlZGl0YWJsZT17ZWRpdGFibGV9XHJcbiAgICAgICAgICAgIGhhbmRsZUtleVVwPXtoYW5kbGVLZXlVcH1cclxuICAgICAgICAgICAgaW5wdXRGaWx0ZXJzPXtpbnB1dEZpbHRlcnN9XHJcbiAgICAgICAgICAgIGhhbmRsZVJhd0JsdXI9e2hhbmRsZVJhd0JsdXJ9XHJcbiAgICAgICAgICAgIGhhbmRsZUtleVByZXNzPXtoYW5kbGVLZXlQcmVzc31cclxuICAgICAgICAgICAgaGFuZGxlQ3V0UGFzdGU9e2hhbmRsZUN1dFBhc3RlfVxyXG4gICAgICAgICAgLz5cclxuICAgICAgICAgIDpcclxuICAgICAgICAgIDxkaXZcclxuICAgICAgICAgICAgc3R5bGU9e3sgLi4uX3N0eWxlLCBmb250U2l6ZSB9fVxyXG4gICAgICAgICAgICBjbGFzc05hbWU9e2NsYXNzZXMuaHRtbH1cclxuICAgICAgICAgICAgZGlyPSdhdXRvJ1xyXG4gICAgICAgICAgICBjb250ZW50RWRpdGFibGU9e2VkaXRhYmxlfVxyXG4gICAgICAgICAgICBvbkJsdXI9e2hhbmRsZUhUTUxCbHVyfVxyXG4gICAgICAgICAgICBvbktleVByZXNzPXtoYW5kbGVLZXlQcmVzc31cclxuICAgICAgICAgICAgb25LZXlVcD17aGFuZGxlS2V5VXB9XHJcbiAgICAgICAgICAgIG9uQ3V0PXtoYW5kbGVDdXRQYXN0ZX1cclxuICAgICAgICAgICAgb25QYXN0ZT17aGFuZGxlQ3V0UGFzdGV9XHJcbiAgICAgICAgICAgIGRhbmdlcm91c2x5U2V0SW5uZXJIVE1MPXt7IF9faHRtbDogbWFya2Rvd25Ub0h0bWwoeyBtYXJrZG93biwgaW5wdXRGaWx0ZXJzIH0pIH19XHJcbiAgICAgICAgICAvPlxyXG4gICAgICB9XHJcbiAgICA8L2Rpdj5cclxuICApO1xyXG59XHJcblxyXG5CbG9ja0VkaXRhYmxlLnByb3BUeXBlcyA9IHtcclxuICAvKiogSW5pdGlhbCBtYXJrZG93biBmb3IgdGhlIGVkaXRvci4gKi9cclxuICBtYXJrZG93bjogUHJvcFR5cGVzLnN0cmluZy5pc1JlcXVpcmVkLFxyXG4gIC8qKiBGdW5jdGlvbiB0byBwcm9wb2dhdGUgY2hhbmdlcyB0byB0aGUgbWFya2Rvd24uICovXHJcbiAgb25FZGl0OiBQcm9wVHlwZXMuZnVuYyxcclxuICAvKiogUmVwbGFjZSBzdHJpbmdzIGJlZm9yZSByZW5kZXJpbmcuICovXHJcbiAgaW5wdXRGaWx0ZXJzOiBQcm9wVHlwZXMuYXJyYXksXHJcbiAgLyoqIFJlcGxhY2Ugc3RyaW5ncyBhZnRlciBlZGl0aW5nLiAqL1xyXG4gIG91dHB1dEZpbHRlcnM6IFByb3BUeXBlcy5hcnJheSxcclxuICAvKiogQ1NTIGZvciB0aGUgY29tcG9uZW50LiAqL1xyXG4gIHN0eWxlOiBQcm9wVHlwZXMub2JqZWN0LFxyXG4gIC8qKiBEaXNwbGF5IFJhdyBNYXJrZG93biBvciBIVE1MLiAqL1xyXG4gIHByZXZpZXc6IFByb3BUeXBlcy5ib29sLFxyXG4gIC8qKiBFbmFibGUvRGlzYWJsZSBlZGl0YWJpbGl0eS4gKi9cclxuICBlZGl0YWJsZTogUHJvcFR5cGVzLmJvb2wsXHJcbiAgLyoqIGZvbnRTaXplIGUuZy4gJzEwMCUnICovXHJcbiAgZm9udFNpemU6IFByb3BUeXBlcy5zdHJpbmcsXHJcbn07XHJcblxyXG5CbG9ja0VkaXRhYmxlLmRlZmF1bHRQcm9wcyA9IHtcclxuICBtYXJrZG93bjogJycsXHJcbiAgb25FZGl0OiAoKSA9PiB7IH0sXHJcbiAgaW5wdXRGaWx0ZXJzOiBbXSxcclxuICBvdXRwdXRGaWx0ZXJzOiBbXSxcclxuICBzdHlsZToge30sXHJcbiAgcHJldmlldzogdHJ1ZSxcclxuICBlZGl0YWJsZTogdHJ1ZSxcclxufTtcclxuXHJcbmNvbnN0IFJhd01hcmtkb3duID0gKHtcclxuICBfc3R5bGUsXHJcbiAgY2xhc3NlcyxcclxuICBmb250U2l6ZSxcclxuICBtYXJrZG93bixcclxuICBlZGl0YWJsZSxcclxuICBoYW5kbGVLZXlVcCxcclxuICBpbnB1dEZpbHRlcnMsXHJcbiAgaGFuZGxlUmF3Qmx1cixcclxuICBoYW5kbGVLZXlQcmVzcyxcclxuICBoYW5kbGVDdXRQYXN0ZSxcclxufSkgPT4ge1xyXG4gIGxldCBjb2RlID0gZmlsdGVyKHsgc3RyaW5nOiBtYXJrZG93biwgZmlsdGVyczogaW5wdXRGaWx0ZXJzIH0pO1xyXG4gIGNvZGUgPSB0b0Rpc3BsYXkoY29kZSk7XHJcbiAgY29uc3QgZGFuZ2Vyb3VzbHlTZXRJbm5lckhUTUwgPSB7IF9faHRtbDogY29kZSB9O1xyXG5cclxuICByZXR1cm4gKFxyXG4gICAgPHByZSBjbGFzc05hbWU9e2NsYXNzZXMucHJlfT5cclxuICAgICAgPGNvZGVcclxuICAgICAgICBjbGFzc05hbWU9e2NsYXNzZXMubWFya2Rvd259XHJcbiAgICAgICAgc3R5bGU9e3sgLi4uX3N0eWxlLCBmb250U2l6ZSB9fVxyXG4gICAgICAgIGRpcj0nYXV0bydcclxuICAgICAgICBjb250ZW50RWRpdGFibGU9e2VkaXRhYmxlfVxyXG4gICAgICAgIGRhbmdlcm91c2x5U2V0SW5uZXJIVE1MPXtkYW5nZXJvdXNseVNldElubmVySFRNTH1cclxuICAgICAgICBvbkJsdXI9e2hhbmRsZVJhd0JsdXJ9XHJcbiAgICAgICAgb25LZXlQcmVzcz17aGFuZGxlS2V5UHJlc3N9XHJcbiAgICAgICAgb25LZXlVcD17aGFuZGxlS2V5VXB9XHJcbiAgICAgICAgb25DdXQ9e2hhbmRsZUN1dFBhc3RlfVxyXG4gICAgICAgIG9uUGFzdGU9e2hhbmRsZUN1dFBhc3RlfVxyXG4gICAgICAvPlxyXG4gICAgPC9wcmU+XHJcbiAgKTtcclxufTtcclxuXHJcblJhd01hcmtkb3duLnByb3BUeXBlcyA9IHtcclxuICAvKiogQ1NTIGZvciB0aGUgY29tcG9uZW50LiAqL1xyXG4gIF9zdHlsZTogUHJvcFR5cGVzLm9iamVjdCxcclxuICAvKiogQ1NTIGNsYXNzZXMgZm9yIHRoZSBjb21wb25lbnQuICovXHJcbiAgY2xhc3NlczogUHJvcFR5cGVzLm9iamVjdCxcclxuICAvKiogZm9udFNpemUgZS5nLiAnMTAwJScgKi9cclxuICBmb250U2l6ZTogUHJvcFR5cGVzLnN0cmluZyxcclxuICAvKiogSW5pdGlhbCBtYXJrZG93biBmb3IgdGhlIGVkaXRvci4gKi9cclxuICBtYXJrZG93bjogUHJvcFR5cGVzLnN0cmluZy5pc1JlcXVpcmVkLFxyXG4gIC8qKiBFbmFibGUvRGlzYWJsZSBlZGl0YWJpbGl0eS4gKi9cclxuICBlZGl0YWJsZTogUHJvcFR5cGVzLmJvb2wsXHJcbiAgLyoqIEZ1bmN0aW9uIHRvIGhhbmRsZSBLZXkgVXAuICovXHJcbiAgaGFuZGxlS2V5VXA6IFByb3BUeXBlcy5mdW5jLFxyXG4gIC8qKiBSZXBsYWNlIHN0cmluZ3MgYmVmb3JlIHJlbmRlcmluZy4gKi9cclxuICBpbnB1dEZpbHRlcnM6IFByb3BUeXBlcy5hcnJheSxcclxuICAvKiogRnVuY3Rpb24gdG8gaGFuZGxlIHJhdyBvbiBibHVyLiAqL1xyXG4gIGhhbmRsZVJhd0JsdXI6IFByb3BUeXBlcy5mdW5jLFxyXG4gIC8qKiBGdW5jdGlvbiB0byBoYW5kbGUga2V5IHByZXMuICovXHJcbiAgaGFuZGxlS2V5UHJlc3M6IFByb3BUeXBlcy5mdW5jLFxyXG4gIC8qKiBGdW5jdGlvbiB0byBoYW5kbGUgY3VyICYgcGFzdGUuICovXHJcbiAgaGFuZGxlQ3V0UGFzdGU6IFByb3BUeXBlcy5mdW5jLFxyXG59OyJdfQ==