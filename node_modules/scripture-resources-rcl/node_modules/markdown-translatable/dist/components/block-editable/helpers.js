"use strict";

Object.defineProperty(exports, "__esModule", {
  value: true
});
exports.useFixCursorOnNewLine = useFixCursorOnNewLine;
exports.useHandleUndo = useHandleUndo;
exports.useHandlePaste = useHandlePaste;

var _react = require("react");

function _slicedToArray(arr, i) { return _arrayWithHoles(arr) || _iterableToArrayLimit(arr, i) || _unsupportedIterableToArray(arr, i) || _nonIterableRest(); }

function _nonIterableRest() { throw new TypeError("Invalid attempt to destructure non-iterable instance.\nIn order to be iterable, non-array objects must have a [Symbol.iterator]() method."); }

function _unsupportedIterableToArray(o, minLen) { if (!o) return; if (typeof o === "string") return _arrayLikeToArray(o, minLen); var n = Object.prototype.toString.call(o).slice(8, -1); if (n === "Object" && o.constructor) n = o.constructor.name; if (n === "Map" || n === "Set") return Array.from(o); if (n === "Arguments" || /^(?:Ui|I)nt(?:8|16|32)(?:Clamped)?Array$/.test(n)) return _arrayLikeToArray(o, minLen); }

function _arrayLikeToArray(arr, len) { if (len == null || len > arr.length) len = arr.length; for (var i = 0, arr2 = new Array(len); i < len; i++) { arr2[i] = arr[i]; } return arr2; }

function _iterableToArrayLimit(arr, i) { if (typeof Symbol === "undefined" || !(Symbol.iterator in Object(arr))) return; var _arr = []; var _n = true; var _d = false; var _e = undefined; try { for (var _i = arr[Symbol.iterator](), _s; !(_n = (_s = _i.next()).done); _n = true) { _arr.push(_s.value); if (i && _arr.length === i) break; } } catch (err) { _d = true; _e = err; } finally { try { if (!_n && _i["return"] != null) _i["return"](); } finally { if (_d) throw _e; } } return _arr; }

function _arrayWithHoles(arr) { if (Array.isArray(arr)) return arr; }

function useFixCursorOnNewLine(el) {
  var _useState = (0, _react.useState)(null),
      _useState2 = _slicedToArray(_useState, 2),
      savedSelection = _useState2[0],
      setSavedSelection = _useState2[1];

  var saveSelection = (0, _react.useCallback)(function (containerEl) {
    if (window.getSelection().rangeCount > 0) {
      var range = window.getSelection().getRangeAt(0);
      var preSelectionRange = range.cloneRange();
      preSelectionRange.selectNodeContents(containerEl);
      preSelectionRange.setEnd(range.startContainer, range.startOffset);
      var start = preSelectionRange.toString().length;
      /** Adding plus one to account for newline */

      setSavedSelection({
        start: start + 1,

        /** Adding plus one to account for newline */
        end: start + range.toString().length + 1
      });
    } else {
      setSavedSelection({
        start: 0,
        end: 0
      });
    }
  }, []);
  var restoreSelection = (0, _react.useCallback)(function (containerEl, _savedSelection) {
    var charIndex = 0,
        range = document.createRange();
    range.setStart(containerEl, 0);
    range.collapse(true);
    var nodeStack = [containerEl],
        node,
        foundStart = false,
        stop = false;

    while (!stop && (node = nodeStack.pop())) {
      if (node.nodeType == 3) {
        var nextCharIndex = charIndex + node.length;

        if (!foundStart && _savedSelection.start >= charIndex && _savedSelection.start <= nextCharIndex) {
          range.setStart(node, _savedSelection.start - charIndex);
          foundStart = true;
        }

        if (foundStart && _savedSelection.end >= charIndex && _savedSelection.end <= nextCharIndex) {
          range.setEnd(node, _savedSelection.end - charIndex);
          stop = true;
        }

        charIndex = nextCharIndex;
      } else {
        var i = node.childNodes.length;

        while (i--) {
          nodeStack.push(node.childNodes[i]);
        }
      }
    }

    var sel = window.getSelection();
    sel.removeAllRanges();
    sel.addRange(range);
  }, []);
  var handleRestore = (0, _react.useCallback)(function (e) {
    /** Only listening for newline key character code */
    if (e.keyCode === 13) {
      restoreSelection(el, savedSelection);
    }
  }, [el, restoreSelection, savedSelection]);
  var handleSaveSelection = (0, _react.useCallback)(function () {
    saveSelection(el);
  }, [el, saveSelection]);
  (0, _react.useEffect)(function () {
    if (el) {
      el.addEventListener('keyup', handleRestore);
      el.addEventListener('keydown', handleSaveSelection);
    }

    ;
    return function () {
      if (el) {
        el.removeEventListener('keyup', handleRestore);
        el.addEventListener('keydown', handleSaveSelection);
      }
    };
  }, [el, handleRestore, handleSaveSelection, restoreSelection, saveSelection]);
}

function useHandleUndo(el, initialState) {
  var _useState3 = (0, _react.useState)([initialState]),
      _useState4 = _slicedToArray(_useState3, 2),
      lastValues = _useState4[0],
      setLastValues = _useState4[1];

  var handleUndo = (0, _react.useCallback)(function (e) {
    if (e.metaKey && e.key === 'z' && lastValues.length) {
      e.target.innerHTML = lastValues.pop();
    }

    if (!e.metaKey || e.metaKey && e.key === 'v') {
      var copy = lastValues.slice(0);
      copy.push(e.target.innerHTML);
      setLastValues(copy);
    }
  }, [lastValues]);
  (0, _react.useEffect)(function () {
    if (el) {
      el.addEventListener('keydown', handleUndo);
    }

    ;
    return function () {
      if (el) {
        el.removeEventListener('keydown', handleUndo);
      }
    };
  }, [el, handleUndo]);
}

function useHandlePaste(el, preview) {
  var handlePaste = (0, _react.useCallback)(function (e) {
    e.preventDefault();
    var pastedData = e.clipboardData.getData('text/plain');
    var doc = new DOMParser().parseFromString(pastedData, 'text/html');
    var text = doc.body.textContent || '';
    document.execCommand('insertHTML', false, text);
  }, []);
  (0, _react.useEffect)(function () {
    if (el) {
      el.addEventListener('paste', handlePaste);
    }

    ;
    return function () {
      if (el) {
        el.removeEventListener('paste', handlePaste);
      }
    };
  }, [el, handlePaste, preview]);
}
//# sourceMappingURL=data:application/json;charset=utf-8;base64,eyJ2ZXJzaW9uIjozLCJzb3VyY2VzIjpbIi4uLy4uLy4uL3NyYy9jb21wb25lbnRzL2Jsb2NrLWVkaXRhYmxlL2hlbHBlcnMuanMiXSwibmFtZXMiOlsidXNlRml4Q3Vyc29yT25OZXdMaW5lIiwiZWwiLCJzYXZlZFNlbGVjdGlvbiIsInNldFNhdmVkU2VsZWN0aW9uIiwic2F2ZVNlbGVjdGlvbiIsImNvbnRhaW5lckVsIiwid2luZG93IiwiZ2V0U2VsZWN0aW9uIiwicmFuZ2VDb3VudCIsInJhbmdlIiwiZ2V0UmFuZ2VBdCIsInByZVNlbGVjdGlvblJhbmdlIiwiY2xvbmVSYW5nZSIsInNlbGVjdE5vZGVDb250ZW50cyIsInNldEVuZCIsInN0YXJ0Q29udGFpbmVyIiwic3RhcnRPZmZzZXQiLCJzdGFydCIsInRvU3RyaW5nIiwibGVuZ3RoIiwiZW5kIiwicmVzdG9yZVNlbGVjdGlvbiIsIl9zYXZlZFNlbGVjdGlvbiIsImNoYXJJbmRleCIsImRvY3VtZW50IiwiY3JlYXRlUmFuZ2UiLCJzZXRTdGFydCIsImNvbGxhcHNlIiwibm9kZVN0YWNrIiwibm9kZSIsImZvdW5kU3RhcnQiLCJzdG9wIiwicG9wIiwibm9kZVR5cGUiLCJuZXh0Q2hhckluZGV4IiwiaSIsImNoaWxkTm9kZXMiLCJwdXNoIiwic2VsIiwicmVtb3ZlQWxsUmFuZ2VzIiwiYWRkUmFuZ2UiLCJoYW5kbGVSZXN0b3JlIiwiZSIsImtleUNvZGUiLCJoYW5kbGVTYXZlU2VsZWN0aW9uIiwiYWRkRXZlbnRMaXN0ZW5lciIsInJlbW92ZUV2ZW50TGlzdGVuZXIiLCJ1c2VIYW5kbGVVbmRvIiwiaW5pdGlhbFN0YXRlIiwibGFzdFZhbHVlcyIsInNldExhc3RWYWx1ZXMiLCJoYW5kbGVVbmRvIiwibWV0YUtleSIsImtleSIsInRhcmdldCIsImlubmVySFRNTCIsImNvcHkiLCJzbGljZSIsInVzZUhhbmRsZVBhc3RlIiwicHJldmlldyIsImhhbmRsZVBhc3RlIiwicHJldmVudERlZmF1bHQiLCJwYXN0ZWREYXRhIiwiY2xpcGJvYXJkRGF0YSIsImdldERhdGEiLCJkb2MiLCJET01QYXJzZXIiLCJwYXJzZUZyb21TdHJpbmciLCJ0ZXh0IiwiYm9keSIsInRleHRDb250ZW50IiwiZXhlY0NvbW1hbmQiXSwibWFwcGluZ3MiOiI7Ozs7Ozs7OztBQUFBOzs7Ozs7Ozs7Ozs7OztBQUlPLFNBQVNBLHFCQUFULENBQStCQyxFQUEvQixFQUFtQztBQUFBLGtCQUNJLHFCQUFTLElBQVQsQ0FESjtBQUFBO0FBQUEsTUFDakNDLGNBRGlDO0FBQUEsTUFDakJDLGlCQURpQjs7QUFHeEMsTUFBTUMsYUFBYSxHQUFHLHdCQUFZLFVBQVVDLFdBQVYsRUFBdUI7QUFDdkQsUUFBSUMsTUFBTSxDQUFDQyxZQUFQLEdBQXNCQyxVQUF0QixHQUFtQyxDQUF2QyxFQUEwQztBQUN4QyxVQUFNQyxLQUFLLEdBQUdILE1BQU0sQ0FBQ0MsWUFBUCxHQUFzQkcsVUFBdEIsQ0FBaUMsQ0FBakMsQ0FBZDtBQUNBLFVBQU1DLGlCQUFpQixHQUFHRixLQUFLLENBQUNHLFVBQU4sRUFBMUI7QUFDQUQsTUFBQUEsaUJBQWlCLENBQUNFLGtCQUFsQixDQUFxQ1IsV0FBckM7QUFDQU0sTUFBQUEsaUJBQWlCLENBQUNHLE1BQWxCLENBQXlCTCxLQUFLLENBQUNNLGNBQS9CLEVBQStDTixLQUFLLENBQUNPLFdBQXJEO0FBQ0EsVUFBTUMsS0FBSyxHQUFHTixpQkFBaUIsQ0FBQ08sUUFBbEIsR0FBNkJDLE1BQTNDO0FBRUE7O0FBQ0FoQixNQUFBQSxpQkFBaUIsQ0FBQztBQUNoQmMsUUFBQUEsS0FBSyxFQUFFQSxLQUFLLEdBQUcsQ0FEQzs7QUFFaEI7QUFDQUcsUUFBQUEsR0FBRyxFQUFFSCxLQUFLLEdBQUdSLEtBQUssQ0FBQ1MsUUFBTixHQUFpQkMsTUFBekIsR0FBa0M7QUFIdkIsT0FBRCxDQUFqQjtBQUtELEtBYkQsTUFhTztBQUNMaEIsTUFBQUEsaUJBQWlCLENBQUM7QUFDaEJjLFFBQUFBLEtBQUssRUFBRSxDQURTO0FBRWhCRyxRQUFBQSxHQUFHLEVBQUU7QUFGVyxPQUFELENBQWpCO0FBSUQ7QUFDRixHQXBCcUIsRUFvQm5CLEVBcEJtQixDQUF0QjtBQXNCQSxNQUFNQyxnQkFBZ0IsR0FBRyx3QkFBWSxVQUFVaEIsV0FBVixFQUF1QmlCLGVBQXZCLEVBQXdDO0FBQzNFLFFBQUlDLFNBQVMsR0FBRyxDQUFoQjtBQUFBLFFBQW1CZCxLQUFLLEdBQUdlLFFBQVEsQ0FBQ0MsV0FBVCxFQUEzQjtBQUNBaEIsSUFBQUEsS0FBSyxDQUFDaUIsUUFBTixDQUFlckIsV0FBZixFQUE0QixDQUE1QjtBQUNBSSxJQUFBQSxLQUFLLENBQUNrQixRQUFOLENBQWUsSUFBZjtBQUNBLFFBQUlDLFNBQVMsR0FBRyxDQUFDdkIsV0FBRCxDQUFoQjtBQUFBLFFBQStCd0IsSUFBL0I7QUFBQSxRQUFxQ0MsVUFBVSxHQUFHLEtBQWxEO0FBQUEsUUFBeURDLElBQUksR0FBRyxLQUFoRTs7QUFFQSxXQUFPLENBQUNBLElBQUQsS0FBVUYsSUFBSSxHQUFHRCxTQUFTLENBQUNJLEdBQVYsRUFBakIsQ0FBUCxFQUEwQztBQUN4QyxVQUFJSCxJQUFJLENBQUNJLFFBQUwsSUFBaUIsQ0FBckIsRUFBd0I7QUFDdEIsWUFBTUMsYUFBYSxHQUFHWCxTQUFTLEdBQUdNLElBQUksQ0FBQ1YsTUFBdkM7O0FBRUEsWUFBSSxDQUFDVyxVQUFELElBQWVSLGVBQWUsQ0FBQ0wsS0FBaEIsSUFBeUJNLFNBQXhDLElBQXFERCxlQUFlLENBQUNMLEtBQWhCLElBQXlCaUIsYUFBbEYsRUFBaUc7QUFDL0Z6QixVQUFBQSxLQUFLLENBQUNpQixRQUFOLENBQWVHLElBQWYsRUFBcUJQLGVBQWUsQ0FBQ0wsS0FBaEIsR0FBd0JNLFNBQTdDO0FBQ0FPLFVBQUFBLFVBQVUsR0FBRyxJQUFiO0FBQ0Q7O0FBRUQsWUFBSUEsVUFBVSxJQUFJUixlQUFlLENBQUNGLEdBQWhCLElBQXVCRyxTQUFyQyxJQUFrREQsZUFBZSxDQUFDRixHQUFoQixJQUF1QmMsYUFBN0UsRUFBNEY7QUFDMUZ6QixVQUFBQSxLQUFLLENBQUNLLE1BQU4sQ0FBYWUsSUFBYixFQUFtQlAsZUFBZSxDQUFDRixHQUFoQixHQUFzQkcsU0FBekM7QUFDQVEsVUFBQUEsSUFBSSxHQUFHLElBQVA7QUFDRDs7QUFDRFIsUUFBQUEsU0FBUyxHQUFHVyxhQUFaO0FBQ0QsT0FiRCxNQWFPO0FBQ0wsWUFBSUMsQ0FBQyxHQUFHTixJQUFJLENBQUNPLFVBQUwsQ0FBZ0JqQixNQUF4Qjs7QUFFQSxlQUFPZ0IsQ0FBQyxFQUFSLEVBQVk7QUFDVlAsVUFBQUEsU0FBUyxDQUFDUyxJQUFWLENBQWVSLElBQUksQ0FBQ08sVUFBTCxDQUFnQkQsQ0FBaEIsQ0FBZjtBQUNEO0FBQ0Y7QUFDRjs7QUFFRCxRQUFNRyxHQUFHLEdBQUdoQyxNQUFNLENBQUNDLFlBQVAsRUFBWjtBQUNBK0IsSUFBQUEsR0FBRyxDQUFDQyxlQUFKO0FBQ0FELElBQUFBLEdBQUcsQ0FBQ0UsUUFBSixDQUFhL0IsS0FBYjtBQUNELEdBaEN3QixFQWdDdEIsRUFoQ3NCLENBQXpCO0FBa0NBLE1BQU1nQyxhQUFhLEdBQUcsd0JBQVksVUFBQ0MsQ0FBRCxFQUFNO0FBQ3RDO0FBQ0EsUUFBSUEsQ0FBQyxDQUFDQyxPQUFGLEtBQWMsRUFBbEIsRUFBc0I7QUFDcEJ0QixNQUFBQSxnQkFBZ0IsQ0FBQ3BCLEVBQUQsRUFBS0MsY0FBTCxDQUFoQjtBQUNEO0FBQ0YsR0FMcUIsRUFLbkIsQ0FBQ0QsRUFBRCxFQUFLb0IsZ0JBQUwsRUFBdUJuQixjQUF2QixDQUxtQixDQUF0QjtBQU9BLE1BQU0wQyxtQkFBbUIsR0FBRyx3QkFBWSxZQUFNO0FBQzVDeEMsSUFBQUEsYUFBYSxDQUFDSCxFQUFELENBQWI7QUFDRCxHQUYyQixFQUV6QixDQUFDQSxFQUFELEVBQUtHLGFBQUwsQ0FGeUIsQ0FBNUI7QUFJQSx3QkFBVSxZQUFNO0FBQ2QsUUFBSUgsRUFBSixFQUFRO0FBQ05BLE1BQUFBLEVBQUUsQ0FBQzRDLGdCQUFILENBQW9CLE9BQXBCLEVBQTZCSixhQUE3QjtBQUNBeEMsTUFBQUEsRUFBRSxDQUFDNEMsZ0JBQUgsQ0FBb0IsU0FBcEIsRUFBK0JELG1CQUEvQjtBQUNEOztBQUFBO0FBQ0QsV0FBTyxZQUFNO0FBQ1gsVUFBSTNDLEVBQUosRUFBUTtBQUNOQSxRQUFBQSxFQUFFLENBQUM2QyxtQkFBSCxDQUF1QixPQUF2QixFQUFnQ0wsYUFBaEM7QUFDQXhDLFFBQUFBLEVBQUUsQ0FBQzRDLGdCQUFILENBQW9CLFNBQXBCLEVBQStCRCxtQkFBL0I7QUFDRDtBQUNGLEtBTEQ7QUFNRCxHQVhELEVBV0csQ0FBQzNDLEVBQUQsRUFBS3dDLGFBQUwsRUFBb0JHLG1CQUFwQixFQUF5Q3ZCLGdCQUF6QyxFQUEyRGpCLGFBQTNELENBWEg7QUFZRDs7QUFFTSxTQUFTMkMsYUFBVCxDQUF1QjlDLEVBQXZCLEVBQTJCK0MsWUFBM0IsRUFBeUM7QUFBQSxtQkFDVixxQkFBUyxDQUFDQSxZQUFELENBQVQsQ0FEVTtBQUFBO0FBQUEsTUFDdkNDLFVBRHVDO0FBQUEsTUFDM0JDLGFBRDJCOztBQUU5QyxNQUFNQyxVQUFVLEdBQUcsd0JBQVksVUFBQ1QsQ0FBRCxFQUFPO0FBQ3BDLFFBQUlBLENBQUMsQ0FBQ1UsT0FBRixJQUFhVixDQUFDLENBQUNXLEdBQUYsS0FBVSxHQUF2QixJQUE4QkosVUFBVSxDQUFDOUIsTUFBN0MsRUFBcUQ7QUFDbkR1QixNQUFBQSxDQUFDLENBQUNZLE1BQUYsQ0FBU0MsU0FBVCxHQUFxQk4sVUFBVSxDQUFDakIsR0FBWCxFQUFyQjtBQUNEOztBQUVELFFBQUksQ0FBQ1UsQ0FBQyxDQUFDVSxPQUFILElBQWVWLENBQUMsQ0FBQ1UsT0FBRixJQUFhVixDQUFDLENBQUNXLEdBQUYsS0FBVSxHQUExQyxFQUFnRDtBQUM5QyxVQUFNRyxJQUFJLEdBQUdQLFVBQVUsQ0FBQ1EsS0FBWCxDQUFpQixDQUFqQixDQUFiO0FBQ0FELE1BQUFBLElBQUksQ0FBQ25CLElBQUwsQ0FBVUssQ0FBQyxDQUFDWSxNQUFGLENBQVNDLFNBQW5CO0FBQ0FMLE1BQUFBLGFBQWEsQ0FBQ00sSUFBRCxDQUFiO0FBQ0Q7QUFDRixHQVZrQixFQVVoQixDQUFDUCxVQUFELENBVmdCLENBQW5CO0FBWUEsd0JBQVUsWUFBTTtBQUNkLFFBQUloRCxFQUFKLEVBQVE7QUFDTkEsTUFBQUEsRUFBRSxDQUFDNEMsZ0JBQUgsQ0FBb0IsU0FBcEIsRUFBK0JNLFVBQS9CO0FBQ0Q7O0FBQUE7QUFDRCxXQUFPLFlBQU07QUFDWCxVQUFJbEQsRUFBSixFQUFRO0FBQ05BLFFBQUFBLEVBQUUsQ0FBQzZDLG1CQUFILENBQXVCLFNBQXZCLEVBQWtDSyxVQUFsQztBQUNEO0FBQ0YsS0FKRDtBQUtELEdBVEQsRUFTRyxDQUFDbEQsRUFBRCxFQUFLa0QsVUFBTCxDQVRIO0FBVUQ7O0FBRU0sU0FBU08sY0FBVCxDQUF3QnpELEVBQXhCLEVBQTRCMEQsT0FBNUIsRUFBcUM7QUFDMUMsTUFBTUMsV0FBVyxHQUFHLHdCQUFZLFVBQUNsQixDQUFELEVBQU87QUFDckNBLElBQUFBLENBQUMsQ0FBQ21CLGNBQUY7QUFDQSxRQUFNQyxVQUFVLEdBQUdwQixDQUFDLENBQUNxQixhQUFGLENBQWdCQyxPQUFoQixDQUF3QixZQUF4QixDQUFuQjtBQUNBLFFBQU1DLEdBQUcsR0FBRyxJQUFJQyxTQUFKLEdBQWdCQyxlQUFoQixDQUFnQ0wsVUFBaEMsRUFBNEMsV0FBNUMsQ0FBWjtBQUNBLFFBQU1NLElBQUksR0FBR0gsR0FBRyxDQUFDSSxJQUFKLENBQVNDLFdBQVQsSUFBd0IsRUFBckM7QUFDQTlDLElBQUFBLFFBQVEsQ0FBQytDLFdBQVQsQ0FBcUIsWUFBckIsRUFBbUMsS0FBbkMsRUFBMENILElBQTFDO0FBQ0QsR0FObUIsRUFNakIsRUFOaUIsQ0FBcEI7QUFRQSx3QkFBVSxZQUFNO0FBQ2QsUUFBSW5FLEVBQUosRUFBUTtBQUNOQSxNQUFBQSxFQUFFLENBQUM0QyxnQkFBSCxDQUFvQixPQUFwQixFQUE2QmUsV0FBN0I7QUFDRDs7QUFBQTtBQUNELFdBQU8sWUFBTTtBQUNYLFVBQUkzRCxFQUFKLEVBQVE7QUFDTkEsUUFBQUEsRUFBRSxDQUFDNkMsbUJBQUgsQ0FBdUIsT0FBdkIsRUFBZ0NjLFdBQWhDO0FBQ0Q7QUFDRixLQUpEO0FBS0QsR0FURCxFQVNHLENBQUMzRCxFQUFELEVBQUsyRCxXQUFMLEVBQWtCRCxPQUFsQixDQVRIO0FBVUQiLCJzb3VyY2VzQ29udGVudCI6WyJpbXBvcnQge1xyXG4gIHVzZUNhbGxiYWNrLCB1c2VTdGF0ZSwgdXNlRWZmZWN0LFxyXG59IGZyb20gJ3JlYWN0JztcclxuXHJcbmV4cG9ydCBmdW5jdGlvbiB1c2VGaXhDdXJzb3JPbk5ld0xpbmUoZWwpIHtcclxuICBjb25zdCBbc2F2ZWRTZWxlY3Rpb24sIHNldFNhdmVkU2VsZWN0aW9uXSA9IHVzZVN0YXRlKG51bGwpO1xyXG5cclxuICBjb25zdCBzYXZlU2VsZWN0aW9uID0gdXNlQ2FsbGJhY2soZnVuY3Rpb24gKGNvbnRhaW5lckVsKSB7XHJcbiAgICBpZiAod2luZG93LmdldFNlbGVjdGlvbigpLnJhbmdlQ291bnQgPiAwKSB7XHJcbiAgICAgIGNvbnN0IHJhbmdlID0gd2luZG93LmdldFNlbGVjdGlvbigpLmdldFJhbmdlQXQoMCk7XHJcbiAgICAgIGNvbnN0IHByZVNlbGVjdGlvblJhbmdlID0gcmFuZ2UuY2xvbmVSYW5nZSgpO1xyXG4gICAgICBwcmVTZWxlY3Rpb25SYW5nZS5zZWxlY3ROb2RlQ29udGVudHMoY29udGFpbmVyRWwpO1xyXG4gICAgICBwcmVTZWxlY3Rpb25SYW5nZS5zZXRFbmQocmFuZ2Uuc3RhcnRDb250YWluZXIsIHJhbmdlLnN0YXJ0T2Zmc2V0KTtcclxuICAgICAgY29uc3Qgc3RhcnQgPSBwcmVTZWxlY3Rpb25SYW5nZS50b1N0cmluZygpLmxlbmd0aDtcclxuXHJcbiAgICAgIC8qKiBBZGRpbmcgcGx1cyBvbmUgdG8gYWNjb3VudCBmb3IgbmV3bGluZSAqL1xyXG4gICAgICBzZXRTYXZlZFNlbGVjdGlvbih7XHJcbiAgICAgICAgc3RhcnQ6IHN0YXJ0ICsgMSxcclxuICAgICAgICAvKiogQWRkaW5nIHBsdXMgb25lIHRvIGFjY291bnQgZm9yIG5ld2xpbmUgKi9cclxuICAgICAgICBlbmQ6IHN0YXJ0ICsgcmFuZ2UudG9TdHJpbmcoKS5sZW5ndGggKyAxLFxyXG4gICAgICB9KTtcclxuICAgIH0gZWxzZSB7XHJcbiAgICAgIHNldFNhdmVkU2VsZWN0aW9uKHtcclxuICAgICAgICBzdGFydDogMCxcclxuICAgICAgICBlbmQ6IDAsXHJcbiAgICAgIH0pO1xyXG4gICAgfVxyXG4gIH0sIFtdKTtcclxuXHJcbiAgY29uc3QgcmVzdG9yZVNlbGVjdGlvbiA9IHVzZUNhbGxiYWNrKGZ1bmN0aW9uIChjb250YWluZXJFbCwgX3NhdmVkU2VsZWN0aW9uKSB7XHJcbiAgICBsZXQgY2hhckluZGV4ID0gMCwgcmFuZ2UgPSBkb2N1bWVudC5jcmVhdGVSYW5nZSgpO1xyXG4gICAgcmFuZ2Uuc2V0U3RhcnQoY29udGFpbmVyRWwsIDApO1xyXG4gICAgcmFuZ2UuY29sbGFwc2UodHJ1ZSk7XHJcbiAgICBsZXQgbm9kZVN0YWNrID0gW2NvbnRhaW5lckVsXSwgbm9kZSwgZm91bmRTdGFydCA9IGZhbHNlLCBzdG9wID0gZmFsc2U7XHJcblxyXG4gICAgd2hpbGUgKCFzdG9wICYmIChub2RlID0gbm9kZVN0YWNrLnBvcCgpKSkge1xyXG4gICAgICBpZiAobm9kZS5ub2RlVHlwZSA9PSAzKSB7XHJcbiAgICAgICAgY29uc3QgbmV4dENoYXJJbmRleCA9IGNoYXJJbmRleCArIG5vZGUubGVuZ3RoO1xyXG5cclxuICAgICAgICBpZiAoIWZvdW5kU3RhcnQgJiYgX3NhdmVkU2VsZWN0aW9uLnN0YXJ0ID49IGNoYXJJbmRleCAmJiBfc2F2ZWRTZWxlY3Rpb24uc3RhcnQgPD0gbmV4dENoYXJJbmRleCkge1xyXG4gICAgICAgICAgcmFuZ2Uuc2V0U3RhcnQobm9kZSwgX3NhdmVkU2VsZWN0aW9uLnN0YXJ0IC0gY2hhckluZGV4KTtcclxuICAgICAgICAgIGZvdW5kU3RhcnQgPSB0cnVlO1xyXG4gICAgICAgIH1cclxuXHJcbiAgICAgICAgaWYgKGZvdW5kU3RhcnQgJiYgX3NhdmVkU2VsZWN0aW9uLmVuZCA+PSBjaGFySW5kZXggJiYgX3NhdmVkU2VsZWN0aW9uLmVuZCA8PSBuZXh0Q2hhckluZGV4KSB7XHJcbiAgICAgICAgICByYW5nZS5zZXRFbmQobm9kZSwgX3NhdmVkU2VsZWN0aW9uLmVuZCAtIGNoYXJJbmRleCk7XHJcbiAgICAgICAgICBzdG9wID0gdHJ1ZTtcclxuICAgICAgICB9XHJcbiAgICAgICAgY2hhckluZGV4ID0gbmV4dENoYXJJbmRleDtcclxuICAgICAgfSBlbHNlIHtcclxuICAgICAgICBsZXQgaSA9IG5vZGUuY2hpbGROb2Rlcy5sZW5ndGg7XHJcblxyXG4gICAgICAgIHdoaWxlIChpLS0pIHtcclxuICAgICAgICAgIG5vZGVTdGFjay5wdXNoKG5vZGUuY2hpbGROb2Rlc1tpXSk7XHJcbiAgICAgICAgfVxyXG4gICAgICB9XHJcbiAgICB9XHJcblxyXG4gICAgY29uc3Qgc2VsID0gd2luZG93LmdldFNlbGVjdGlvbigpO1xyXG4gICAgc2VsLnJlbW92ZUFsbFJhbmdlcygpO1xyXG4gICAgc2VsLmFkZFJhbmdlKHJhbmdlKTtcclxuICB9LCBbXSk7XHJcblxyXG4gIGNvbnN0IGhhbmRsZVJlc3RvcmUgPSB1c2VDYWxsYmFjaygoZSkgPT57XHJcbiAgICAvKiogT25seSBsaXN0ZW5pbmcgZm9yIG5ld2xpbmUga2V5IGNoYXJhY3RlciBjb2RlICovXHJcbiAgICBpZiAoZS5rZXlDb2RlID09PSAxMykge1xyXG4gICAgICByZXN0b3JlU2VsZWN0aW9uKGVsLCBzYXZlZFNlbGVjdGlvbik7XHJcbiAgICB9XHJcbiAgfSwgW2VsLCByZXN0b3JlU2VsZWN0aW9uLCBzYXZlZFNlbGVjdGlvbl0pO1xyXG5cclxuICBjb25zdCBoYW5kbGVTYXZlU2VsZWN0aW9uID0gdXNlQ2FsbGJhY2soKCkgPT4ge1xyXG4gICAgc2F2ZVNlbGVjdGlvbihlbCk7XHJcbiAgfSwgW2VsLCBzYXZlU2VsZWN0aW9uXSk7XHJcblxyXG4gIHVzZUVmZmVjdCgoKSA9PiB7XHJcbiAgICBpZiAoZWwpIHtcclxuICAgICAgZWwuYWRkRXZlbnRMaXN0ZW5lcigna2V5dXAnLCBoYW5kbGVSZXN0b3JlKTtcclxuICAgICAgZWwuYWRkRXZlbnRMaXN0ZW5lcigna2V5ZG93bicsIGhhbmRsZVNhdmVTZWxlY3Rpb24pO1xyXG4gICAgfTtcclxuICAgIHJldHVybiAoKSA9PiB7XHJcbiAgICAgIGlmIChlbCkge1xyXG4gICAgICAgIGVsLnJlbW92ZUV2ZW50TGlzdGVuZXIoJ2tleXVwJywgaGFuZGxlUmVzdG9yZSk7XHJcbiAgICAgICAgZWwuYWRkRXZlbnRMaXN0ZW5lcigna2V5ZG93bicsIGhhbmRsZVNhdmVTZWxlY3Rpb24pO1xyXG4gICAgICB9XHJcbiAgICB9O1xyXG4gIH0sIFtlbCwgaGFuZGxlUmVzdG9yZSwgaGFuZGxlU2F2ZVNlbGVjdGlvbiwgcmVzdG9yZVNlbGVjdGlvbiwgc2F2ZVNlbGVjdGlvbl0pO1xyXG59XHJcblxyXG5leHBvcnQgZnVuY3Rpb24gdXNlSGFuZGxlVW5kbyhlbCwgaW5pdGlhbFN0YXRlKSB7XHJcbiAgY29uc3QgW2xhc3RWYWx1ZXMsIHNldExhc3RWYWx1ZXNdID0gdXNlU3RhdGUoW2luaXRpYWxTdGF0ZV0pO1xyXG4gIGNvbnN0IGhhbmRsZVVuZG8gPSB1c2VDYWxsYmFjaygoZSkgPT4ge1xyXG4gICAgaWYgKGUubWV0YUtleSAmJiBlLmtleSA9PT0gJ3onICYmIGxhc3RWYWx1ZXMubGVuZ3RoKSB7XHJcbiAgICAgIGUudGFyZ2V0LmlubmVySFRNTCA9IGxhc3RWYWx1ZXMucG9wKCk7XHJcbiAgICB9XHJcblxyXG4gICAgaWYgKCFlLm1ldGFLZXkgfHwgKGUubWV0YUtleSAmJiBlLmtleSA9PT0gJ3YnKSkge1xyXG4gICAgICBjb25zdCBjb3B5ID0gbGFzdFZhbHVlcy5zbGljZSgwKTtcclxuICAgICAgY29weS5wdXNoKGUudGFyZ2V0LmlubmVySFRNTCk7XHJcbiAgICAgIHNldExhc3RWYWx1ZXMoY29weSk7XHJcbiAgICB9XHJcbiAgfSwgW2xhc3RWYWx1ZXNdKTtcclxuXHJcbiAgdXNlRWZmZWN0KCgpID0+IHtcclxuICAgIGlmIChlbCkge1xyXG4gICAgICBlbC5hZGRFdmVudExpc3RlbmVyKCdrZXlkb3duJywgaGFuZGxlVW5kbyk7XHJcbiAgICB9O1xyXG4gICAgcmV0dXJuICgpID0+IHtcclxuICAgICAgaWYgKGVsKSB7XHJcbiAgICAgICAgZWwucmVtb3ZlRXZlbnRMaXN0ZW5lcigna2V5ZG93bicsIGhhbmRsZVVuZG8pO1xyXG4gICAgICB9XHJcbiAgICB9O1xyXG4gIH0sIFtlbCwgaGFuZGxlVW5kb10pO1xyXG59XHJcblxyXG5leHBvcnQgZnVuY3Rpb24gdXNlSGFuZGxlUGFzdGUoZWwsIHByZXZpZXcpIHtcclxuICBjb25zdCBoYW5kbGVQYXN0ZSA9IHVzZUNhbGxiYWNrKChlKSA9PiB7XHJcbiAgICBlLnByZXZlbnREZWZhdWx0KCk7XHJcbiAgICBjb25zdCBwYXN0ZWREYXRhID0gZS5jbGlwYm9hcmREYXRhLmdldERhdGEoJ3RleHQvcGxhaW4nKTtcclxuICAgIGNvbnN0IGRvYyA9IG5ldyBET01QYXJzZXIoKS5wYXJzZUZyb21TdHJpbmcocGFzdGVkRGF0YSwgJ3RleHQvaHRtbCcpO1xyXG4gICAgY29uc3QgdGV4dCA9IGRvYy5ib2R5LnRleHRDb250ZW50IHx8ICcnO1xyXG4gICAgZG9jdW1lbnQuZXhlY0NvbW1hbmQoJ2luc2VydEhUTUwnLCBmYWxzZSwgdGV4dCk7XHJcbiAgfSwgW10pO1xyXG5cclxuICB1c2VFZmZlY3QoKCkgPT4ge1xyXG4gICAgaWYgKGVsKSB7XHJcbiAgICAgIGVsLmFkZEV2ZW50TGlzdGVuZXIoJ3Bhc3RlJywgaGFuZGxlUGFzdGUpO1xyXG4gICAgfTtcclxuICAgIHJldHVybiAoKSA9PiB7XHJcbiAgICAgIGlmIChlbCkge1xyXG4gICAgICAgIGVsLnJlbW92ZUV2ZW50TGlzdGVuZXIoJ3Bhc3RlJywgaGFuZGxlUGFzdGUpO1xyXG4gICAgICB9XHJcbiAgICB9O1xyXG4gIH0sIFtlbCwgaGFuZGxlUGFzdGUsIHByZXZpZXddKTtcclxufSJdfQ==